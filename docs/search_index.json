[["index.html", "AlberdiLab | Martin-Bideguren et al. 2024 Study title to be added Chapter 1 Introduction 1.1 Prepare the R environment", " AlberdiLab | Martin-Bideguren et al. 2024 Study title to be added Garazi Martin-Bideguren1, Ostaizka Aizpurua2, Javier Abalos3, Fabien Aubret4, Guillem Pérez i de Lanuza5, Tom Sarraude6, Nathalie Feiner7, Tobias Uller8, Aoife Leonard9 and Antton Alberdi10 Last update: 2024-12-07 Chapter 1 Introduction This webbook contains all the code used for data analysis in study of the population-level metagenomic data of Podarcis muralis lizards across elevational gradients in various mountain ranges of the Pyrenees. 1.1 Prepare the R environment 1.1.1 Environment To reproduce all the analyses locally, clone this repository in your computer using: RStudio &gt; New Project &gt; Version Control &gt; Git And indicating the following git repository: https://github.com/alberdilab/elevational_hologenomics.git Once the R project has been created, follow the instructions and code chunks shown in this webbook. 1.1.2 Libraries The following R packages are required for the data analysis. # Base library(R.utils) library(knitr) library(tidyverse) library(devtools) library(tinytable) library(broom.mixed) library(rmarkdown) # For tree handling library(ape) library(phyloseq) library(phytools) # For plotting library(ggplot2) library(ggrepel) library(ggpubr) library(ggnewscale) library(gridExtra) library(ggtreeExtra) library(ggtree) library(ggh4x) library(UpSetR) library(mapproj) # For statistics library(spaa) library(vegan) library(Rtsne) library(geiger) library(hilldiv2) library(distillR) library(Hmsc) library(corrplot) University of Copenhagen, garazi.bideguren@sund.ku.dk↩︎ University of Copenhagen, ostaizka.aizpurua@sund.ku.dk↩︎ University of Valencia, jal4@uv.es↩︎ Centre National de la Recherche Scientifique, faubret@gmail.com↩︎ University of Valencia, guillem.perez-lanuza@uv.es↩︎ Centre National de la Recherche Scientifique, t.sarraude@gmail.com↩︎ University of Lund, nathalie.feiner@biol.lu.se↩︎ University of Lund, tobias.uller@biol.lu.se↩︎ Aarhus University, aoife.leonard@sund.ku.dk↩︎ University of Copenhagen, antton.alberdi@sund.ku.dk↩︎ "],["prepare-data.html", "Chapter 2 Prepare data 2.1 Load data 2.2 Create working objects 2.3 Prepare color scheme 2.4 Wrap working objects", " Chapter 2 Prepare data 2.1 Load data Load the original data files outputted by the bioinformatic pipeline. 2.1.1 Sample metadata sample_metadata &lt;- read.csv(&quot;data/Pyrenees_metadata_all_v2.csv&quot;,sep=&quot;,&quot;,header=T)%&gt;% filter(EHI_number != &quot;EHI00102&quot;) %&gt;% filter(EHI_number != &quot;EHI00182&quot;) %&gt;% filter(EHI_number !=&quot;EHI00435&quot;) %&gt;% filter(EHI_number !=&quot;EHI00126&quot;) #genome not P.muralis 2.1.2 Read counts read_counts &lt;- read_tsv(&quot;data/DMB0113_counts.tsv&quot;) %&gt;% rename(genome = 1) %&gt;% select(-EHI00102, -EHI00182,-EHI00435,-EHI00126) #remove samples 2.1.3 Genome taxonomy genome_metadata &lt;- read_tsv(&quot;data/DMB0113_mag_info.tsv&quot;) %&gt;% rename(length=mag_size) 2.1.4 Genome base hits genome_coverage &lt;- read_tsv(&quot;data/DMB0113_coverage.tsv&quot;) %&gt;% rename(genome = 1) %&gt;% select(-EHI00102, -EHI00182,-EHI00435,-EHI00126) %&gt;% #remove samples semi_join(genome_metadata, by = &quot;genome&quot;) 2.1.5 Genome tree genome_tree &lt;- read_tree(&quot;data/DMB0113.tree&quot;) genome_tree$tip.label &lt;- str_replace_all(genome_tree$tip.label,&quot;&#39;&quot;, &quot;&quot;) #remove single quotes in MAG names genome_tree &lt;- keep.tip(genome_tree, tip=genome_metadata$genome) # keep only MAG tips 2.1.6 Genome annotations Distill annotations already into GIFTs genome_gifts_raw=&quot;data/GIFTs.tsv&quot; genome_gifts &lt;- read.table(genome_gifts_raw,header=T, sep=&quot;\\t&quot;, row.names=1) 2.2 Create working objects Transform the original data files into working objects for downstream analyses. 2.2.1 Filter reads by coverage read_counts &lt;- read_counts %&gt;% semi_join(genome_metadata, by = &quot;genome&quot;) min_coverage=0.3 read_counts_filt &lt;- genome_coverage %&gt;% mutate(across(where(is.numeric), ~ ifelse(. &gt; min_coverage, 1, 0))) %&gt;% mutate(across(-1, ~ . * read_counts[[cur_column()]])) 2.2.2 Transform reads into genome counts readlength=150 genome_counts &lt;- read_counts %&gt;% mutate(across(where(is.numeric), ~ . / (genome_metadata$length / readlength) )) readlength=150 genome_counts_filt &lt;- read_counts_filt %&gt;% mutate(across(where(is.numeric), ~ . / (genome_metadata$length / readlength) )) 2.3 Prepare color scheme AlberdiLab projects use unified color schemes developed for the Earth Hologenome Initiative, to facilitate figure interpretation. phylum_colors &lt;- read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;) %&gt;% right_join(genome_metadata, by=join_by(phylum == phylum)) %&gt;% arrange(match(genome, genome_tree$tip.label)) %&gt;% select(phylum, colors) %&gt;% unique() %&gt;% arrange(phylum) %&gt;% pull(colors, name=phylum) 2.4 Wrap working objects All working objects are wrapped into a single Rdata object to facilitate downstream usage. save(sample_metadata, genome_metadata, read_counts, genome_counts, genome_counts_filt, genome_tree, genome_gifts, phylum_colors, file = &quot;data/data.Rdata&quot;) "],["data-summary.html", "Chapter 3 Data summary", " Chapter 3 Data summary load(&quot;data/data.Rdata&quot;) Summary of sampled individuals and analysed faecal samples. #number of samples length(sample_metadata$EHI_number) [1] 105 #number of samples by transect sample_metadata %&gt;% group_by(Transect) %&gt;% summarise(n_samples = length(EHI_number)) %&gt;% tt() .table td.tinytable_css_r9118d0828uierzvboe4, .table th.tinytable_css_r9118d0828uierzvboe4 { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_4bxyjw8scrt6y6yf8eny, .table th.tinytable_css_4bxyjw8scrt6y6yf8eny { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } Transect n_samples Aisa 22 Aran 37 Sentein 19 Tourmalet 27 #number of samples by transect and elevation sample_metadata %&gt;% group_by(Transect, Elevation) %&gt;% summarise(n_samples = length(EHI_number)) %&gt;% tt() .table td.tinytable_css_ruawdz2t0zy0b6pm63vq, .table th.tinytable_css_ruawdz2t0zy0b6pm63vq { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_g5uld6m7e3m9p5t0y9se, .table th.tinytable_css_g5uld6m7e3m9p5t0y9se { border-bottom: solid #d3d8dc 0.1em; } Transect Elevation n_samples Aisa 1250 6 Aisa 1450 6 Aisa 1650 4 Aisa 1850 6 Aran 1000 6 Aran 1080 7 Aran 1340 5 Aran 1500 6 Aran 1650 7 Aran 1850 6 Sentein 941 5 Sentein 1260 4 Sentein 1628 5 Sentein 1873 5 Tourmalet 953 5 Tourmalet 1255 4 Tourmalet 1561 4 Tourmalet 1797 4 Tourmalet 2065 2 Tourmalet 2134 3 Tourmalet 2306 5 #n of analysed faecal samples ncol(read_counts) [1] 106 Geographical location of sampled lizards in the Pyrenees. #Summarise for generating map options(dplyr.summarise.inform = FALSE) sample_metadata_summary &lt;- sample_metadata %&gt;% #Group by geography and count samples select(EHI_number, latitude, longitude, Transect) %&gt;% group_by(latitude, longitude, Transect) %&gt;% summarize(count = n()) %&gt;% ungroup() #plotting on map ## Determine the longitude and latitude ranges lon_range &lt;- range(sample_metadata_summary$longitude, na.rm = TRUE) lat_range &lt;- range(sample_metadata_summary$latitude, na.rm = TRUE) sample_metadata_summary %&gt;% ggplot(.) + #render map geom_map( data=map_data(&quot;world&quot;), map = map_data(&quot;world&quot;), aes(long, lat, map_id=region), color = &quot;white&quot;, fill = &quot;#cccccc&quot;, linewidth = 0.2 ) + #render points geom_point( aes(x=longitude,y=latitude, color=Transect), alpha=0.5, shape=16) + #add general plot layout theme_minimal() + theme(legend.position = &quot;right&quot;, axis.title.x=element_blank(), axis.title.y=element_blank() ) + coord_map(&quot;mercator&quot;, xlim = lon_range, ylim = lat_range) "],["data-statistics.html", "Chapter 4 Data statistics 4.1 Sequencing reads statistics 4.2 Sequencing depth 4.3 DNA fractions 4.4 Recovered microbial fraction", " Chapter 4 Data statistics 4.1 Sequencing reads statistics sample_metadata %&gt;% summarise(Total=sum(reads_post_fastp * 150 / 1000000000) %&gt;% round(2), mean=mean(reads_post_fastp * 150 / 1000000000) %&gt;% round(2), sd=sd(reads_post_fastp * 150 / 1000000000) %&gt;% round(2)) %&gt;% unite(&quot;Average&quot;,mean, sd, sep = &quot; ± &quot;, remove = TRUE) %&gt;% tt() .table td.tinytable_css_p1ge3y2l5z99iz5w7bwy, .table th.tinytable_css_p1ge3y2l5z99iz5w7bwy { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_dxxicl2y0vayxupt9sja, .table th.tinytable_css_dxxicl2y0vayxupt9sja { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } Total Average 652.04 6.21 ± 2.77 4.2 Sequencing depth sequencing_depth &lt;- read_counts %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% colSums() 4.3 DNA fractions sequence_fractions &lt;- read_counts %&gt;% pivot_longer(-genome, names_to = &quot;sample&quot;, values_to = &quot;value&quot;) %&gt;% group_by(sample) %&gt;% summarise(mags = sum(value)) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% select(sample,mags,metagenomic_bases,host_bases,bases_lost_fastp_percent) %&gt;% mutate(mags_bases = mags*146) %&gt;% mutate(lowqual_bases = ((metagenomic_bases+host_bases)/(1-bases_lost_fastp_percent))-(metagenomic_bases+host_bases)) %&gt;% mutate(unmapped_bases = metagenomic_bases - mags_bases) %&gt;% mutate(unmapped_bases = ifelse(unmapped_bases &lt; 0, 0, unmapped_bases)) %&gt;% select(sample, lowqual_bases, host_bases, unmapped_bases, mags_bases) sequence_fractions %&gt;% mutate_at(vars(-sample), ~./1000000000) %&gt;% rename(&quot;Sample&quot;=1, &quot;Low quality&quot;=2, &quot;Mapped to host&quot;=3, &quot;Unmapped&quot;=4, &quot;Mapped to MAGs&quot;=5) %&gt;% tt() .table td.tinytable_css_howl4zzr37aipob2jqes, .table th.tinytable_css_howl4zzr37aipob2jqes { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_btpg9yyb994q7lqd735o, .table th.tinytable_css_btpg9yyb994q7lqd735o { border-bottom: solid #d3d8dc 0.1em; } Sample Low quality Mapped to host Unmapped Mapped to MAGs EHI00069 1.1441521 0.920532571 2.0517957 4.1058263 EHI00070 0.2348919 0.937599880 0.8332809 1.6364476 EHI00072 0.3717090 0.078319449 0.9507999 4.0430716 EHI00073 0.1504762 0.007300164 0.6458066 1.8453666 EHI00074 0.5700275 0.034671349 1.7906564 5.7526051 EHI00075 0.2702205 0.444390387 0.9599202 2.4896265 EHI00076 0.3350547 0.081391903 1.4172925 3.8389468 EHI00077 0.1353495 0.641770627 0.3885242 1.3947384 EHI00079 0.3377906 2.721037061 0.5653554 0.8084465 EHI00080 0.7291964 1.605187153 2.3611523 2.6883254 EHI00081 0.2184180 0.727448090 0.5615342 1.3358755 EHI00085 0.2300087 0.212261834 0.5665817 1.9281604 EHI00086 0.3471176 0.417593612 1.0770869 1.7440344 EHI00088 0.2278663 0.071769210 0.5556301 3.0141044 EHI00089 0.1751910 0.034915171 0.5162821 1.9576155 EHI00091 0.2622745 0.230039482 0.8255133 2.4924602 EHI00092 0.3917724 0.170842450 1.0255541 4.9181624 EHI00093 0.3725739 0.199633318 1.1938025 2.3137473 EHI00095 0.1768550 0.255990148 0.3449738 1.9242079 EHI00097 0.5249214 0.366551383 0.8028468 2.9685729 EHI00098 0.3176395 0.040047629 1.7271586 3.1498120 EHI00100 0.4386907 2.398470758 0.8228622 4.1093643 EHI00101 0.7257361 0.451928365 4.9291736 1.9943098 EHI00103 0.2036111 0.843529516 0.5714195 1.3395113 EHI00104 0.1769983 0.643701669 0.6807099 1.2574891 EHI00105 0.2711051 0.005694785 0.9087805 2.7311372 EHI00106 1.1082626 1.058626752 1.8709694 2.0746217 EHI00107 0.3818355 0.184257358 1.5836979 3.0592637 EHI00108 0.3420046 0.394171066 0.5356632 2.7441687 EHI00110 0.3648881 0.591747269 0.5588077 2.6145261 EHI00111 0.4392502 0.151954279 1.1992388 3.5773008 EHI00112 0.7134927 0.085183185 1.1328903 3.6469985 EHI00113 0.8620893 0.617092903 1.4939464 7.3254896 EHI00114 0.4127445 0.087174427 2.3985081 4.6641659 EHI00115 0.6290438 0.062352261 2.6081814 3.0085937 EHI00116 0.4130247 0.039596686 0.8559983 4.7270478 EHI00117 0.6850197 0.423816725 1.2454024 7.0782364 EHI00118 0.3963952 0.784391517 0.9049477 3.7006953 EHI00119 0.4448016 0.038727564 1.5277021 4.6761692 EHI00120 0.3549466 0.051038023 0.7165254 3.8122875 EHI00121 0.2487524 1.196143747 0.9172490 1.9448859 EHI00122 0.3967333 0.056247498 1.7140526 5.3880487 EHI00124 0.3101617 0.113171041 1.6986936 3.2732918 EHI00125 0.3008464 0.313488992 1.2381544 3.1620784 EHI00128 0.3688688 0.149336152 1.0558709 2.9648899 EHI00129 0.2827708 0.212726094 0.7352845 2.7738704 EHI00130 0.2917071 0.082344877 1.0170695 2.1151693 EHI00131 0.1940832 0.943415382 0.4863996 1.2048589 EHI00133 0.2569782 0.429506925 0.3484713 3.3747982 EHI00134 0.5620395 1.988142143 1.9520876 3.9427347 EHI00137 0.2948339 0.250489910 1.0341318 2.4844583 EHI00138 0.2673241 0.179238573 0.5826993 2.8578460 EHI00139 0.3001940 0.034225947 0.9413847 2.1426906 EHI00176 0.7041777 0.100761385 0.7196926 2.7465205 EHI00177 0.2555111 0.016053624 0.5228890 2.1639513 EHI00178 0.2415179 0.045338274 1.3634101 2.6038297 EHI00179 0.1816121 0.023148016 0.9401620 2.3926575 EHI00180 0.5363481 0.037200326 0.7786810 2.4699635 EHI00181 0.1978972 0.301399301 0.4733087 2.4456488 EHI00422 0.1660426 0.058188268 0.4631427 2.3301737 EHI00426 0.6048076 0.374841259 1.6091057 5.6754435 EHI00428 0.4361908 0.354862015 0.9866519 3.7380622 EHI00433 0.6941201 0.730117194 1.6017157 3.7066518 EHI00438 0.2938182 0.100587490 0.8490354 4.7546269 EHI00441 0.5217550 0.202212815 2.3199030 6.8309541 EHI00451 0.4696437 0.318898071 1.2315115 5.0794188 EHI00456 0.5747753 0.097152439 0.6337192 4.7496272 EHI00458 0.5541280 0.326249839 1.7364884 4.9185106 EHI00462 0.5139086 0.330809687 1.3870295 4.8485639 EHI00464 0.5604449 0.962080506 1.5487451 5.0533364 EHI00465 0.1355889 0.041795770 0.7088416 1.4262076 EHI00467 0.4291035 0.854761759 1.6444666 3.7590494 EHI00470 0.6625583 1.679223689 1.8675738 8.1840405 EHI00472 0.3619652 0.586418138 1.8074071 3.3732380 EHI00473 0.4841385 0.477433785 1.2481742 4.8043613 EHI00477 0.4782444 0.087653441 2.7186490 3.7317223 EHI00479 0.8395454 0.074374376 1.9936025 12.8156007 EHI00480 0.7475415 0.793212202 3.1481051 4.3553735 EHI00481 0.5040521 0.094726409 1.3739735 5.3792865 EHI00483 0.4545170 1.532171008 0.8653232 4.7402692 EHI00484 0.3037426 0.269250378 1.3870200 5.2563238 EHI00488 0.4900356 2.212642337 2.0850126 4.3632065 EHI00490 0.6234248 0.180662818 3.5993286 7.8297890 EHI00493 0.4026458 2.030328521 2.7098633 2.4780854 EHI00496 0.4536382 0.415085470 1.7045368 6.1699650 EHI00499 3.5142773 2.204637514 3.4291586 3.2083353 EHI00504 0.5335873 2.167943278 1.2709452 4.9663386 EHI00506 0.7953759 0.639271744 1.7418071 8.0883653 EHI00507 0.4077748 0.136492692 1.5474048 5.5083429 EHI00512 0.6299478 8.067540048 0.5964127 1.3433168 EHI00514 0.4590217 0.336676348 1.5023882 6.2571308 EHI00518 0.4082296 0.012341521 1.0122951 5.8379043 EHI00524 0.4918121 1.320091255 2.0577845 4.8996823 EHI00525 0.3238390 0.105964164 1.1420157 5.0531429 EHI00527 0.5623443 0.128178226 2.3107744 7.6106934 EHI00529 0.3350620 0.129930230 1.3102065 5.1130080 EHI00536 0.4725239 0.010876654 1.2534820 7.7176039 EHI00537 0.3665586 0.089579032 2.4631156 1.4492223 EHI00538 0.4501201 2.638414328 0.6397030 3.1637601 EHI00541 0.7086242 0.152318595 1.4153324 6.8350770 EHI00547 1.0225445 2.648359289 7.0526142 6.1760904 EHI00566 0.5706734 0.218664855 1.7237625 7.3779017 EHI00567 0.4565067 0.133011864 1.9051503 4.4466414 EHI00568 0.5246686 0.219110833 1.7989251 3.5919103 EHI00569 0.6859077 0.169999886 2.6761990 6.7957645 sequence_fractions %&gt;% pivot_longer(!sample, names_to = &quot;fraction&quot;, values_to = &quot;value&quot;) %&gt;% mutate(value = value / 1000000000) %&gt;% mutate(fraction = factor(fraction, levels = c(&quot;lowqual_bases&quot;,&quot;host_bases&quot;,&quot;unmapped_bases&quot;,&quot;mags_bases&quot;))) %&gt;% ggplot(., aes(x = sample, y = value, fill=fraction)) + geom_bar(position=&quot;stack&quot;, stat = &quot;identity&quot;) + scale_fill_manual(name=&quot;Sequence type&quot;, breaks=c(&quot;lowqual_bases&quot;,&quot;host_bases&quot;,&quot;unmapped_bases&quot;,&quot;mags_bases&quot;), labels=c(&quot;Low quality&quot;,&quot;Mapped to host&quot;,&quot;Unmapped&quot;,&quot;Mapped to MAGs&quot;), values=c(&quot;#CCCCCC&quot;, &quot;#bcdee1&quot;, &quot;#d8b8a3&quot;,&quot;#93655c&quot;))+ labs(x = &quot;Samples&quot;, y = &quot;Amount of data (GB)&quot;) + theme_classic() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size=6),legend.position = &quot;bottom&quot;) 4.4 Recovered microbial fraction singlem_table &lt;- sequence_fractions %&gt;% mutate(mags_proportion = round((mags_bases / (mags_bases + unmapped_bases))*100,2)) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% mutate(singlem_proportion = round(singlem_fraction*100,2)) %&gt;% select(sample,mags_proportion,singlem_proportion) %&gt;% mutate(mags_proportion = ifelse(singlem_proportion == 0, 0, mags_proportion)) %&gt;% #convert zeros to NA mutate(singlem_proportion = ifelse(singlem_proportion == 0, NA, singlem_proportion)) %&gt;% #convert zeros to NA mutate(singlem_proportion = ifelse(singlem_proportion &lt; mags_proportion, NA, singlem_proportion)) %&gt;% #if singlem is smaller, then NA, to simplify plot mutate(singlem_proportion = ifelse(singlem_proportion &gt; 100, 100, singlem_proportion)) #simplify singlem_table %&gt;% pivot_longer(!sample, names_to = &quot;proportion&quot;, values_to = &quot;value&quot;) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% mutate(proportion = factor(proportion, levels = c(&quot;mags_proportion&quot;,&quot;singlem_proportion&quot;))) %&gt;% ggplot(., aes(x = value, y = sample, color=proportion)) + geom_line(aes(group = sample), color = &quot;#f8a538&quot;) + geom_point() + scale_color_manual(name=&quot;Proportion&quot;, breaks=c(&quot;mags_proportion&quot;,&quot;singlem_proportion&quot;), labels=c(&quot;Recovered&quot;,&quot;Estimated&quot;), values=c(&quot;#52e1e8&quot;, &quot;#876b53&quot;))+ facet_nested(species + sample_type ~ ., scales=&quot;free&quot;,space=&quot;free&quot;)+ theme_classic() + labs(y = &quot;Samples&quot;, x = &quot;Prokaryotic fraction (%)&quot;) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size=6), legend.position = &quot;right&quot;, strip.background.y=element_rect(color = NA, fill= &quot;#f4f4f4&quot;)) "],["mag-catalogue.html", "Chapter 5 MAG catalogue 5.1 Genome phylogeny 5.2 Genome quality 5.3 Functional overview 5.4 Functional ordination 5.5 MAGs shared across transects", " Chapter 5 MAG catalogue load(&quot;data/data.Rdata&quot;) 5.1 Genome phylogeny # Generate the phylum color heatmap phylum_heatmap &lt;- read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;) %&gt;% mutate(phylum=str_remove_all(phylum, &quot;p__&quot;)) %&gt;% right_join(genome_metadata, by=join_by(phylum == phylum)) %&gt;% arrange(match(genome, genome_tree$tip.label)) %&gt;% dplyr::select(genome,phylum) %&gt;% mutate(phylum = factor(phylum, levels = unique(phylum))) %&gt;% column_to_rownames(var = &quot;genome&quot;) # Generate Aisa heatmap aisa_heatmap &lt;- genome_counts_filt %&gt;% pivot_longer(!genome,names_to=&quot;sample&quot;,values_to=&quot;abundance&quot;) %&gt;% left_join(sample_metadata,by = join_by(sample == EHI_number)) %&gt;% filter(Transect==&quot;Aisa&quot;) %&gt;% group_by(genome) %&gt;% summarise(presence=ifelse(sum(abundance)&gt;0,&quot;present&quot;,&quot;absent&quot;)) %&gt;% column_to_rownames(var=&quot;genome&quot;) # Generate Aran heatmap aran_heatmap &lt;- genome_counts_filt %&gt;% pivot_longer(!genome,names_to=&quot;sample&quot;,values_to=&quot;abundance&quot;) %&gt;% left_join(sample_metadata,by = join_by(sample == EHI_number)) %&gt;% filter(Transect==&quot;Aran&quot;) %&gt;% group_by(genome) %&gt;% summarise(presence=ifelse(sum(abundance)&gt;0,&quot;present&quot;,&quot;absent&quot;)) %&gt;% column_to_rownames(var=&quot;genome&quot;) # Generate Sentein heatmap sentein_heatmap &lt;- genome_counts_filt %&gt;% pivot_longer(!genome,names_to=&quot;sample&quot;,values_to=&quot;abundance&quot;) %&gt;% left_join(sample_metadata,by = join_by(sample == EHI_number)) %&gt;% filter(Transect==&quot;Sentein&quot;) %&gt;% group_by(genome) %&gt;% summarise(presence=ifelse(sum(abundance)&gt;0,&quot;present&quot;,&quot;absent&quot;)) %&gt;% column_to_rownames(var=&quot;genome&quot;) # Generate Tourmalet heatmap tourmalet_heatmap &lt;- genome_counts_filt %&gt;% pivot_longer(!genome,names_to=&quot;sample&quot;,values_to=&quot;abundance&quot;) %&gt;% left_join(sample_metadata,by = join_by(sample == EHI_number)) %&gt;% filter(Transect==&quot;Tourmalet&quot;) %&gt;% group_by(genome) %&gt;% summarise(presence=ifelse(sum(abundance)&gt;0,&quot;present&quot;,&quot;absent&quot;)) %&gt;% column_to_rownames(var=&quot;genome&quot;) # Generate prevalence data prevalence_data &lt;- genome_counts_filt %&gt;% pivot_longer(!genome,names_to=&quot;sample&quot;,values_to=&quot;abundance&quot;) %&gt;% left_join(sample_metadata,by = join_by(sample == EHI_number)) %&gt;% group_by(genome,Transect) %&gt;% summarise(presence=ifelse(sum(abundance)&gt;0,1,0)) %&gt;% group_by(genome) %&gt;% summarise(prevalence=sum(presence)) # Generate basal tree circular_tree &lt;- force.ultrametric(genome_tree, method=&quot;extend&quot;) %&gt;% # extend to ultrametric for the sake of visualisation ggtree(., layout=&quot;fan&quot;, open.angle=10, size=0.5) *************************************************************** * Note: * * force.ultrametric does not include a formal method to * * ultrametricize a tree &amp; should only be used to coerce * * a phylogeny that fails is.ultrametric due to rounding -- * * not as a substitute for formal rate-smoothing methods. * *************************************************************** # Add phylum ring circular_tree &lt;- gheatmap(circular_tree, phylum_heatmap, offset=0, width=0.05, colnames=FALSE) + scale_fill_manual(values=phylum_colors) + theme(legend.position = &quot;none&quot;, plot.margin = margin(0, 0, 0, 0), panel.margin = margin(0, 0, 0, 0)) + new_scale_fill() # Add Aisa ring circular_tree &lt;- gheatmap(circular_tree, aisa_heatmap, offset=0.2, width=0.05, colnames=FALSE) + scale_fill_manual(values=c(&quot;#ffffff&quot;,&quot;#e5bd5b&quot;)) + theme(legend.position = &quot;none&quot;, plot.margin = margin(0, 0, 0, 0), panel.margin = margin(0, 0, 0, 0)) + new_scale_fill() # Add Aran ring circular_tree &lt;- gheatmap(circular_tree, aran_heatmap, offset=0.3, width=0.05, colnames=FALSE) + scale_fill_manual(values=c(&quot;#ffffff&quot;,&quot;#6b7398&quot;)) + theme(legend.position = &quot;none&quot;, plot.margin = margin(0, 0, 0, 0), panel.margin = margin(0, 0, 0, 0)) + new_scale_fill() # Add Sentein Verde ring circular_tree &lt;- gheatmap(circular_tree, sentein_heatmap, offset=0.4, width=0.05, colnames=FALSE) + scale_fill_manual(values=c(&quot;#ffffff&quot;,&quot;#e2815a&quot;)) + theme(legend.position = &quot;none&quot;, plot.margin = margin(0, 0, 0, 0), panel.margin = margin(0, 0, 0, 0)) + new_scale_fill() # Add Tourmalet ring circular_tree &lt;- gheatmap(circular_tree, tourmalet_heatmap, offset=0.5, width=0.05, colnames=FALSE) + scale_fill_manual(values=c(&quot;#ffffff&quot;,&quot;#876b96&quot;)) + theme(legend.position = &quot;none&quot;, plot.margin = margin(0, 0, 0, 0), panel.margin = margin(0, 0, 0, 0)) + new_scale_fill() # Add prevalence ring circular_tree &lt;- circular_tree + new_scale_fill() + scale_fill_manual(values = &quot;#cccccc&quot;) + geom_fruit( data=prevalence_data, geom=geom_bar, mapping = aes(x=prevalence, y=genome), offset = 0.4, orientation=&quot;y&quot;, stat=&quot;identity&quot;) # Flush color scale to enable a new color scheme in the next ring circular_tree &lt;- circular_tree + new_scale_fill() # Add completeness ring circular_tree &lt;- circular_tree + new_scale_fill() + scale_fill_gradient(low = &quot;#d1f4ba&quot;, high = &quot;#f4baba&quot;) + geom_fruit( data=genome_metadata, geom=geom_bar, mapping = aes(x=completeness, y=genome, fill=contamination), offset = 0.55, orientation=&quot;y&quot;, stat=&quot;identity&quot;) # Add genome-size ring circular_tree &lt;- circular_tree + new_scale_fill() + scale_fill_manual(values = &quot;#cccccc&quot;) + geom_fruit( data=genome_metadata, geom=geom_bar, mapping = aes(x=length, y=genome), offset = 0.05, orientation=&quot;y&quot;, stat=&quot;identity&quot;) # Add text circular_tree &lt;- circular_tree + annotate(&#39;text&#39;, x=3.4, y=0, label=&#39; Phylum&#39;, family=&#39;arial&#39;, size=3.5) + annotate(&#39;text&#39;, x=4.3, y=0, label=&#39; Genome quality&#39;, family=&#39;arial&#39;,size=3.5)+ annotate(&#39;text&#39;, x=4.8, y=0, label=&#39; Genome size&#39;, family=&#39;arial&#39;, size=3.5) #Plot circular tree circular_tree %&gt;% open_tree(30) %&gt;% rotate_tree(90) 5.2 Genome quality genome_metadata %&gt;% summarise(completeness_mean=mean(completeness) %&gt;% round(2) %&gt;% as.character(), completeness_sd=sd(completeness) %&gt;% round(2) %&gt;% as.character(), contamination_mean=mean(contamination) %&gt;% round(2), contamination_sd=sd(contamination) %&gt;% round(2)) %&gt;% unite(&quot;Completeness&quot;,completeness_mean, completeness_sd, sep = &quot; ± &quot;, remove = TRUE) %&gt;% unite(&quot;Contamination&quot;,contamination_mean, contamination_sd, sep = &quot; ± &quot;, remove = TRUE) %&gt;% tt() .table td.tinytable_css_ui86mlmh7nfzak70rxuz, .table th.tinytable_css_ui86mlmh7nfzak70rxuz { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_8qvno4l8z7nl3cxe63b3, .table th.tinytable_css_8qvno4l8z7nl3cxe63b3 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } Completeness Contamination 79.99 ± 15.48 2.19 ± 1.94 #Generate quality biplot genome_biplot &lt;- genome_metadata %&gt;% select(c(genome,domain,phylum,completeness,contamination,length)) %&gt;% arrange(match(genome, rev(genome_tree$tip.label))) %&gt;% #sort MAGs according to phylogenetic tree ggplot(aes(x=completeness,y=contamination,size=length,color=phylum)) + geom_point(alpha=0.7) + ylim(c(10,0)) + scale_color_manual(values=phylum_colors) + labs(y= &quot;Contamination&quot;, x = &quot;Completeness&quot;) + theme_classic() + theme(legend.position = &quot;none&quot;) #Generate contamination boxplot genome_contamination &lt;- genome_metadata %&gt;% ggplot(aes(y=contamination)) + ylim(c(10,0)) + geom_boxplot(colour = &quot;#999999&quot;, fill=&quot;#cccccc&quot;) + theme_void() + theme(legend.position = &quot;none&quot;, axis.title.x = element_blank(), axis.title.y = element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(), plot.margin = unit(c(0, 0, 0.40, 0),&quot;inches&quot;)) #add bottom-margin (top, right, bottom, left) #Generate completeness boxplot genome_completeness &lt;- genome_metadata %&gt;% ggplot(aes(x=completeness)) + xlim(c(50,100)) + geom_boxplot(colour = &quot;#999999&quot;, fill=&quot;#cccccc&quot;) + theme_void() + theme(legend.position = &quot;none&quot;, axis.title.x = element_blank(), axis.title.y = element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(), plot.margin = unit(c(0, 0, 0, 0.50),&quot;inches&quot;)) #add left-margin (top, right, bottom, left) #Render composite figure grid.arrange(grobs = list(genome_completeness,genome_biplot,genome_contamination), layout_matrix = rbind(c(1,1,1,1,1,1,1,1,1,1,1,4), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3), c(2,2,2,2,2,2,2,2,2,2,2,3))) 5.3 Functional overview # Aggregate basal GIFT into elements function_table &lt;- genome_gifts %&gt;% to.elements(., GIFT_db) # Generate basal tree function_tree &lt;- force.ultrametric(genome_tree, method=&quot;extend&quot;) %&gt;% ggtree(., size = 0.3) *************************************************************** * Note: * * force.ultrametric does not include a formal method to * * ultrametricize a tree &amp; should only be used to coerce * * a phylogeny that fails is.ultrametric due to rounding -- * * not as a substitute for formal rate-smoothing methods. * *************************************************************** #Add phylum colors next to the tree tips function_tree &lt;- gheatmap(function_tree, phylum_heatmap, offset=0, width=0.1, colnames=FALSE) + scale_fill_manual(values=phylum_colors) + labs(fill=&quot;Phylum&quot;) #Reset fill scale to use a different colour profile in the heatmap function_tree &lt;- function_tree + new_scale_fill() #Add functions heatmap function_tree &lt;- gheatmap(function_tree, function_table, offset=0.5, width=3.5, colnames=FALSE) + vexpand(.08) + coord_cartesian(clip = &quot;off&quot;) + scale_fill_gradient(low = &quot;#f4f4f4&quot;, high = &quot;steelblue&quot;, na.value=&quot;white&quot;) + labs(fill=&quot;GIFT&quot;) #Reset fill scale to use a different colour profile in the heatmap function_tree &lt;- function_tree + new_scale_fill() # Add completeness barplots function_tree &lt;- function_tree + geom_fruit(data=genome_metadata, geom=geom_bar, grid.params=list(axis=&quot;x&quot;, text.size=2, nbreak = 1), axis.params=list(vline=TRUE), mapping = aes(x=length, y=genome, fill=completeness), offset = 3.8, orientation=&quot;y&quot;, stat=&quot;identity&quot;) + scale_fill_gradient(low = &quot;#cf8888&quot;, high = &quot;#a2cc87&quot;) + labs(fill=&quot;Genome\\ncompleteness&quot;) function_tree 5.4 Functional ordination # Generate the tSNE ordination tSNE_function &lt;- Rtsne(X=function_table, dims = 2, check_duplicates = FALSE) # Plot the ordination function_ordination &lt;- tSNE_function$Y %&gt;% as.data.frame() %&gt;% mutate(genome=rownames(function_table)) %&gt;% inner_join(genome_metadata, by=&quot;genome&quot;) %&gt;% rename(tSNE1=&quot;V1&quot;, tSNE2=&quot;V2&quot;) %&gt;% select(genome,phylum,tSNE1,tSNE2, length) %&gt;% ggplot(aes(x = tSNE1, y = tSNE2, color = phylum, size=length))+ geom_point(shape=16, alpha=0.7) + scale_color_manual(values=phylum_colors) + theme_minimal() + labs(color=&quot;Phylum&quot;, size=&quot;Genome size&quot;) + guides(color = guide_legend(override.aes = list(size = 5))) # enlarge Phylum dots in legend function_ordination 5.5 MAGs shared across transects genome_counts_rel &lt;- genome_counts_filt %&gt;% mutate_at(vars(-genome),~./sum(.)) %&gt;% column_to_rownames(., &quot;genome&quot;) genome_counts_rel_pa=1*(genome_counts_rel&gt;0) table_upset_analysis_cont=t(aggregate(t(genome_counts_rel_pa),by=list(sample_metadata$Transect),FUN=sum)[,-1]) colnames(table_upset_analysis_cont)=levels(as.factor(sample_metadata$Transect)) table_upset_analysis=(table_upset_analysis_cont&gt;0)*1 table_upset_analysis=data.frame(table_upset_analysis) table_upset_analysis=apply(table_upset_analysis,2,as.integer) rownames(table_upset_analysis) &lt;- rownames(genome_counts_rel_pa) locationcolors=c(&quot;#e5bd5b&quot;, &quot;#6b7398&quot;,&quot;#e2815a&quot;, &quot;#876b96&quot;) upset(as.data.frame(table_upset_analysis), keep.order = T, sets = rev(c(&quot;Aisa&quot;,&quot;Aran&quot;,&quot;Sentein&quot;,&quot;Tourmalet&quot;)), sets.bar.color= rev(locationcolors), mb.ratio = c(0.55, 0.45), order.by = &quot;freq&quot;) "],["community-composition.html", "Chapter 6 Community composition 6.1 Taxonomy overview 6.2 Taxonomy boxplot", " Chapter 6 Community composition load(&quot;data/data.Rdata&quot;) 6.1 Taxonomy overview 6.1.1 Stacked barplot genome_counts_filt_met&lt;-genome_counts_filt %&gt;% mutate_at(vars(-genome),~./sum(.)) %&gt;% #apply TSS normalisation pivot_longer(-genome, names_to = &quot;sample&quot;, values_to = &quot;count&quot;) %&gt;% #reduce to minimum number of columns left_join(., genome_metadata, by = join_by(genome == genome)) %&gt;% #append genome metadata left_join(., sample_metadata, by = join_by(sample == EHI_number)) %&gt;% #append sample metadata filter(count &gt; 0) #filter 0 counts genome_counts_filt_met$Elevation&lt;-as.factor(genome_counts_filt_met$Elevation) # Create an interaction variable for elevation and sample genome_counts_filt_met$interaction_var &lt;- interaction(genome_counts_filt_met$sample, genome_counts_filt_met$Elevation) # Plot stacked barplot ggplot(genome_counts_filt_met, aes(x=interaction_var,y=count,fill=phylum, group=phylum))+ #grouping enables keeping the same sorting of taxonomic units geom_bar(stat=&quot;identity&quot;, colour=&quot;white&quot;, linewidth=0.1)+ #plot stacked bars with white borders scale_fill_manual(values=phylum_colors) + labs(y = &quot;Relative abundance&quot;, x=&quot;Elevation (m)&quot;) + guides(fill = guide_legend(ncol = 3)) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), panel.background = element_blank(), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(linewidth = 0.5, linetype = &quot;solid&quot;, colour = &quot;black&quot;), legend.position = &quot;none&quot;, legend.title = element_blank(), legend.text = element_text(size=7)) + facet_nested(.~Transect+Elevation, scales = &quot;free&quot;) 6.1.1.1 Number of bacteria phyla [1] 16 6.1.1.2 Bacteria phyla in Aisa transect phylum_summary_aisa &lt;- genome_counts_filt %&gt;% mutate_at(vars(-genome),~./sum(.)) %&gt;% #apply TSS normalisation pivot_longer(-genome, names_to = &quot;sample&quot;, values_to = &quot;count&quot;) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% left_join(genome_metadata, by = join_by(genome == genome)) %&gt;% group_by(sample,phylum) %&gt;% summarise(relabun=sum(count)) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% filter(Transect==&quot;Aisa&quot;)%&gt;% filter(relabun &gt; 0) # Number of bacterial phyla Aisa length(unique(phylum_summary_aisa$phylum)) [1] 13 # Bacteria phyla phylum_summary_aisa %&gt;% group_by(phylum) %&gt;% summarise(total_mean=mean(relabun*100, na.rm=TRUE), total_sd=sd(relabun*100, na.rm=TRUE)) %&gt;% mutate(total=str_c(round(total_mean,2),&quot;±&quot;,round(total_sd,2))) %&gt;% arrange(-total_mean) %&gt;% dplyr::select(phylum,total) %&gt;% tt() .table td.tinytable_css_z8ypmrk1212jurmgjrgu, .table th.tinytable_css_z8ypmrk1212jurmgjrgu { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_tu6u0tddfleqkfwn3rwo, .table th.tinytable_css_tu6u0tddfleqkfwn3rwo { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } phylum total p__Bacillota_A 42.18±15.99 p__Bacteroidota 39.09±17.57 p__Pseudomonadota 5.27±6.75 p__Bacillota 3.99±3.67 p__Verrucomicrobiota 3.53±3.26 p__Campylobacterota 3.29±3.44 p__Desulfobacterota 2.48±1.93 p__Fusobacteriota 1.35±1.33 p__Bacillota_C 1.29±1.53 p__Cyanobacteriota 0.82±0.49 p__Chlamydiota 0.7±0.63 p__Bacillota_B 0.53±0.41 p__Actinomycetota 0.18±0.09 6.1.1.3 Bacteria phyla in Aran transect phylum_summary_aran &lt;- genome_counts_filt %&gt;% mutate_at(vars(-genome),~./sum(.)) %&gt;% #apply TSS normalisation pivot_longer(-genome, names_to = &quot;sample&quot;, values_to = &quot;count&quot;) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% left_join(genome_metadata, by = join_by(genome == genome)) %&gt;% group_by(sample,phylum) %&gt;% summarise(relabun=sum(count)) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% filter(Transect==&quot;Aran&quot;)%&gt;% filter(relabun &gt; 0) # Number of bacterial phyla Aran length(unique(phylum_summary_aran$phylum)) [1] 14 # Bacteria phyla phylum_summary_aran %&gt;% group_by(phylum) %&gt;% summarise(total_mean=mean(relabun*100, na.rm=TRUE), total_sd=sd(relabun*100, na.rm=TRUE)) %&gt;% mutate(total=str_c(round(total_mean,2),&quot;±&quot;,round(total_sd,2))) %&gt;% arrange(-total_mean) %&gt;% dplyr::select(phylum,total) %&gt;% tt() .table td.tinytable_css_t0tpwdl7nw3ng9v3rq88, .table th.tinytable_css_t0tpwdl7nw3ng9v3rq88 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_0fukufwo79p45e36grq3, .table th.tinytable_css_0fukufwo79p45e36grq3 { border-bottom: solid #d3d8dc 0.1em; } phylum total p__Bacillota_A 41.7±16.74 p__Bacteroidota 36.85±14.71 p__Pseudomonadota 7.27±11.02 p__Campylobacterota 5.5±8.27 p__Bacillota 4.64±5.26 p__Fusobacteriota 4.01±8.68 p__Desulfobacterota 2.75±2.22 p__Verrucomicrobiota 2.38±3.15 p__Spirochaetota 1.22±1.19 p__Bacillota_C 1.14±1.18 p__Cyanobacteriota 0.72±0.54 p__Deferribacterota NA p__Bacillota_B 0.44±0.45 p__Actinomycetota 0.3±0.26 6.1.1.4 Bacteria phyla in Sentein transect phylum_summary_sentein &lt;- genome_counts_filt %&gt;% mutate_at(vars(-genome),~./sum(.)) %&gt;% #apply TSS normalisation pivot_longer(-genome, names_to = &quot;sample&quot;, values_to = &quot;count&quot;) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% left_join(genome_metadata, by = join_by(genome == genome)) %&gt;% group_by(sample,phylum) %&gt;% summarise(relabun=sum(count)) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% filter(Transect==&quot;Sentein&quot;)%&gt;% filter(relabun &gt; 0.) # Number of bacterial phyla Sentein length(unique(phylum_summary_sentein$phylum)) [1] 15 # Bacteria phyla phylum_summary_sentein %&gt;% group_by(phylum) %&gt;% summarise(total_mean=mean(relabun*100, na.rm=TRUE), total_sd=sd(relabun*100, na.rm=TRUE)) %&gt;% mutate(total=str_c(round(total_mean,2),&quot;±&quot;,round(total_sd,2))) %&gt;% arrange(-total_mean) %&gt;% dplyr::select(phylum,total) %&gt;% tt() .table td.tinytable_css_9w4hf1te0w6hk6pw5iht, .table th.tinytable_css_9w4hf1te0w6hk6pw5iht { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_7zc4ip1q2wcmdolta321, .table th.tinytable_css_7zc4ip1q2wcmdolta321 { border-bottom: solid #d3d8dc 0.1em; } phylum total p__Bacteroidota 40.72±14.71 p__Bacillota_A 34.82±14.88 p__Bacillota 6.17±10.94 p__Pseudomonadota 5.19±5.3 p__Campylobacterota 4.8±5.42 p__Desulfobacterota 4.77±8.22 p__Spirochaetota 4.76±5.8 p__Chlamydiota 3.19±3.26 p__Fusobacteriota 2.17±5.62 p__Verrucomicrobiota 1.34±1.49 p__Cyanobacteriota 0.78±0.37 p__Actinomycetota 0.77±1.29 p__Bacillota_C 0.61±0.51 p__Bacillota_B 0.16±0.07 p__Deferribacterota NA 6.1.1.5 Bacteria phyla in Tourmalet transect phylum_summary_tourmalet &lt;- genome_counts_filt %&gt;% mutate_at(vars(-genome),~./sum(.)) %&gt;% #apply TSS normalisation pivot_longer(-genome, names_to = &quot;sample&quot;, values_to = &quot;count&quot;) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% left_join(genome_metadata, by = join_by(genome == genome)) %&gt;% group_by(sample,phylum) %&gt;% summarise(relabun=sum(count)) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% filter(Transect==&quot;Tourmalet&quot;) # Number of bacterial phyla Tourmalet length(unique(phylum_summary_tourmalet$phylum)) [1] 16 # Bacteria phyla phylum_summary_tourmalet %&gt;% group_by(phylum) %&gt;% summarise(total_mean=mean(relabun*100, na.rm=TRUE), total_sd=sd(relabun*100, na.rm=TRUE)) %&gt;% mutate(total=str_c(round(total_mean,2),&quot;±&quot;,round(total_sd,2))) %&gt;% arrange(-total_mean) %&gt;% dplyr::select(phylum,total) %&gt;% tt() .table td.tinytable_css_q6vszsdvisrdqxgbg51m, .table th.tinytable_css_q6vszsdvisrdqxgbg51m { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_0xlhfid2jl13j6wzcgf6, .table th.tinytable_css_0xlhfid2jl13j6wzcgf6 { border-bottom: solid #d3d8dc 0.1em; } phylum total p__Bacillota_A 41.87±15.42 p__Bacteroidota 39.29±15.9 p__Bacillota 5.87±5.94 p__Pseudomonadota 5.3±5.15 p__Campylobacterota 2.32±2.71 p__Desulfobacterota 1.58±2.02 p__Verrucomicrobiota 0.94±1.13 p__Bacillota_C 0.83±0.53 p__Cyanobacteriota 0.53±0.82 p__Fusobacteriota 0.4±0.81 p__Actinomycetota 0.39±0.73 p__Spirochaetota 0.23±0.51 p__Deferribacterota 0.16±0.51 p__Bacillota_B 0.16±0.23 p__Chlamydiota 0.11±0.53 p__Synergistota 0.03±0.16 6.1.2 Phylum relative abundances phylum_summary &lt;- genome_counts_filt %&gt;% mutate_at(vars(-genome),~./sum(.)) %&gt;% #apply TSS normalisation pivot_longer(-genome, names_to = &quot;sample&quot;, values_to = &quot;count&quot;) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% left_join(genome_metadata, by = join_by(genome == genome)) %&gt;% group_by(sample,phylum) %&gt;% summarise(relabun=sum(count)) phylum_summary %&gt;% group_by(phylum) %&gt;% summarise(total_mean=mean(relabun*100, na.rm=T), total_sd=sd(relabun*100, na.rm=T)) %&gt;% mutate(total=str_c(round(total_mean,2),&quot;±&quot;,round(total_sd,2))) %&gt;% arrange(-total_mean) %&gt;% dplyr::select(phylum,total) %&gt;% tt() .table td.tinytable_css_ovmlyow1c6movtas934q, .table th.tinytable_css_ovmlyow1c6movtas934q { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_2x2fcm7i020t9fcglt8s, .table th.tinytable_css_2x2fcm7i020t9fcglt8s { border-bottom: solid #d3d8dc 0.1em; } phylum total p__Bacillota_A 40.6±15.93 p__Bacteroidota 38.3±15.88 p__Pseudomonadota 5.83±7.87 p__Bacillota 4.59±6.37 p__Campylobacterota 3.47±5.63 p__Desulfobacterota 2.68±4.05 p__Verrucomicrobiota 1.53±2.43 p__Bacillota_C 0.95±1.05 p__Fusobacteriota 0.91±3.7 p__Cyanobacteriota 0.4±0.6 p__Spirochaetota 0.22±0.97 p__Bacillota_B 0.19±0.32 p__Actinomycetota 0.17±0.52 p__Chlamydiota 0.1±0.61 p__Deferribacterota 0.05±0.27 p__Synergistota 0.01±0.08 phylum_arrange &lt;- phylum_summary %&gt;% group_by(phylum) %&gt;% summarise(mean=mean(relabun)) %&gt;% arrange(-mean) %&gt;% select(phylum) %&gt;% pull() phylum_summary %&gt;% filter(phylum %in% phylum_arrange) %&gt;% mutate(phylum=factor(phylum,levels=rev(phylum_arrange))) %&gt;% ggplot(aes(x=relabun, y=phylum, group=phylum, color=phylum)) + scale_color_manual(values=phylum_colors[rev(phylum_arrange)]) + geom_jitter(alpha=0.5) + theme_minimal() 6.2 Taxonomy boxplot 6.2.1 Family family_summary &lt;- genome_counts_filt %&gt;% mutate_at(vars(-genome),~./sum(.)) %&gt;% #apply TSS normalisation pivot_longer(-genome, names_to = &quot;sample&quot;, values_to = &quot;count&quot;) %&gt;% #reduce to minimum number of columns left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% #append sample metadata left_join(., genome_metadata, by = join_by(genome == genome)) %&gt;% #append genome metadata group_by(sample,family) %&gt;% summarise(relabun=sum(count)) family_summary %&gt;% group_by(family) %&gt;% summarise(mean=mean(relabun),sd=sd(relabun)) %&gt;% arrange(-mean) %&gt;% tt() .table td.tinytable_css_bbjrz6smtnw2f8qfnmyn, .table th.tinytable_css_bbjrz6smtnw2f8qfnmyn { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_71ergrkx5vju6i4iqf3b, .table th.tinytable_css_71ergrkx5vju6i4iqf3b { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } family mean sd f__Lachnospiraceae 2.798160e-01 0.1323151296 f__Bacteroidaceae 2.132576e-01 0.1045524501 f__Tannerellaceae 1.122881e-01 0.0756060991 f__ 6.556348e-02 0.0820773598 f__Helicobacteraceae 3.474580e-02 0.0562678198 f__Marinifilaceae 3.441228e-02 0.0255200299 f__UBA3700 2.777694e-02 0.0330290932 f__Desulfovibrionaceae 2.680077e-02 0.0404627923 f__Ruminococcaceae 2.435712e-02 0.0226880677 f__Rikenellaceae 1.900710e-02 0.0176572117 f__Erysipelotrichaceae 1.767814e-02 0.0269603016 f__Oscillospiraceae 1.696763e-02 0.0140960977 f__Coprobacillaceae 1.273032e-02 0.0336927310 f__Mycoplasmoidaceae 1.210259e-02 0.0270262454 f__Enterobacteriaceae 1.077111e-02 0.0651262303 f__Fusobacteriaceae 9.053249e-03 0.0370456782 f__Akkermansiaceae 8.677367e-03 0.0108836065 f__CAG-239 7.003283e-03 0.0098019806 f__LL51 6.656864e-03 0.0216352391 f__Anaerotignaceae 6.551732e-03 0.0074061779 f__UBA3830 5.185462e-03 0.0171469663 f__Gastranaerophilaceae 4.003188e-03 0.0059975426 f__Muribaculaceae 3.991492e-03 0.0409006227 f__Butyricicoccaceae 3.919222e-03 0.0050520985 f__CAG-274 3.051617e-03 0.0060828463 f__Acutalibacteraceae 2.723615e-03 0.0047471119 f__Anaerovoracaceae 2.683446e-03 0.0040557355 f__Pumilibacteraceae 2.544525e-03 0.0041701010 f__UBA1997 2.383785e-03 0.0080270055 f__CAG-508 2.324078e-03 0.0063109845 f__Brevinemataceae 2.191263e-03 0.0097068603 f__Peptococcaceae 1.937490e-03 0.0031961496 f__Rhodocyclaceae 1.936615e-03 0.0194735479 f__DTU072 1.792884e-03 0.0055918788 f__UBA660 1.742458e-03 0.0054664441 f__MGBC116941 1.714356e-03 0.0090980913 f__Massilibacillaceae 1.502892e-03 0.0024528334 f__Eggerthellaceae 1.377525e-03 0.0037174906 f__Enterococcaceae 8.454990e-04 0.0070848098 f__CALTSX01 5.198677e-04 0.0053270584 f__Chlamydiaceae 5.170637e-04 0.0030492819 f__Mucispirillaceae 4.593259e-04 0.0026630822 f__CALVMC01 4.496143e-04 0.0018583730 f__Clostridiaceae 4.212744e-04 0.0029132915 f__Acidaminococcaceae 4.004438e-04 0.0015777220 f__UBA1242 3.719350e-04 0.0014704441 f__RUG11792 3.717143e-04 0.0019425248 f__CAG-465 3.497207e-04 0.0015695529 f__Microbacteriaceae 3.199134e-04 0.0026999464 f__CAG-288 2.985206e-04 0.0017514912 f__Streptococcaceae 2.479473e-04 0.0018438849 f__Anaplasmataceae 2.435113e-04 0.0021508694 f__Hepatoplasmataceae 2.362221e-04 0.0024205565 f__Aeromonadaceae 2.327082e-04 0.0022486997 f__Peptostreptococcaceae 1.412306e-04 0.0014471826 f__Rhodobacteraceae 1.371859e-04 0.0014057373 f__Xanthomonadaceae 9.245878e-05 0.0009474206 f__Synergistaceae 7.840493e-05 0.0008034115 f__Lactobacillaceae 4.203166e-05 0.0004306963 f__Turicibacteraceae 0.000000e+00 0.0000000000 family_arrange &lt;- family_summary %&gt;% group_by(family) %&gt;% summarise(mean=sum(relabun)) %&gt;% arrange(-mean) %&gt;% select(family) %&gt;% pull() family_summary %&gt;% left_join(genome_metadata %&gt;% select(family,phylum) %&gt;% unique(),by=join_by(family==family)) %&gt;% left_join(sample_metadata,by=join_by(sample==EHI_number)) %&gt;% filter(family %in% family_arrange[1:20]) %&gt;% mutate(family=factor(family,levels=rev(family_arrange[1:20]))) %&gt;% filter(relabun &gt; 0) %&gt;% ggplot(aes(x=relabun, y=family, group=family, color=phylum)) + scale_color_manual(values=phylum_colors[-8]) + geom_jitter(alpha=0.5) + theme_minimal() + labs(y=&quot;Family&quot;, x=&quot;Relative abundance&quot;, color=&quot;Phylum&quot;) 6.2.2 Genus genus_summary &lt;- genome_counts_filt %&gt;% mutate_at(vars(-genome),~./sum(.)) %&gt;% #apply TSS normalisation pivot_longer(-genome, names_to = &quot;sample&quot;, values_to = &quot;count&quot;) %&gt;% #reduce to minimum number of columns left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% #append sample metadata left_join(genome_metadata, by = join_by(genome == genome)) %&gt;% #append genome metadata group_by(sample,genus) %&gt;% summarise(relabun=sum(count)) %&gt;% filter(genus != &quot;g__&quot;) genus_summary %&gt;% group_by(genus) %&gt;% summarise(mean=mean(relabun),sd=sd(relabun)) %&gt;% arrange(-mean) %&gt;% tt() .table td.tinytable_css_tvx488w7mf0a1b9vaq9x, .table th.tinytable_css_tvx488w7mf0a1b9vaq9x { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_idy2h9spaxaw5p0i83ut, .table th.tinytable_css_idy2h9spaxaw5p0i83ut { border-bottom: solid #d3d8dc 0.1em; } genus mean sd g__Bacteroides 1.725925e-01 0.0994470682 g__Parabacteroides 1.103381e-01 0.0767310570 g__Roseburia 5.077999e-02 0.0743624266 g__Phocaeicola 3.874581e-02 0.0435882803 g__JAAYNV01 3.526845e-02 0.0735025649 g__Odoribacter 3.376557e-02 0.0254845145 g__Helicobacter_J 2.983823e-02 0.0400574428 g__CAG-95 1.659217e-02 0.0240471187 g__Alistipes 1.555908e-02 0.0156740595 g__Kineothrix 1.544351e-02 0.0584815409 g__MGBC136627 1.451743e-02 0.0230914933 g__Mycoplasmoides 1.139564e-02 0.0269054026 g__Hungatella_A 1.113992e-02 0.0670243947 g__Anaerotruncus 1.006956e-02 0.0112599653 g__Velocimicrobium 9.687390e-03 0.0159382742 g__Enterocloster 9.506772e-03 0.0098451213 g__Fusobacterium_A 9.053249e-03 0.0370456782 g__Acetatifactor 8.989245e-03 0.0139417426 g__Akkermansia 8.677367e-03 0.0108836065 g__Clostridium_Q 7.770136e-03 0.0138182274 g__Bilophila 7.347777e-03 0.0088824113 g__Lawsonia 7.130440e-03 0.0356135290 g__Intestinimonas 6.565049e-03 0.0061282758 g__Lacrimispora 6.397950e-03 0.0078443852 g__Lachnotalea 5.679000e-03 0.0086820363 g__Desulfovibrio 5.604601e-03 0.0085133819 g__MGBC140009 5.533083e-03 0.0134005650 g__Extibacter 5.301402e-03 0.0438086011 g__Coprobacillus 5.255707e-03 0.0160178991 g__Ventrimonas 5.038137e-03 0.0083320432 g__NHYM01 4.907573e-03 0.0427691471 g__Dielma 4.863951e-03 0.0065480876 g__Eisenbergiella 4.698317e-03 0.0069699563 g__CHH4-2 4.463440e-03 0.0044701587 g__RGIG4733 4.252340e-03 0.0103379868 g__Negativibacillus 4.038946e-03 0.0054742770 g__Thomasclavelia 3.858196e-03 0.0117540652 g__Hungatella 3.440712e-03 0.0046402483 g__C-19 3.334625e-03 0.0097460323 g__Citrobacter 3.199667e-03 0.0207814167 g__UMGS1251 2.883830e-03 0.0066485409 g__Oscillibacter 2.697945e-03 0.0038453712 g__CAZU01 2.687821e-03 0.0062923086 g__Breznakia 2.569391e-03 0.0076690515 g__Copromonas 2.559264e-03 0.0037548588 g__Mailhella 2.486840e-03 0.0034349591 g__Pseudoflavonifractor 2.349829e-03 0.0028250595 g__Intestinibacillus 2.290036e-03 0.0027696754 g__Escherichia 2.232632e-03 0.0160096591 g__Brevinema 2.191263e-03 0.0097068603 g__MGBC165282 2.146060e-03 0.0051869977 g__Rikenella 2.123615e-03 0.0033608364 g__Morganella 2.019952e-03 0.0206983454 g__Robinsoniella 2.000942e-03 0.0198167695 g__Parabacteroides_B 1.950084e-03 0.0064473560 g__Hafnia 1.939718e-03 0.0112340944 g__Fluviibacter 1.936615e-03 0.0194735479 g__JAIHAL01 1.909337e-03 0.0043937983 g__CAJLXD01 1.809579e-03 0.0041385093 g__Marseille-P3106 1.729807e-03 0.0025326958 g__UBA866 1.535703e-03 0.0026149730 g__MGBC116941 1.433278e-03 0.0090996222 g__Duncaniella 1.426611e-03 0.0146184139 g__Stoquefichus 1.418761e-03 0.0046100976 g__Limenecus 1.393591e-03 0.0029887106 g__JAAYQI01 1.271605e-03 0.0020016472 g__RGIG6463 1.268390e-03 0.0028982477 g__Lawsonibacter 1.177407e-03 0.0016547788 g__Scatousia 1.174334e-03 0.0033329854 g__MGBC101980 1.147280e-03 0.0043856608 g__Hespellia 1.102861e-03 0.0080033094 g__Clostridium_AQ 1.075206e-03 0.0036972777 g__Tidjanibacter 1.062223e-03 0.0029392145 g__Fournierella 1.021882e-03 0.0022586979 g__Eggerthella 9.946416e-04 0.0031801193 g__OM05-12 9.566920e-04 0.0022952664 g__CALXRO01 9.555497e-04 0.0060396607 g__CALURL01 9.088777e-04 0.0021653921 g__Harryflintia 8.906013e-04 0.0020436518 g__MGBC133411 8.872215e-04 0.0021982622 g__Scatacola_A 8.685187e-04 0.0028129788 g__JALFVM01 8.392923e-04 0.0020111922 g__Bacteroides_G 8.358400e-04 0.0024999742 g__Ventrisoma 8.334289e-04 0.0015664780 g__CAG-269 8.185801e-04 0.0029513181 g__IOR16 8.132853e-04 0.0024147185 g__CAG-873 7.794020e-04 0.0079864937 g__Buttiauxella 7.562352e-04 0.0062186311 g__14-2 7.242943e-04 0.0014229865 g__Ureaplasma 7.069544e-04 0.0022811697 g__Scatocola 6.903112e-04 0.0024144468 g__Dysosmobacter 6.880800e-04 0.0012817741 g__Muricomes 6.843281e-04 0.0023723812 g__Anaerovorax 6.779999e-04 0.0017521412 g__UBA7185 6.690992e-04 0.0018509746 g__Butyricimonas 6.467068e-04 0.0016133034 g__MGBC131033 6.443020e-04 0.0015998136 g__Evtepia 6.309865e-04 0.0010453519 g__CAJMNU01 6.281598e-04 0.0008908563 g__Beduini 5.914594e-04 0.0013148807 g__Muribaculum 5.550053e-04 0.0056871120 g__Scandinavium 5.392506e-04 0.0034848792 g__Lactonifactor 5.340135e-04 0.0013169750 g__CALTSX01 5.198677e-04 0.0053270584 g__CAG-485 5.128011e-04 0.0052546481 g__Merdicola 5.109908e-04 0.0018183944 g__Ventrenecus 4.954074e-04 0.0024443063 g__UMGS1202 4.885966e-04 0.0016971062 g__Copranaerobaculum 4.827706e-04 0.0029167211 g__NSJ-61 4.574747e-04 0.0014044413 g__Faecimonas 4.467204e-04 0.0017621834 g__RGIG8482 4.415175e-04 0.0020991286 g__Faecivivens 4.313538e-04 0.0008927244 g__RGIG9287 4.228193e-04 0.0021002237 g__Sarcina 4.212744e-04 0.0029132915 g__Blautia_A 4.144742e-04 0.0010034450 g__Scatenecus 4.103021e-04 0.0026534948 g__Phascolarctobacterium 4.004438e-04 0.0015777220 g__Raoultibacter 3.828831e-04 0.0011609168 g__Caccovivens 3.719350e-04 0.0014704441 g__CAJTFG01 3.690163e-04 0.0010223015 g__HGM11386 3.642876e-04 0.0016060882 g__CAG-465 3.497207e-04 0.0015695529 g__Amedibacillus 3.457091e-04 0.0023834921 g__Enterococcus_A 3.276668e-04 0.0023252026 g__UMGS2016 3.212305e-04 0.0012912770 g__Emergencia 3.205926e-04 0.0009702487 g__Holdemania 3.098282e-04 0.0010287045 g__Blautia 3.095400e-04 0.0011077317 g__Protoclostridium 3.067429e-04 0.0010837140 g__Fimivivens 3.043536e-04 0.0008104254 g__RGIG7389 2.985465e-04 0.0005848732 g__CAG-345 2.985206e-04 0.0017514912 g__UBA7173 2.963722e-04 0.0030369115 g__Bariatricus 2.928468e-04 0.0008379528 g__Agathobaculum 2.787287e-04 0.0016389968 g__CALXDZ01 2.660973e-04 0.0006132220 g__UBA940 2.621830e-04 0.0009075589 g__Microbacterium 2.563077e-04 0.0026263723 g__Aminipila 2.506050e-04 0.0007479203 g__Lactococcus 2.479473e-04 0.0018438849 g__Wolbachia 2.435113e-04 0.0021508694 g__Paramuribaculum 2.432436e-04 0.0024925056 g__Hepatoplasma 2.362221e-04 0.0024205565 g__Aeromonas 2.327082e-04 0.0022486997 g__WRHT01 2.186196e-04 0.0006955370 g__Zhenpiania 2.116559e-04 0.0012708329 g__UBA5026 2.112884e-04 0.0009778887 g__UMGS1663 1.999591e-04 0.0007286034 g__MGBC107952 1.752651e-04 0.0009887232 g__CALXEL01 1.725652e-04 0.0013728689 g__CAG-273 1.482564e-04 0.0007864691 g__Clostridioides 1.412306e-04 0.0014471826 g__Paracoccus 1.371859e-04 0.0014057373 g__JAAWBF01 1.286984e-04 0.0006144643 g__JAFLTL01 1.270703e-04 0.0013020827 g__Bacteroides_H 1.267213e-04 0.0012985068 g__RUG12867 9.254620e-05 0.0006129332 g__Stenotrophomonas 9.245878e-05 0.0009474206 g__Rahnella 8.365618e-05 0.0008059384 g__Lumbricidophila 6.360575e-05 0.0006517650 g__UBA3263 5.098641e-05 0.0005224553 g__Fructobacillus 4.203166e-05 0.0004306963 g__Clostridium 0.000000e+00 0.0000000000 g__Turicibacter 0.000000e+00 0.0000000000 genus_arrange &lt;- genus_summary %&gt;% group_by(genus) %&gt;% summarise(mean=sum(relabun)) %&gt;% filter(genus != &quot;g__&quot;)%&gt;% arrange(-mean) %&gt;% select(genus) %&gt;% mutate(genus= sub(&quot;^g__&quot;, &quot;&quot;, genus)) %&gt;% pull() genus_summary %&gt;% left_join(genome_metadata %&gt;% select(genus,phylum) %&gt;% unique(),by=join_by(genus==genus)) %&gt;% left_join(sample_metadata,by=join_by(sample==EHI_number)) %&gt;% mutate(genus= sub(&quot;^g__&quot;, &quot;&quot;, genus)) %&gt;% filter(genus %in% genus_arrange[1:20]) %&gt;% mutate(genus=factor(genus,levels=rev(genus_arrange[1:20]))) %&gt;% filter(relabun &gt; 0) %&gt;% ggplot(aes(x=relabun, y=genus, group=genus, color=phylum)) + scale_color_manual(values=phylum_colors) + geom_jitter(alpha=0.5) + theme_minimal() + labs(y=&quot;Genus&quot;, x=&quot;Relative abundance&quot;, color=&quot;Phylum&quot;) "],["diversity-analyses.html", "Chapter 7 Diversity analyses 7.1 Alpha diversity 7.2 Beta diversity", " Chapter 7 Diversity analyses load(&quot;data/data.Rdata&quot;) 7.1 Alpha diversity # Calculate Hill numbers richness &lt;- genome_counts_filt %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% dplyr::select(where(~ !all(. == 0))) %&gt;% hilldiv(., q = 0) %&gt;% t() %&gt;% as.data.frame() %&gt;% dplyr::rename(richness = 1) %&gt;% rownames_to_column(var = &quot;sample&quot;) neutral &lt;- genome_counts_filt %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% dplyr::select(where(~ !all(. == 0))) %&gt;% hilldiv(., q = 1) %&gt;% t() %&gt;% as.data.frame() %&gt;% dplyr::rename(neutral = 1) %&gt;% rownames_to_column(var = &quot;sample&quot;) phylogenetic &lt;- genome_counts_filt %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% dplyr::select(where(~ !all(. == 0))) %&gt;% hilldiv(., q = 1, tree = genome_tree) %&gt;% t() %&gt;% as.data.frame() %&gt;% dplyr::rename(phylogenetic = 1) %&gt;% rownames_to_column(var = &quot;sample&quot;) # Aggregate basal GIFT into elements #Get list of present MAGs present_MAGs &lt;- genome_counts_filt %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% filter(rowSums(.[, -1]) != 0) %&gt;% rownames() #Align KEGG annotations with present MAGs and remove all-zero and all-one traits present_MAGs &lt;- present_MAGs[present_MAGs %in% rownames(genome_gifts)] genome_gifts_filt &lt;- genome_gifts[present_MAGs,] %&gt;% select_if(~!all(. == 0)) %&gt;% #remove all-zero modules select_if(~!all(. == 1)) #remove all-one modules #Filter count table to only contain present MAGs after KEGG filtering genome_counts_filt_filt &lt;- genome_counts_filt %&gt;% column_to_rownames(var = &quot;genome&quot;) genome_counts_filt_filt &lt;- genome_counts_filt_filt[present_MAGs,] dist &lt;- genome_gifts_filt %&gt;% to.elements(., GIFT_db) %&gt;% traits2dist(., method = &quot;gower&quot;) functional &lt;- genome_counts_filt_filt %&gt;% #column_to_rownames(var = &quot;genome&quot;) %&gt;% #dplyr::select(where(~ !all(. == 0))) %&gt;% hilldiv(., q = 1, dist = dist) %&gt;% t() %&gt;% as.data.frame() %&gt;% dplyr::rename(functional = 1) %&gt;% rownames_to_column(var = &quot;sample&quot;) %&gt;% mutate(functional = if_else(is.nan(functional), 1, functional)) # Merge all metrics alpha_div &lt;- richness %&gt;% full_join(neutral, by = join_by(sample == sample)) %&gt;% full_join(phylogenetic, by = join_by(sample == sample)) %&gt;% full_join(functional, by = join_by(sample == sample)) alpha_div %&gt;% pivot_longer(-sample, names_to = &quot;alpha&quot;, values_to = &quot;value&quot;) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% group_by(alpha)%&gt;% summarise( Aisa_mean=mean(value[Transect==&quot;Aisa&quot;], na.rm=T), Aisa_sd=sd(value[Transect==&quot;Aisa&quot;], na.rm=T), Aran_mean=mean(value[Transect==&quot;Aran&quot;], na.rm=T), Aran_sd=sd(value[Transect==&quot;Aran&quot;], na.rm=T), Sentein_mean=mean(value[Transect==&quot;Sentein&quot;], na.rm=T), Sentein_sd=sd(value[Transect==&quot;Sentein&quot;], na.rm=T), Tourmalet_mean=mean(value[Transect==&quot;Tourmalet&quot;], na.rm=T), Tourmalet_sd=sd(value[Transect==&quot;Tourmalet&quot;], na.rm=T))%&gt;% mutate( Aisa=str_c(round(Aisa_mean,2),&quot;±&quot;,round(Aisa_sd,2)), Aran=str_c(round(Aran_mean,2),&quot;±&quot;,round(Aran_sd,2)), Sentein=str_c(round(Sentein_mean,2),&quot;±&quot;,round(Sentein_sd,2)), Tourmalet=str_c(round(Tourmalet_mean,2),&quot;±&quot;,round(Tourmalet_sd,2))) %&gt;% arrange(-Aisa_mean) %&gt;% dplyr::select(alpha,Aisa,Aran,Sentein,Tourmalet) %&gt;% tt() .table td.tinytable_css_cpk4gfpnks3og5qtp3ta, .table th.tinytable_css_cpk4gfpnks3og5qtp3ta { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_8vswdpto03no4dwpee6b, .table th.tinytable_css_8vswdpto03no4dwpee6b { border-bottom: solid #d3d8dc 0.1em; } alpha Aisa Aran Sentein Tourmalet richness 198.77±65.73 153.32±72.26 257.32±71.08 245.04±68.73 neutral 87.81±36.55 71.13±36.69 110.98±45.84 101.5±43.7 phylogenetic 4.98±1.13 4.81±1.12 5.41±0.86 5.29±0.9 functional 1.5±0.05 1.5±0.06 1.52±0.03 1.5±0.04 alpha_div %&gt;% pivot_longer(-sample, names_to = &quot;metric&quot;, values_to = &quot;value&quot;) %&gt;% left_join(., sample_metadata, by = join_by(sample == EHI_number)) %&gt;% mutate(metric=factor(metric,levels=c(&quot;richness&quot;,&quot;neutral&quot;,&quot;phylogenetic&quot;,&quot;functional&quot;))) %&gt;% ggplot(aes(y = value, x = Transect, group=Transect, color=Transect, fill=Transect)) + geom_boxplot(outlier.shape = NA) + geom_jitter(alpha=0.5) + scale_color_manual(name=&quot;Transect&quot;, breaks=c(&quot;Aisa&quot;,&quot;Aran&quot;,&quot;Sentein&quot;,&quot;Tourmalet&quot;), labels=c(&quot;Aisa&quot;,&quot;Aran&quot;,&quot;Sentein&quot;,&quot;Tourmalet&quot;), values=c(&quot;#e5bd5b&quot;, &quot;#6b7398&quot;,&quot;#e2815a&quot;, &quot;#876b96&quot;)) + scale_fill_manual(name=&quot;Transect&quot;, breaks=c(&quot;Aisa&quot;,&quot;Aran&quot;,&quot;Sentein&quot;,&quot;Tourmalet&quot;), labels=c(&quot;Aisa&quot;,&quot;Aran&quot;,&quot;Sentein&quot;,&quot;Tourmalet&quot;), values=c(&quot;#e5bd5b50&quot;, &quot;#6b739850&quot;,&quot;#e2815a50&quot;, &quot;#876b9650&quot;)) + facet_wrap(. ~ metric, scales = &quot;free&quot;, ncol=4) + coord_cartesian(xlim = c(1, NA)) + stat_compare_means(size=2) + theme_classic() + theme( strip.background = element_blank(), panel.grid.minor.x = element_line(size = .1, color = &quot;grey&quot;), axis.text.x = element_text(angle = 45, hjust = 1) ) + ylab(&quot;Alpha diversity&quot;) 7.1.1 Regression plots 7.1.1.1 Richness diversity columns &lt;- c(&quot;richness&quot;,&quot;neutral&quot;,&quot;phylo&quot;,&quot;func&quot;,&quot;mapped&quot;,&quot;total&quot;) alpha_div %&gt;% select(sample,richness) %&gt;% pivot_longer(-sample, names_to = &quot;data&quot;, values_to = &quot;value&quot;) %&gt;% mutate(data = factor(data, levels = columns)) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% ggplot(aes(x = Elevation, y = value)) + geom_point() + geom_smooth(method = &quot;loess&quot;) + stat_poly_eq()+ facet_wrap(~ factor(Transect))+ labs(x = &quot;Elevation (m)&quot;) 7.1.1.2 Neutral diversity alpha_div %&gt;% select(sample,neutral) %&gt;% pivot_longer(-sample, names_to = &quot;data&quot;, values_to = &quot;value&quot;) %&gt;% mutate(data = factor(data, levels = columns)) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% ggplot(aes(x = Elevation, y = value)) + geom_point() + geom_smooth(method = &quot;loess&quot;) + stat_poly_eq()+ facet_wrap(~ factor(Transect))+ labs(x = &quot;Elevation (m)&quot;) 7.1.1.3 Phylogenetic diversity alpha_div %&gt;% select(sample,phylogenetic) %&gt;% pivot_longer(-sample, names_to = &quot;data&quot;, values_to = &quot;value&quot;) %&gt;% mutate(data = factor(data, levels = columns)) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% ggplot(aes(x = Elevation, y = value)) + geom_point() + geom_smooth(method = &quot;loess&quot;) + stat_poly_eq()+ facet_wrap(~ factor(Transect))+ labs(x = &quot;Elevation (m)&quot;) 7.1.1.4 Functional diversities alpha_div %&gt;% select(sample,functional) %&gt;% pivot_longer(-sample, names_to = &quot;data&quot;, values_to = &quot;value&quot;) %&gt;% mutate(data = factor(data, levels = columns)) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% ggplot(aes(x = Elevation, y = value)) + geom_point() + geom_smooth(method = &quot;loess&quot;) + stat_poly_eq()+ facet_wrap(~ factor(Transect))+ labs(x = &quot;Elevation (m)&quot;) 7.1.2 Mixed models 7.1.2.1 Richness diversity richness_cor&lt;-alpha_div %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% lmerTest::lmer(richness ~ log(sequencing_depth) + Elevation*Transect + (1 | Sampling_point), data = ., REML = FALSE) %&gt;% broom.mixed::tidy() %&gt;% tt() 7.1.2.2 Neutral diversity neutral_cor&lt;-alpha_div %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% lmerTest::lmer(neutral ~ log(sequencing_depth) + Elevation*Transect + (1|Sampling_point), data = ., REML = FALSE) %&gt;% broom.mixed::tidy() %&gt;% tt() 7.1.2.3 Phylogenetic diversity phylo_cor&lt;-alpha_div %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% lmerTest::lmer(phylogenetic ~ log(sequencing_depth) + Elevation*Transect + (1 | Sampling_point), data = ., REML = FALSE) %&gt;% broom.mixed::tidy() %&gt;% tt() 7.1.2.4 Functional diversities func_cor&lt;-alpha_div %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% lmerTest::lmer(functional ~ log(sequencing_depth) + Elevation*Transect + (1 | Sampling_point), data = ., REML = FALSE) %&gt;% broom.mixed::tidy() %&gt;% tt() 7.2 Beta diversity beta_q0n &lt;- genome_counts_filt %&gt;% column_to_rownames(., &quot;genome&quot;) %&gt;% hillpair(., q = 0) beta_q1n &lt;- genome_counts_filt %&gt;% column_to_rownames(., &quot;genome&quot;) %&gt;% hillpair(., q = 1) beta_q1p &lt;- genome_counts_filt %&gt;% column_to_rownames(., &quot;genome&quot;) %&gt;% hillpair(., q = 1, tree = genome_tree) beta_q1f &lt;- genome_counts_filt_filt %&gt;% #column_to_rownames(., &quot;genome&quot;) %&gt;% hillpair(., q = 1, dist = dist) 7.2.1 Beta diversity per individual 7.2.1.1 Richness beta_q0n_nmds &lt;- beta_q0n$S %&gt;% metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %&gt;% vegan::scores() %&gt;% as_tibble(., rownames = &quot;sample&quot;) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) group_n &lt;- length(unique(beta_q0n_nmds$Transect)) beta_q0n_nmds$Elevation&lt;-as.character(beta_q0n_nmds$Elevation) beta_q0n_nmds %&gt;% group_by(Elevation) %&gt;% mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %&gt;% mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %&gt;% ungroup() %&gt;% ggplot(., aes(x=NMDS1,y=NMDS2, color=Elevation)) + #scale_color_manual(values=beta_colors[c(1:group_n)]) + geom_point(size=2) + geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) + theme_classic() + facet_wrap(.~Transect, scale=&quot;free&quot;) + theme(legend.position=&quot;right&quot;, legend.box=&quot;vertical&quot;) + guides(color=guide_legend(title=&quot;Elevation&quot;)) betadisper(beta_q0n$S, sample_metadata$Transect) %&gt;% permutest(., pairwise=TRUE) Permutation test for homogeneity of multivariate dispersions Permutation: free Number of permutations: 999 Response: Distances Df Sum Sq Mean Sq F N.Perm Pr(&gt;F) Groups 3 0.00102 0.0003414 0.0493 999 0.982 Residuals 101 0.69990 0.0069297 Pairwise comparisons: (Observed p-value below diagonal, permuted p-value above diagonal) Aisa Aran Sentein Tourmalet Aisa 0.81300 0.97100 0.768 Aran 0.81748 0.79900 0.992 Sentein 0.97241 0.79372 0.729 Tourmalet 0.77376 0.98856 0.73109 adonis2(beta_q0n$S ~ Elevation+Transect+Sampling_point, data = sample_metadata %&gt;% arrange(match(sample,labels(beta_q0n$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() Warning in tidy.anova(.): The following column names in ANOVA output were not recognized or transformed: SumOfSqs, R2 .table td.tinytable_css_y3h8ac2osskxls3gfoyi, .table th.tinytable_css_y3h8ac2osskxls3gfoyi { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_0cytray117i6u97l4yi5, .table th.tinytable_css_0cytray117i6u97l4yi5 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } term df SumOfSqs R2 statistic p.value Elevation 1 0.250199 0.007680647 0.8056359 0.880 Transect 3 1.044702 0.032070438 1.1213073 0.133 Sampling_point 16 5.193233 0.159422684 1.0451320 0.201 Residual 84 26.087111 0.800826231 NA NA Total 104 32.575245 1.000000000 NA NA 7.2.1.2 Neutral beta_q1n_nmds &lt;- beta_q1n$S %&gt;% metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %&gt;% vegan::scores() %&gt;% as_tibble(., rownames = &quot;sample&quot;) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) group_n &lt;- length(unique(beta_q1n_nmds$Transect)) beta_q1n_nmds$Elevation&lt;-as.character(beta_q1n_nmds$Elevation) beta_q1n_nmds %&gt;% group_by(Elevation) %&gt;% mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %&gt;% mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %&gt;% ungroup() %&gt;% ggplot(., aes(x=NMDS1,y=NMDS2, color=Elevation)) + #scale_color_manual(values=beta_colors[c(1:group_n)]) + geom_point(size=2) + geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) + theme_classic() + facet_wrap(.~Transect, scale=&quot;free&quot;) + theme(legend.position=&quot;right&quot;, legend.box=&quot;vertical&quot;) + guides(color=guide_legend(title=&quot;Elevation&quot;)) betadisper(beta_q1n$S, sample_metadata$Transect) %&gt;% permutest(., pairwise=TRUE) Permutation test for homogeneity of multivariate dispersions Permutation: free Number of permutations: 999 Response: Distances Df Sum Sq Mean Sq F N.Perm Pr(&gt;F) Groups 3 0.00828 0.0027596 0.3593 999 0.768 Residuals 101 0.77583 0.0076815 Pairwise comparisons: (Observed p-value below diagonal, permuted p-value above diagonal) Aisa Aran Sentein Tourmalet Aisa 0.67400 0.66100 0.644 Aran 0.65706 0.37600 0.950 Sentein 0.66556 0.39226 0.312 Tourmalet 0.64203 0.95713 0.33301 adonis2(beta_q1n$S ~ Elevation*Transect+Sampling_point, data = sample_metadata %&gt;% arrange(match(sample,labels(beta_q1n$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() Warning in tidy.anova(.): The following column names in ANOVA output were not recognized or transformed: SumOfSqs, R2 .table td.tinytable_css_pvx11lo5et7fs85qkw9b, .table th.tinytable_css_pvx11lo5et7fs85qkw9b { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_nkp5pd85wj7znnms5v6e, .table th.tinytable_css_nkp5pd85wj7znnms5v6e { border-bottom: solid #d3d8dc 0.1em; } term df SumOfSqs R2 statistic p.value Elevation 1 0.2113432 0.006807784 0.7141154 0.918 Transect 3 0.9052012 0.029158328 1.0195393 0.432 Sampling_point 16 5.0679116 0.163247498 1.0702597 0.161 Residual 84 24.8598888 0.800786390 NA NA Total 104 31.0443448 1.000000000 NA NA 7.2.1.3 Phylogenetic beta_q1p_nmds &lt;- beta_q1p$S %&gt;% metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %&gt;% vegan::scores() %&gt;% as_tibble(., rownames = &quot;sample&quot;) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) beta_q1p_nmds$Elevation&lt;-as.character(beta_q1p_nmds$Elevation) beta_q1p_nmds %&gt;% group_by(Elevation) %&gt;% mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %&gt;% mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %&gt;% ungroup() %&gt;% ggplot(., aes(x=NMDS1,y=NMDS2, color=Elevation)) + #scale_color_manual(values=beta_colors[c(1:group_n)]) + geom_point(size=2) + geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) + theme_classic() + facet_wrap(.~Transect, scale=&quot;free&quot;) + theme(legend.position=&quot;right&quot;, legend.box=&quot;vertical&quot;) + guides(color=guide_legend(title=&quot;Elevation&quot;)) betadisper(beta_q1p$S, sample_metadata$Transect) %&gt;% permutest(., pairwise=TRUE) Permutation test for homogeneity of multivariate dispersions Permutation: free Number of permutations: 999 Response: Distances Df Sum Sq Mean Sq F N.Perm Pr(&gt;F) Groups 3 0.00719 0.002396 0.2197 999 0.865 Residuals 101 1.10166 0.010908 Pairwise comparisons: (Observed p-value below diagonal, permuted p-value above diagonal) Aisa Aran Sentein Tourmalet Aisa 0.72700 0.64000 0.908 Aran 0.73539 0.43900 0.830 Sentein 0.62637 0.44777 0.573 Tourmalet 0.90540 0.81074 0.54936 adonis2(beta_q1p$S ~ Elevation+Transect+Sampling_point, data = sample_metadata %&gt;% arrange(match(sample,labels(beta_q1p$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() Warning in tidy.anova(.): The following column names in ANOVA output were not recognized or transformed: SumOfSqs, R2 .table td.tinytable_css_uw47aa4v7if2yd7ro56j, .table th.tinytable_css_uw47aa4v7if2yd7ro56j { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_onvcgihlcdc2x95ueh7q, .table th.tinytable_css_onvcgihlcdc2x95ueh7q { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } term df SumOfSqs R2 statistic p.value Elevation 1 0.01724589 0.003672461 0.3792509 0.893 Transect 3 0.14559502 0.031004014 1.0672500 0.401 Sampling_point 16 0.71338419 0.151912980 0.9804928 0.543 Residual 84 3.81978038 0.813410545 NA NA Total 104 4.69600548 1.000000000 NA NA 7.2.1.4 Functional beta_q1f_nmds &lt;- beta_q1f$S %&gt;% metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %&gt;% vegan::scores() %&gt;% as_tibble(., rownames = &quot;sample&quot;) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) group_n &lt;- length(unique(beta_q1f_nmds$Transect)) beta_q1f_nmds$Elevation&lt;-as.character(beta_q1f_nmds$Elevation) beta_q1f_nmds %&gt;% group_by(Elevation) %&gt;% mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %&gt;% mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %&gt;% ungroup() %&gt;% ggplot(., aes(x=NMDS1,y=NMDS2, color=Elevation)) + #scale_color_manual(values=beta_colors[c(1:group_n)]) + geom_point(size=2) + geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) + theme_classic() + facet_wrap(.~Transect, scale=&quot;free&quot;) + theme(legend.position=&quot;right&quot;, legend.box=&quot;vertical&quot;) + guides(color=guide_legend(title=&quot;Elevation&quot;)) betadisper(beta_q1f$S, sample_metadata$Transect) %&gt;% permutest(., pairwise=TRUE) Warning in betadisper(beta_q1f$S, sample_metadata$Transect): some squared distances are negative and changed to zero Permutation test for homogeneity of multivariate dispersions Permutation: free Number of permutations: 999 Response: Distances Df Sum Sq Mean Sq F N.Perm Pr(&gt;F) Groups 3 0.00554 0.0018483 0.1701 999 0.914 Residuals 101 1.09751 0.0108664 Pairwise comparisons: (Observed p-value below diagonal, permuted p-value above diagonal) Aisa Aran Sentein Tourmalet Aisa 0.54000 0.69500 0.467 Aran 0.55079 0.99200 0.843 Sentein 0.67473 0.98597 0.867 Tourmalet 0.46820 0.83647 0.86821 adonis2(beta_q1f$S ~ Elevation+Transect+Sampling_point, data = sample_metadata %&gt;% arrange(match(sample,labels(beta_q1f$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() Warning in tidy.anova(.): The following column names in ANOVA output were not recognized or transformed: SumOfSqs, R2 .table td.tinytable_css_z4vapus1tz2q5hr0rax3, .table th.tinytable_css_z4vapus1tz2q5hr0rax3 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_gomgz6k3cfvzf6s7peri, .table th.tinytable_css_gomgz6k3cfvzf6s7peri { border-bottom: solid #d3d8dc 0.1em; } term df SumOfSqs R2 statistic p.value Elevation 1 3.444176e-05 1.774752e-05 0.002064744 0.675 Transect 3 3.180278e-02 1.638768e-02 0.635513333 0.555 Sampling_point 16 5.076202e-01 2.615720e-01 1.901953007 0.086 Residual 84 1.401195e+00 7.220226e-01 NA NA Total 104 1.940652e+00 1.000000e+00 NA NA 7.2.2 Beta diversity per population richness_beta &lt;- genome_counts_filt %&gt;% pivot_longer(!genome,names_to=&quot;sample&quot;,values_to = &quot;counts&quot;) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% mutate(Sampling_point=factor(Sampling_point)) %&gt;% group_by(Sampling_point) %&gt;% group_split() %&gt;% map_dbl(., ~ .x %&gt;% select(genome, sample, counts) %&gt;% pivot_wider(names_from = sample, values_from = counts) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% tss() %&gt;% as.data.frame() %&gt;% hilldiss(data=., metric=&quot;S&quot;, q = 0) ) names(richness_beta) &lt;- unique(sample_metadata$Sampling_point) %&gt;% sort() neutral_beta &lt;- genome_counts_filt %&gt;% pivot_longer(!genome,names_to=&quot;sample&quot;,values_to = &quot;counts&quot;) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% mutate(Sampling_point=factor(Sampling_point)) %&gt;% group_by(Sampling_point) %&gt;% group_split() %&gt;% map_dbl(., ~ .x %&gt;% select(genome, sample, counts) %&gt;% pivot_wider(names_from = sample, values_from = counts) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% tss() %&gt;% as.data.frame() %&gt;% hilldiss(data=., metric=&quot;S&quot;, q = 1) ) names(neutral_beta) &lt;- unique(sample_metadata$Sampling_point) %&gt;% sort() phylogenetic_beta &lt;- genome_counts_filt %&gt;% pivot_longer(!genome,names_to=&quot;sample&quot;,values_to = &quot;counts&quot;) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% mutate(Sampling_point=factor(Sampling_point)) %&gt;% group_by(Sampling_point) %&gt;% group_split() %&gt;% map_dbl(., ~ .x %&gt;% select(genome, sample, counts) %&gt;% pivot_wider(names_from = sample, values_from = counts) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% tss() %&gt;% as.data.frame() %&gt;% hilldiss(data=., metric=&quot;S&quot;, q = 1, tree = genome_tree) ) names(phylogenetic_beta) &lt;- unique(sample_metadata$Sampling_point) %&gt;% sort() genome_counts_filt_filt &lt;- tibble::rownames_to_column(genome_counts_filt_filt, var = &quot;genome&quot;) functional_beta &lt;- genome_counts_filt_filt %&gt;% tibble::rownames_to_column(var = &quot;genome&quot;) %&gt;% pivot_longer(!genome,names_to=&quot;sample&quot;,values_to = &quot;counts&quot;) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% mutate(Sampling_point=factor(Sampling_point)) %&gt;% group_by(Sampling_point) %&gt;% group_split() %&gt;% map_dbl(., ~ .x %&gt;% select(genome, sample, counts) %&gt;% pivot_wider(names_from = sample, values_from = counts) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% tss() %&gt;% as.data.frame() %&gt;% hilldiss(data=., metric=&quot;S&quot;, q = 1, dist = dist) ) names(functional_beta) &lt;- unique(sample_metadata$Sampling_point) %&gt;% sort() # Merge all metrics beta_div &lt;- bind_rows(richness_beta,neutral_beta,phylogenetic_beta,functional_beta) %&gt;% t() %&gt;% as.data.frame() %&gt;% rownames_to_column(var=&quot;Sampling_point&quot;) %&gt;% as_tibble() %&gt;% rename(&quot;richness&quot;=V1,&quot;neutral&quot;=V2,&quot;phylogenetic&quot;=V3,&quot;functional&quot;=V4) beta_div %&gt;% pivot_longer(-Sampling_point, names_to = &quot;metric&quot;, values_to = &quot;value&quot;) %&gt;% left_join(sample_metadata %&gt;% select(Transect,Sampling_point, Elevation) %&gt;% unique, by = &quot;Sampling_point&quot;) %&gt;% mutate(metric=factor(metric,levels=c(&quot;richness&quot;,&quot;neutral&quot;,&quot;phylogenetic&quot;,&quot;functional&quot;))) %&gt;% ggplot(aes(y = value, x = Transect,group=Transect, fill=Transect)) + geom_boxplot(outlier.shape = NA) + geom_jitter(aes(color = Elevation), alpha = 0.5, size = 2) + scale_colour_gradient(low=&quot;#a7f0ba&quot;, high=&quot;#044319&quot;) + scale_fill_manual(name=&quot;Transect&quot;, breaks=c(&quot;Aisa&quot;,&quot;Aran&quot;,&quot;Sentein&quot;,&quot;Tourmalet&quot;), labels=c(&quot;Aisa&quot;,&quot;Aran&quot;,&quot;Sentein&quot;,&quot;Tourmalet&quot;), values=c(&quot;#e5bd5b50&quot;, &quot;#6b739850&quot;,&quot;#e2815a50&quot;, &quot;#876b9650&quot;)) + facet_wrap(. ~ metric, scales = &quot;free&quot;, ncol=4) + coord_cartesian(xlim = c(1, NA)) + stat_compare_means(size=2) + theme_classic() + theme( strip.background = element_blank(), panel.grid.minor.x = element_line(size = .1, color = &quot;grey&quot;), axis.text.x = element_text(angle = 45, hjust = 1) ) + ylab(&quot;Beta diversity&quot;) bxp1&lt;-beta_div %&gt;% pivot_longer(-Sampling_point, names_to = &quot;metric&quot;, values_to = &quot;value&quot;) %&gt;% left_join(sample_metadata %&gt;% select(Transect,Sampling_point, Elevation) %&gt;% unique, by = &quot;Sampling_point&quot;) %&gt;% mutate(metric=factor(metric,levels=c(&quot;richness&quot;,&quot;neutral&quot;,&quot;phylogenetic&quot;,&quot;functional&quot;))) %&gt;% ggplot(aes(y = value, x = Elevation ,group=Elevation, colour=Transect)) + #geom_boxplot(outlier.shape = NA) + geom_point(aes(color = Transect), alpha = 0.5, size = 2) + geom_line(aes(group = interaction(Transect, metric)), position = position_dodge(width = 0.5))+ #scale_color_viridis_c(name = &quot;Elevation&quot;, option = &quot;viridis&quot;) + scale_color_manual(name=&quot;Transect&quot;, breaks=c(&quot;Aisa&quot;,&quot;Aran&quot;,&quot;Sentein&quot;,&quot;Tourmalet&quot;), labels=c(&quot;Aisa&quot;,&quot;Aran&quot;,&quot;Sentein&quot;,&quot;Tourmalet&quot;), values=c(&quot;#e5bd5b50&quot;, &quot;#6b739850&quot;,&quot;#e2815a50&quot;, &quot;#876b9650&quot;)) + facet_wrap(. ~ metric, scales = &quot;free&quot;, ncol=4) + coord_cartesian(xlim = c(1, NA)) + #stat_compare_means(size=2) + theme_classic() + theme( strip.background = element_blank(), panel.grid.minor.x = element_line(size = .1, color = &quot;grey&quot;), axis.text.x = element_text(angle = 45, hjust = 1) ) + ylab(&quot;Beta diversity&quot;) #bxp1 + #geom_signif(comparisons = list(c(&quot;Aisa&quot;, &quot;Aran&quot;), c(&quot;Aisa&quot;, &quot;Sentein&quot;), c(&quot;Aisa&quot;, &quot;Tourmalet&quot;),c(&quot;Aran&quot;, &quot;Sentein&quot;), c(&quot;Aran&quot;, &quot;Tourmalet&quot;), # c(&quot;Sentein&quot;, &quot;Tourmalet&quot;)), # map_signif_level = TRUE) 7.2.3 Beta diversity per transect (calculated from individuals) 7.2.3.1 Aisa transect [1] TRUE nrow(Aisa_transect) [1] 22 beta_div_richness_aisa&lt;-hillpair(data=Aisa_counts, q=0) beta_div_neutral_aisa&lt;-hillpair(data=Aisa_counts, q=1) beta_div_phylo_aisa&lt;-hillpair(data=Aisa_counts, q=1, tree=genome_tree) beta_div_func_aisa&lt;-hillpair(data=Aisa_counts_func, q=1, dist=dist) adonis2(beta_div_richness_aisa$S ~ Elevation+Sampling_point, data = Aisa_transect %&gt;% arrange(match(sample,labels(beta_div_richness_aisa$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() .table td.tinytable_css_cfviq81hjn8lr057oa0j, .table th.tinytable_css_cfviq81hjn8lr057oa0j { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_3gqaqch8ge7l6e7lfreo, .table th.tinytable_css_3gqaqch8ge7l6e7lfreo { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } term df SumOfSqs R2 statistic p.value Elevation 1 0.2452187 0.03867980 0.808192 0.858 Sampling_point 2 0.6329952 0.09984608 1.043113 0.358 Residual 18 5.4614954 0.86147411 NA NA Total 21 6.3397093 1.00000000 NA NA adonis2(beta_div_neutral_aisa$S ~ Elevation+Sampling_point, data = Aisa_transect %&gt;% arrange(match(sample,labels(beta_div_neutral_aisa$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() .table td.tinytable_css_d4gep3uexoa900uqe068, .table th.tinytable_css_d4gep3uexoa900uqe068 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_3ohbagjlclx2zvp1mr5b, .table th.tinytable_css_3ohbagjlclx2zvp1mr5b { border-bottom: solid #d3d8dc 0.1em; } term df SumOfSqs R2 statistic p.value Elevation 1 0.2313974 0.03841233 0.795509 0.746 Sampling_point 2 0.5568084 0.09243104 0.957111 0.532 Residual 18 5.2358353 0.86915663 NA NA Total 21 6.0240411 1.00000000 NA NA adonis2(beta_div_phylo_aisa$S ~ Elevation+Sampling_point, data = Aisa_transect %&gt;% arrange(match(sample,labels(beta_div_phylo_aisa$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() .table td.tinytable_css_mqqtzxl3aa0p7k4e2p1l, .table th.tinytable_css_mqqtzxl3aa0p7k4e2p1l { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_1e3cjyxvr974z17jbri4, .table th.tinytable_css_1e3cjyxvr974z17jbri4 { border-bottom: solid #d3d8dc 0.1em; } term df SumOfSqs R2 statistic p.value Elevation 1 0.02910615 0.03545939 0.7333946 0.542 Sampling_point 2 0.07736039 0.09424649 0.9746342 0.412 Residual 18 0.71436393 0.87029412 NA NA Total 21 0.82083047 1.00000000 NA NA adonis2(beta_div_func_aisa$S ~ Elevation+Sampling_point, data = Aisa_transect %&gt;% arrange(match(sample,labels(beta_div_func_aisa$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() .table td.tinytable_css_xdq6eb2rezfr56b8toed, .table th.tinytable_css_xdq6eb2rezfr56b8toed { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_irtmmaova4qkpczsll0n, .table th.tinytable_css_irtmmaova4qkpczsll0n { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } term df SumOfSqs R2 statistic p.value Elevation 1 0.02597663 0.2038247 7.115190 0.049 Sampling_point 2 0.03575368 0.2805399 4.896598 0.073 Residual 18 0.06571565 0.5156354 NA NA Total 21 0.12744595 1.0000000 NA NA 7.2.3.2 Aran transect [1] 37 beta_div_richness_aran&lt;-hillpair(data=Aran_counts, q=0) beta_div_neutral_aran&lt;-hillpair(data=Aran_counts, q=1) beta_div_phylo_aran&lt;-hillpair(data=Aran_counts, q=1, tree=genome_tree) beta_div_func_aran&lt;-hillpair(data=Aran_counts_func, q=1, dist=dist) adonis2(beta_div_richness_aran$S ~ Elevation+Sampling_point, data = Aran_transect %&gt;% arrange(match(sample,labels(beta_div_richness_aran$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() .table td.tinytable_css_rdabx65o4f37le05ql30, .table th.tinytable_css_rdabx65o4f37le05ql30 { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_0lk2gnaccvi86lafs5r2, .table th.tinytable_css_0lk2gnaccvi86lafs5r2 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } term df SumOfSqs R2 statistic p.value Elevation 1 0.348770 0.02860073 1.040376 0.356 Sampling_point 4 1.453403 0.11918565 1.083870 0.183 Residual 31 10.392271 0.85221362 NA NA Total 36 12.194444 1.00000000 NA NA adonis2(beta_div_neutral_aran$S ~ Elevation+Sampling_point, data = Aran_transect %&gt;% arrange(match(sample,labels(beta_div_neutral_aran$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() .table td.tinytable_css_ias8qalk20yi4gv70brn, .table th.tinytable_css_ias8qalk20yi4gv70brn { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_5c2fcmbngoscwy5kjdtk, .table th.tinytable_css_5c2fcmbngoscwy5kjdtk { border-bottom: solid #d3d8dc 0.1em; } term df SumOfSqs R2 statistic p.value Elevation 1 0.2726884 0.02397478 0.8628086 0.685 Sampling_point 4 1.3038133 0.11463133 1.0313433 0.377 Residual 31 9.7974681 0.86139390 NA NA Total 36 11.3739697 1.00000000 NA NA adonis2(beta_div_phylo_aran$S ~ Elevation+Sampling_point, data = Aran_transect %&gt;% arrange(match(sample,labels(beta_div_phylo_aran$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() .table td.tinytable_css_81gl5ul1bt45n4yy0k0o, .table th.tinytable_css_81gl5ul1bt45n4yy0k0o { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_0pmi7gl0fz5hjp988kq1, .table th.tinytable_css_0pmi7gl0fz5hjp988kq1 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } term df SumOfSqs R2 statistic p.value Elevation 1 0.04455854 0.02133235 0.7612649 0.605 Sampling_point 4 0.22971962 0.10997801 0.9811669 0.439 Residual 31 1.81449967 0.86868964 NA NA Total 36 2.08877784 1.00000000 NA NA adonis2(beta_div_func_aran$S ~ Elevation+Sampling_point, data = Aran_transect %&gt;% arrange(match(sample,labels(beta_div_func_aran$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() .table td.tinytable_css_tw9jrss9kmf2cit8e63y, .table th.tinytable_css_tw9jrss9kmf2cit8e63y { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_7yaupz1y3o82ga3517i4, .table th.tinytable_css_7yaupz1y3o82ga3517i4 { border-bottom: solid #d3d8dc 0.1em; } term df SumOfSqs R2 statistic p.value Elevation 1 -0.009676017 -0.02070078 -0.6832475 0.931 Sampling_point 4 0.038082833 0.08147407 0.6722807 0.582 Residual 31 0.439015925 0.93922671 NA NA Total 36 0.467422742 1.00000000 NA NA 7.2.3.3 Sentein transect nrow(sentein_transect) [1] 19 beta_div_richness_sentein&lt;-hillpair(data=sentein_counts, q=0) beta_div_neutral_sentein&lt;-hillpair(data=sentein_counts, q=1) beta_div_phylo_sentein&lt;-hillpair(data=sentein_counts, q=1, tree=genome_tree) beta_div_func_sentein&lt;-hillpair(data=sentein_counts_func, q=1, dist=dist) adonis2(beta_div_richness_sentein$S ~ Elevation+Sampling_point, data = sentein_transect %&gt;% arrange(match(sample,labels(beta_div_richness_sentein$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() .table td.tinytable_css_tvhwbyp7hpny45yw2ges, .table th.tinytable_css_tvhwbyp7hpny45yw2ges { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_01lh76aee14iygofbckh, .table th.tinytable_css_01lh76aee14iygofbckh { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } term df SumOfSqs R2 statistic p.value Elevation 1 0.1775891 0.04190734 0.7478452 0.933 Sampling_point 2 0.4980556 0.11753080 1.0486807 0.314 Residual 15 3.5620159 0.84056186 NA NA Total 18 4.2376606 1.00000000 NA NA adonis2(beta_div_neutral_sentein$S ~ Elevation+Sampling_point, data = sentein_transect %&gt;% arrange(match(sample,labels(beta_div_neutral_sentein$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() .table td.tinytable_css_pb11c9x3b2e71yml3ygc, .table th.tinytable_css_pb11c9x3b2e71yml3ygc { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_4fmbzi26iitn5vxk5zzi, .table th.tinytable_css_4fmbzi26iitn5vxk5zzi { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } term df SumOfSqs R2 statistic p.value Elevation 1 0.1554514 0.03781666 0.6760498 0.940 Sampling_point 2 0.5060959 0.12311796 1.1004920 0.247 Residual 15 3.4491115 0.83906538 NA NA Total 18 4.1106588 1.00000000 NA NA adonis2(beta_div_phylo_sentein$S ~ Elevation+Sampling_point, data = sentein_transect %&gt;% arrange(match(sample,labels(beta_div_phylo_sentein$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() .table td.tinytable_css_mhisbfa9yh7g9t4nyuml, .table th.tinytable_css_mhisbfa9yh7g9t4nyuml { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_f6qui6yy0qwye9kp890r, .table th.tinytable_css_f6qui6yy0qwye9kp890r { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } term df SumOfSqs R2 statistic p.value Elevation 1 0.03937951 0.05281157 0.9762883 0.441 Sampling_point 2 0.10124193 0.13577482 1.2549840 0.250 Residual 15 0.60503914 0.81141361 NA NA Total 18 0.74566058 1.00000000 NA NA adonis2(beta_div_func_sentein$S ~ Elevation+Sampling_point, data = sentein_transect %&gt;% arrange(match(sample,labels(beta_div_func_sentein$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() .table td.tinytable_css_ojknwyicimj4j57erh17, .table th.tinytable_css_ojknwyicimj4j57erh17 { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_jj25s76rdr1zwp06a42h, .table th.tinytable_css_jj25s76rdr1zwp06a42h { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } term df SumOfSqs R2 statistic p.value Elevation 1 -0.002311796 -0.008131265 -0.1521548 0.767 Sampling_point 2 0.058715668 0.206520195 1.9322356 0.209 Residual 15 0.227905698 0.801611069 NA NA Total 18 0.284309569 1.000000000 NA NA 7.2.3.4 Tourmalet transect nrow(tourmalet_transect) [1] 27 beta_div_richness_tourmalet&lt;-hillpair(data=tourmalet_counts, q=0) beta_div_neutral_tourmalet&lt;-hillpair(data=tourmalet_counts, q=1) beta_div_phylo_tourmalet&lt;-hillpair(data=tourmalet_counts, q=1, tree=genome_tree) beta_div_func_tourmalet&lt;-hillpair(data=tourmalet_counts_func, q=1, dist=dist) adonis2(beta_div_richness_tourmalet$S ~ Elevation+Sampling_point, data = tourmalet_transect %&gt;% arrange(match(sample,labels(beta_div_richness_tourmalet$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() .table td.tinytable_css_j3z9alb34tyh41tkh6iy, .table th.tinytable_css_j3z9alb34tyh41tkh6iy { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_ai9jox5s91bsocgg3rll, .table th.tinytable_css_ai9jox5s91bsocgg3rll { border-bottom: solid #d3d8dc 0.1em; } term df SumOfSqs R2 statistic p.value Elevation 1 0.229323 0.03074583 0.8018768 0.806 Sampling_point 5 1.509691 0.20240752 1.0557914 0.305 Residual 20 5.719656 0.76684665 NA NA Total 26 7.458670 1.00000000 NA NA adonis2(beta_div_neutral_tourmalet$S ~ Elevation+Sampling_point, data = tourmalet_transect %&gt;% arrange(match(sample,labels(beta_div_neutral_tourmalet$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() .table td.tinytable_css_iw204tx7pd7mbdld9lzo, .table th.tinytable_css_iw204tx7pd7mbdld9lzo { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_53r1rgxsrf8n7ev2mmjv, .table th.tinytable_css_53r1rgxsrf8n7ev2mmjv { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } term df SumOfSqs R2 statistic p.value Elevation 1 0.2514516 0.03457337 0.8879356 0.574 Sampling_point 5 1.3577985 0.18669071 0.9589423 0.603 Residual 20 5.6637339 0.77873592 NA NA Total 26 7.2729840 1.00000000 NA NA adonis2(beta_div_phylo_tourmalet$S ~ Elevation+Sampling_point, data = tourmalet_transect %&gt;% arrange(match(sample,labels(beta_div_phylo_tourmalet$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() .table td.tinytable_css_trof4xeloqg4h1ob3keu, .table th.tinytable_css_trof4xeloqg4h1ob3keu { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_m5ghzt37qbwfgtpgxp7s, .table th.tinytable_css_m5ghzt37qbwfgtpgxp7s { border-bottom: solid #d3d8dc 0.1em; } term df SumOfSqs R2 statistic p.value Elevation 1 0.009061938 0.01136192 0.3098911 0.874 Sampling_point 5 0.203662250 0.25535321 1.3929278 0.185 Residual 20 0.584846551 0.73328486 NA NA Total 26 0.797570740 1.00000000 NA NA adonis2(beta_div_func_tourmalet$S ~ Elevation+Sampling_point, data = tourmalet_transect %&gt;% arrange(match(sample,labels(beta_div_func_tourmalet$S))), permutations = 999, by=&quot;terms&quot;) %&gt;% broom::tidy() %&gt;% tt() .table td.tinytable_css_tvlvutemskxy5igosrcj, .table th.tinytable_css_tvlvutemskxy5igosrcj { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_cbv7eh0039xh37n3gsh2, .table th.tinytable_css_cbv7eh0039xh37n3gsh2 { border-bottom: solid #d3d8dc 0.1em; } term df SumOfSqs R2 statistic p.value Elevation 1 0.03322215 0.1360046 3.6293609 0.143 Sampling_point 5 0.02797576 0.1145270 0.6112437 0.615 Residual 20 0.18307435 0.7494685 NA NA Total 26 0.24427226 1.0000000 NA NA 7.2.4 Beta diversity per transect (calculated from elevation chunks) Aisa_transect&lt;-sample_metadata %&gt;% filter(Transect==&quot;Aisa&quot;)%&gt;% column_to_rownames(&quot;EHI_number&quot;) Aran_transect&lt;-sample_metadata %&gt;% filter(Transect==&quot;Aran&quot;)%&gt;% column_to_rownames(&quot;EHI_number&quot;) sentein_transect&lt;-sample_metadata %&gt;% filter(Transect==&quot;Sentein&quot;)%&gt;% column_to_rownames(&quot;EHI_number&quot;) tourmalet_transect&lt;-sample_metadata %&gt;% filter(Transect==&quot;Tourmalet&quot;)%&gt;% column_to_rownames(&quot;EHI_number&quot;) 7.2.4.1 Aisa Aisa_transect_A&lt;-Aisa_transect %&gt;% filter(Elevation==&quot;1250&quot; | Elevation==&quot;1450&quot;) Aisa_counts_A &lt;- temp_genome_counts[, which(colnames(temp_genome_counts) %in% rownames(Aisa_transect_A))] identical(sort(colnames(Aisa_counts_A)), sort(as.character(rownames(Aisa_transect_A)))) Aisa_counts_func_A &lt;- temp_genome_counts_func[, which(colnames(temp_genome_counts_func) %in% rownames(Aisa_transect_A))] beta_div_richness_aisa_a&lt;-hillpair(data=Aisa_counts_A, q=0) beta_div_neutral_aisa_a&lt;-hillpair(data=Aisa_counts_A, q=1) beta_div_phylo_aisa_a&lt;-hillpair(data=Aisa_counts_A, q=1, tree=genome_tree) beta_div_func_aisa_a&lt;-hillpair(data=Aisa_counts_func_A, q=1, dist=dist) pairwise_richness&lt;-pairwise.adonis(beta_div_richness_aisa_a$S, Aisa_transect_A$Elevation, perm = 999) pairwise_richness%&gt;% tt() .table td.tinytable_css_ss73vcpikp5m0554dio8, .table th.tinytable_css_ss73vcpikp5m0554dio8 { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_167fyr8zx435zpbeg8q7, .table th.tinytable_css_167fyr8zx435zpbeg8q7 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1250 vs 1450 1 0.2626765 0.9085429 0.08328728 0.61 0.61 pairwise_neutral&lt;-pairwise.adonis(beta_div_neutral_aisa_a$S, Aisa_transect_A$Elevation, perm = 999) pairwise_neutral%&gt;% tt() .table td.tinytable_css_lz2w2jud7xkb81lis0bw, .table th.tinytable_css_lz2w2jud7xkb81lis0bw { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_0h7biyr42jrnucisu331, .table th.tinytable_css_0h7biyr42jrnucisu331 { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1250 vs 1450 1 0.205911 0.7420236 0.06907671 0.786 0.786 pairwise_phylo&lt;-pairwise.adonis(beta_div_phylo_aisa_a$S, Aisa_transect_A$Elevation, perm = 999) pairwise_phylo%&gt;% tt() .table td.tinytable_css_utaiz5cytoqdch4d1r3b, .table th.tinytable_css_utaiz5cytoqdch4d1r3b { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_lcze9zpkc56arq3fz9zl, .table th.tinytable_css_lcze9zpkc56arq3fz9zl { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1250 vs 1450 1 0.03022549 0.9572547 0.08736264 0.403 0.403 pairwise_function&lt;-pairwise.adonis(beta_div_func_aisa_a$S, Aisa_transect_A$Elevation, perm = 999) pairwise_function%&gt;% tt() .table td.tinytable_css_u4ojx0sb1tgcclqpxlft, .table th.tinytable_css_u4ojx0sb1tgcclqpxlft { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_oqthexemqidq7a0kuiwi, .table th.tinytable_css_oqthexemqidq7a0kuiwi { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1250 vs 1450 1 0.05213713 15.67096 0.6104547 0.022 0.022 . Aisa_transect_B&lt;-Aisa_transect %&gt;% filter(Elevation==&quot;1450&quot; | Elevation==&quot;1650&quot;) Aisa_counts_B &lt;- temp_genome_counts[, which(colnames(temp_genome_counts) %in% rownames(Aisa_transect_B))] identical(sort(colnames(Aisa_counts_B)), sort(as.character(rownames(Aisa_transect_B)))) Aisa_counts_func_B &lt;- temp_genome_counts_func[, which(colnames(temp_genome_counts_func) %in% rownames(Aisa_transect_B))] beta_div_richness_aisa_b&lt;-hillpair(data=Aisa_counts_B, q=0) beta_div_neutral_aisa_b&lt;-hillpair(data=Aisa_counts_B, q=1) beta_div_phylo_aisa_b&lt;-hillpair(data=Aisa_counts_B, q=1, tree=genome_tree) beta_div_func_aisa_b&lt;-hillpair(data=Aisa_counts_func_B, q=1, dist=dist) pairwise_richness&lt;-pairwise.adonis(beta_div_richness_aisa_b$S, Aisa_transect_B$Elevation, perm = 999) pairwise_richness%&gt;% tt() .table td.tinytable_css_qt05xbz46ru6bkrd8efs, .table th.tinytable_css_qt05xbz46ru6bkrd8efs { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_9esdctpcrgulruzp1fcp, .table th.tinytable_css_9esdctpcrgulruzp1fcp { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1650 vs 1450 1 0.322409 1.234999 0.1337302 0.132 0.132 pairwise_neutral&lt;-pairwise.adonis(beta_div_neutral_aisa_b$S, Aisa_transect_B$Elevation, perm = 999) pairwise_neutral%&gt;% tt() .table td.tinytable_css_umcuziewx9kqo65133q2, .table th.tinytable_css_umcuziewx9kqo65133q2 { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_pr3317fz3p7vxpo6owft, .table th.tinytable_css_pr3317fz3p7vxpo6owft { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1650 vs 1450 1 0.3147429 1.276347 0.1375915 0.158 0.158 pairwise_phylo&lt;-pairwise.adonis(beta_div_phylo_aisa_b$S, Aisa_transect_B$Elevation, perm = 999) pairwise_phylo%&gt;% tt() .table td.tinytable_css_nmczer2w1sw4828ssvu9, .table th.tinytable_css_nmczer2w1sw4828ssvu9 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_h93umy0mti9ol43ul7h7, .table th.tinytable_css_h93umy0mti9ol43ul7h7 { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1650 vs 1450 1 0.03829083 1.000862 0.1111963 0.41 0.41 pairwise_function&lt;-pairwise.adonis(beta_div_func_aisa_b$S, Aisa_transect_B$Elevation, perm = 999) pairwise_function%&gt;% tt() .table td.tinytable_css_yvpbwxgacl8wrxtrdakx, .table th.tinytable_css_yvpbwxgacl8wrxtrdakx { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_ku8z1fsy1dy596fi1pmb, .table th.tinytable_css_ku8z1fsy1dy596fi1pmb { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1650 vs 1450 1 -0.0006476495 -0.7015265 -0.09611962 0.949 0.949 Aisa_transect_C&lt;-Aisa_transect %&gt;% filter(Elevation==&quot;1650&quot; | Elevation==&quot;1850&quot;) Aisa_counts_C &lt;- temp_genome_counts[, which(colnames(temp_genome_counts) %in% rownames(Aisa_transect_C))] identical(sort(colnames(Aisa_counts_C)), sort(as.character(rownames(Aisa_transect_C)))) Aisa_counts_func_C &lt;- temp_genome_counts_func[, which(colnames(temp_genome_counts_func) %in% rownames(Aisa_transect_C))] beta_div_richness_aisa_c&lt;-hillpair(data=Aisa_counts_C, q=0) beta_div_neutral_aisa_c&lt;-hillpair(data=Aisa_counts_C, q=1) beta_div_phylo_aisa_c&lt;-hillpair(data=Aisa_counts_C, q=1, tree=genome_tree) beta_div_func_aisa_c&lt;-hillpair(data=Aisa_counts_func_C, q=1, dist=dist) pairwise_richness&lt;-pairwise.adonis(beta_div_richness_aisa_c$S, Aisa_transect_C$Elevation, perm = 999) pairwise_richness%&gt;% tt() .table td.tinytable_css_wcejrtziogzais29p72u, .table th.tinytable_css_wcejrtziogzais29p72u { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_4a8q3lzvehggf27gtwcb, .table th.tinytable_css_4a8q3lzvehggf27gtwcb { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1850 vs 1650 1 0.3306342 1.098944 0.1207771 0.289 0.289 pairwise_neutral&lt;-pairwise.adonis(beta_div_neutral_aisa_c$S, Aisa_transect_C$Elevation, perm = 999) pairwise_neutral%&gt;% tt() .table td.tinytable_css_qi6j9drknjvyzqnp8pcf, .table th.tinytable_css_qi6j9drknjvyzqnp8pcf { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_7djiu0l7f7aj068r3dlt, .table th.tinytable_css_7djiu0l7f7aj068r3dlt { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1850 vs 1650 1 0.3208236 1.107263 0.1215802 0.331 0.331 pairwise_phylo&lt;-pairwise.adonis(beta_div_phylo_aisa_c$S, Aisa_transect_C$Elevation, perm = 999) pairwise_phylo%&gt;% tt() .table td.tinytable_css_wxyyft0kk3n2q7k4k0nw, .table th.tinytable_css_wxyyft0kk3n2q7k4k0nw { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_3egw49swb5z47pzxfqrr, .table th.tinytable_css_3egw49swb5z47pzxfqrr { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1850 vs 1650 1 0.04691768 0.9322673 0.1043707 0.455 0.455 pairwise_function&lt;-pairwise.adonis(beta_div_func_aisa_c$S, Aisa_transect_C$Elevation, perm = 999) pairwise_function%&gt;% tt() .table td.tinytable_css_zp9zpbahk2jonsscr9b5, .table th.tinytable_css_zp9zpbahk2jonsscr9b5 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_f1ymg845s03skqe3fl34, .table th.tinytable_css_f1ymg845s03skqe3fl34 { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1850 vs 1650 1 0.01333288 5.226801 0.3951675 0.126 0.126 7.2.4.2 Aran Aran_transect_A&lt;-Aran_transect %&gt;% filter(Elevation==&quot;1000&quot; | Elevation==&quot;1080&quot;) Aran_counts_A &lt;- temp_genome_counts[, which(colnames(temp_genome_counts) %in% rownames(Aran_transect_A))] identical(sort(colnames(Aran_counts_A)), sort(as.character(rownames(Aran_transect_A)))) Aran_counts_func_A &lt;- temp_genome_counts_func[, which(colnames(temp_genome_counts_func) %in% rownames(Aran_transect_A))] beta_div_richness_aran_a&lt;-hillpair(data=Aran_counts_A, q=0) beta_div_neutral_aran_a&lt;-hillpair(data=Aran_counts_A, q=1) beta_div_phylo_aran_a&lt;-hillpair(data=Aran_counts_A, q=1, tree=genome_tree) beta_div_func_aran_a&lt;-hillpair(data=Aran_counts_func_A, q=1, dist=dist) pairwise_richness&lt;-pairwise.adonis(beta_div_richness_aran_a$S, Aran_transect_A$Elevation, perm = 999) pairwise_richness%&gt;% tt() .table td.tinytable_css_r7cdx57xcjdgykug5m5f, .table th.tinytable_css_r7cdx57xcjdgykug5m5f { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_a5pzgwtyxfi2yfap5lig, .table th.tinytable_css_a5pzgwtyxfi2yfap5lig { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1000 vs 1080 1 0.4399253 1.257032 0.102556 0.082 0.082 pairwise_neutral&lt;-pairwise.adonis(beta_div_neutral_aran_a$S, Aran_transect_A$Elevation, perm = 999) pairwise_neutral%&gt;% tt() .table td.tinytable_css_i25inxz7ohdxm1tbrhte, .table th.tinytable_css_i25inxz7ohdxm1tbrhte { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_7t4fxn9kkptix826zrqu, .table th.tinytable_css_7t4fxn9kkptix826zrqu { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1000 vs 1080 1 0.4180778 1.29339 0.1052102 0.129 0.129 pairwise_phylo&lt;-pairwise.adonis(beta_div_phylo_aran_a$S, Aran_transect_A$Elevation, perm = 999) pairwise_phylo%&gt;% tt() .table td.tinytable_css_xt0l13iw9zuepercjg1r, .table th.tinytable_css_xt0l13iw9zuepercjg1r { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_w2gxtc0zq5v2nh00ricq, .table th.tinytable_css_w2gxtc0zq5v2nh00ricq { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1000 vs 1080 1 0.1138336 2.350583 0.1760659 0.04 0.04 . pairwise_function&lt;-pairwise.adonis(beta_div_func_aran_a$S, Aran_transect_A$Elevation, perm = 999) pairwise_function%&gt;% tt() .table td.tinytable_css_vgeoceqsqj7vx6lw68ur, .table th.tinytable_css_vgeoceqsqj7vx6lw68ur { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_t1lw1mtc5l9xurcwcpl7, .table th.tinytable_css_t1lw1mtc5l9xurcwcpl7 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1000 vs 1080 1 0.003088474 0.1857484 0.01660581 0.554 0.554 Aran_transect_B&lt;-Aran_transect %&gt;% filter(Elevation==&quot;1080&quot; | Elevation==&quot;1340&quot;) Aran_counts_B &lt;- temp_genome_counts[, which(colnames(temp_genome_counts) %in% rownames(Aran_transect_B))] identical(sort(colnames(Aran_counts_B)), sort(as.character(rownames(Aran_transect_B)))) Aran_counts_func_B &lt;- temp_genome_counts_func[, which(colnames(temp_genome_counts_func) %in% rownames(Aran_transect_B))] beta_div_richness_aran_b&lt;-hillpair(data=Aran_counts_B, q=0) beta_div_neutral_aran_b&lt;-hillpair(data=Aran_counts_B, q=1) beta_div_phylo_aran_b&lt;-hillpair(data=Aran_counts_B, q=1, tree=genome_tree) beta_div_func_aran_b&lt;-hillpair(data=Aran_counts_func_B, q=1, dist=dist) pairwise_richness&lt;-pairwise.adonis(beta_div_richness_aran_b$S, Aran_transect_B$Elevation, perm = 999) pairwise_richness%&gt;% tt() .table td.tinytable_css_qz2sivfuv32dt30ed2l0, .table th.tinytable_css_qz2sivfuv32dt30ed2l0 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_jhycd6qybblj3hf77r0j, .table th.tinytable_css_jhycd6qybblj3hf77r0j { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1080 vs 1340 1 0.3426159 1.032388 0.09357793 0.353 0.353 pairwise_neutral&lt;-pairwise.adonis(beta_div_neutral_aran_b$S, Aran_transect_B$Elevation, perm = 999) pairwise_neutral%&gt;% tt() .table td.tinytable_css_suwcyca7anmsbvtoa4qi, .table th.tinytable_css_suwcyca7anmsbvtoa4qi { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_d6i78kljth0di12rv327, .table th.tinytable_css_d6i78kljth0di12rv327 { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1080 vs 1340 1 0.2835171 0.9218617 0.08440518 0.6 0.6 pairwise_phylo&lt;-pairwise.adonis(beta_div_phylo_aran_b$S, Aran_transect_B$Elevation, perm = 999) pairwise_phylo%&gt;% tt() .table td.tinytable_css_h0wz4hqbjzvczdwq6hva, .table th.tinytable_css_h0wz4hqbjzvczdwq6hva { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_a73975n4nfqo9zhmn3ni, .table th.tinytable_css_a73975n4nfqo9zhmn3ni { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1080 vs 1340 1 0.02603738 0.6726394 0.06302465 0.708 0.708 pairwise_function&lt;-pairwise.adonis(beta_div_func_aran_b$S, Aran_transect_B$Elevation, perm = 999) pairwise_function%&gt;% tt() .table td.tinytable_css_p9f5hql32slya5yq45i4, .table th.tinytable_css_p9f5hql32slya5yq45i4 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_b702aobzfwgiv0tll5bw, .table th.tinytable_css_b702aobzfwgiv0tll5bw { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1080 vs 1340 1 -0.01035184 -0.4224352 -0.04410675 0.892 0.892 Aran_transect_C&lt;-Aran_transect %&gt;% filter(Elevation==&quot;1340&quot; | Elevation==&quot;1500&quot;) Aran_counts_C &lt;- temp_genome_counts[, which(colnames(temp_genome_counts) %in% rownames(Aran_transect_C))] identical(sort(colnames(Aran_counts_C)), sort(as.character(rownames(Aran_transect_C)))) Aran_counts_func_C &lt;- temp_genome_counts_func[, which(colnames(temp_genome_counts_func) %in% rownames(Aran_transect_C))] beta_div_richness_aran_c&lt;-hillpair(data=Aran_counts_C, q=0) beta_div_neutral_aran_c&lt;-hillpair(data=Aran_counts_C, q=1) beta_div_phylo_aran_c&lt;-hillpair(data=Aran_counts_C, q=1, tree=genome_tree) beta_div_func_aran_c&lt;-hillpair(data=Aran_counts_func_C, q=1, dist=dist) pairwise_richness&lt;-pairwise.adonis(beta_div_richness_aran_c$S, Aran_transect_C$Elevation, perm = 999) pairwise_richness%&gt;% tt() .table td.tinytable_css_ulfgdvjmsbnpk95tpvyj, .table th.tinytable_css_ulfgdvjmsbnpk95tpvyj { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_gauckr4fv2zuvywb7mdb, .table th.tinytable_css_gauckr4fv2zuvywb7mdb { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1340 vs 1500 1 0.3974944 1.494702 0.1424245 0.034 0.034 . pairwise_neutral&lt;-pairwise.adonis(beta_div_neutral_aran_c$S, Aran_transect_C$Elevation, perm = 999) pairwise_neutral%&gt;% tt() .table td.tinytable_css_z9w3grt53hzbg1aypi05, .table th.tinytable_css_z9w3grt53hzbg1aypi05 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_9y1q3ajw4b1hwdhaol9v, .table th.tinytable_css_9y1q3ajw4b1hwdhaol9v { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1340 vs 1500 1 0.4263047 1.779751 0.1651013 0.032 0.032 . pairwise_phylo&lt;-pairwise.adonis(beta_div_phylo_aran_c$S, Aran_transect_C$Elevation, perm = 999) pairwise_phylo%&gt;% tt() .table td.tinytable_css_s2ug6qgu0jotgf4za5oo, .table th.tinytable_css_s2ug6qgu0jotgf4za5oo { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_jvj9aeznup4kci1va6oz, .table th.tinytable_css_jvj9aeznup4kci1va6oz { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1340 vs 1500 1 0.0530972 1.513068 0.1439226 0.173 0.173 pairwise_function&lt;-pairwise.adonis(beta_div_func_aran_c$S, Aran_transect_C$Elevation, perm = 999) pairwise_function%&gt;% tt() .table td.tinytable_css_iql49qn4vlhqe7uega43, .table th.tinytable_css_iql49qn4vlhqe7uega43 { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_90a69n5avi3r9io162mm, .table th.tinytable_css_90a69n5avi3r9io162mm { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1340 vs 1500 1 8.811806e-05 0.005930486 0.000658509 0.682 0.682 Aran_transect_D&lt;-Aran_transect %&gt;% filter(Elevation==&quot;1500&quot; | Elevation==&quot;1650&quot;) Aran_counts_D &lt;- temp_genome_counts[, which(colnames(temp_genome_counts) %in% rownames(Aran_transect_D))] identical(sort(colnames(Aran_counts_D)), sort(as.character(rownames(Aran_transect_D)))) Aran_counts_func_D &lt;- temp_genome_counts_func[, which(colnames(temp_genome_counts_func) %in% rownames(Aran_transect_D))] beta_div_richness_aran_d&lt;-hillpair(data=Aran_counts_D, q=0) beta_div_neutral_aran_d&lt;-hillpair(data=Aran_counts_D, q=1) beta_div_phylo_aran_d&lt;-hillpair(data=Aran_counts_D, q=1, tree=genome_tree) beta_div_func_aran_d&lt;-hillpair(data=Aran_counts_func_D, q=1, dist=dist) pairwise_richness&lt;-pairwise.adonis(beta_div_richness_aran_d$S, Aran_transect_D$Elevation, perm = 999) pairwise_richness%&gt;% tt() .table td.tinytable_css_ya0n52zzjx4mw9ge1jbq, .table th.tinytable_css_ya0n52zzjx4mw9ge1jbq { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_mic9hg8lkeu5vhy4gb8m, .table th.tinytable_css_mic9hg8lkeu5vhy4gb8m { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1500 vs 1650 1 0.3801772 1.180411 0.09691058 0.222 0.222 pairwise_neutral&lt;-pairwise.adonis(beta_div_neutral_aran_d$S, Aran_transect_D$Elevation, perm = 999) pairwise_neutral%&gt;% tt() .table td.tinytable_css_nsbqq12uhse884pkcw36, .table th.tinytable_css_nsbqq12uhse884pkcw36 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_5waug764dijly0ab0vrh, .table th.tinytable_css_5waug764dijly0ab0vrh { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1500 vs 1650 1 0.3358507 1.08791 0.08999982 0.375 0.375 pairwise_phylo&lt;-pairwise.adonis(beta_div_phylo_aran_d$S, Aran_transect_D$Elevation, perm = 999) pairwise_phylo%&gt;% tt() .table td.tinytable_css_v0sihwedie3eh3lnz8ql, .table th.tinytable_css_v0sihwedie3eh3lnz8ql { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_o9z731jbwruyu1wpk4m0, .table th.tinytable_css_o9z731jbwruyu1wpk4m0 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1500 vs 1650 1 0.03400172 0.3717977 0.03269472 0.891 0.891 pairwise_function&lt;-pairwise.adonis(beta_div_func_aran_d$S, Aran_transect_D$Elevation, perm = 999) pairwise_function%&gt;% tt() .table td.tinytable_css_utk5z4mdk4uomvaip6fv, .table th.tinytable_css_utk5z4mdk4uomvaip6fv { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_tpn1orpc5pcsi646l4dk, .table th.tinytable_css_tpn1orpc5pcsi646l4dk { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1500 vs 1650 1 0.006957227 0.4858836 0.04230268 0.459 0.459 Aran_transect_E&lt;-Aran_transect %&gt;% filter(Elevation==&quot;1650&quot; | Elevation==&quot;1850&quot;) Aran_counts_E &lt;- temp_genome_counts[, which(colnames(temp_genome_counts) %in% rownames(Aran_transect_E))] identical(sort(colnames(Aran_counts_E)), sort(as.character(rownames(Aran_transect_E)))) Aran_counts_func_E &lt;- temp_genome_counts_func[, which(colnames(temp_genome_counts_func) %in% rownames(Aran_transect_E))] beta_div_richness_aran_e&lt;-hillpair(data=Aran_counts_E, q=0) beta_div_neutral_aran_e&lt;-hillpair(data=Aran_counts_E, q=1) beta_div_phylo_aran_e&lt;-hillpair(data=Aran_counts_E, q=1, tree=genome_tree) beta_div_func_aran_e&lt;-hillpair(data=Aran_counts_func_E, q=1, dist=dist) pairwise_richness&lt;-pairwise.adonis(beta_div_richness_aran_e$S, Aran_transect_E$Elevation, perm = 999) pairwise_richness%&gt;% tt() .table td.tinytable_css_eho7mrxu2k7fzb58spsr, .table th.tinytable_css_eho7mrxu2k7fzb58spsr { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_eg8prtvqm82e1of68fc8, .table th.tinytable_css_eg8prtvqm82e1of68fc8 { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1850 vs 1650 1 0.3150829 0.9879386 0.08241105 0.495 0.495 pairwise_neutral&lt;-pairwise.adonis(beta_div_neutral_aran_e$S, Aran_transect_E$Elevation, perm = 999) pairwise_neutral%&gt;% tt() .table td.tinytable_css_u4t8g06tvt4m5pgezr07, .table th.tinytable_css_u4t8g06tvt4m5pgezr07 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_ef60q7naxudfxaw763pb, .table th.tinytable_css_ef60q7naxudfxaw763pb { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1850 vs 1650 1 0.3152862 1.058369 0.0877705 0.387 0.387 pairwise_phylo&lt;-pairwise.adonis(beta_div_phylo_aran_e$S, Aran_transect_E$Elevation, perm = 999) pairwise_phylo%&gt;% tt() .table td.tinytable_css_m5gbgvwclc737u3r39bl, .table th.tinytable_css_m5gbgvwclc737u3r39bl { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_iaq89h09ef2ump40a8p8, .table th.tinytable_css_iaq89h09ef2ump40a8p8 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1850 vs 1650 1 0.1292245 1.874665 0.1456089 0.076 0.076 pairwise_function&lt;-pairwise.adonis(beta_div_func_aran_e$S, Aran_transect_E$Elevation, perm = 999) pairwise_function%&gt;% tt() .table td.tinytable_css_c6lmyyj9dyska0zfx3t2, .table th.tinytable_css_c6lmyyj9dyska0zfx3t2 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_69tjcl655fu3x83g4o5r, .table th.tinytable_css_69tjcl655fu3x83g4o5r { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1850 vs 1650 1 0.01232692 1.051678 0.08726405 0.331 0.331 7.2.4.3 Sentein sentein_transect_A&lt;-sentein_transect %&gt;% filter(Elevation==&quot;941&quot; | Elevation==&quot;1260&quot;) sentein_counts_A &lt;- temp_genome_counts[, which(colnames(temp_genome_counts) %in% rownames(sentein_transect_A))] identical(sort(colnames(sentein_counts_A)), sort(as.character(rownames(sentein_transect_A)))) sentein_counts_func_A &lt;- temp_genome_counts_func[, which(colnames(temp_genome_counts_func) %in% rownames(sentein_transect_A))] beta_div_richness_sentein_a&lt;-hillpair(data=sentein_counts_A, q=0) beta_div_neutral_sentein_a&lt;-hillpair(data=sentein_counts_A, q=1) beta_div_phylo_sentein_a&lt;-hillpair(data=sentein_counts_A, q=1, tree=genome_tree) beta_div_func_sentein_a&lt;-hillpair(data=sentein_counts_func_A, q=1, dist=dist) pairwise_richness&lt;-pairwise.adonis(beta_div_richness_sentein_a$S, sentein_transect_A$Elevation, perm = 999) pairwise_richness%&gt;% tt() .table td.tinytable_css_g9kmzx8qyhatit5q61qu, .table th.tinytable_css_g9kmzx8qyhatit5q61qu { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_6z1gsvgosut6k19hkzfe, .table th.tinytable_css_6z1gsvgosut6k19hkzfe { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1260 vs 941 1 0.2220232 0.8655907 0.1100478 0.795 0.795 pairwise_neutral&lt;-pairwise.adonis(beta_div_neutral_sentein_a$S, sentein_transect_A$Elevation, perm = 999) pairwise_neutral%&gt;% tt() .table td.tinytable_css_njwb3m4y3xlz27pwxgs3, .table th.tinytable_css_njwb3m4y3xlz27pwxgs3 { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_dxwuzo07wpcpkr517a3t, .table th.tinytable_css_dxwuzo07wpcpkr517a3t { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1260 vs 941 1 0.2450095 0.9832881 0.1231683 0.45 0.45 pairwise_phylo&lt;-pairwise.adonis(beta_div_phylo_sentein_a$S, sentein_transect_A$Elevation, perm = 999) pairwise_phylo%&gt;% tt() .table td.tinytable_css_yb3lo83fkc9usgd572m5, .table th.tinytable_css_yb3lo83fkc9usgd572m5 { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_46ool5on2f1bem4hacw5, .table th.tinytable_css_46ool5on2f1bem4hacw5 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1260 vs 941 1 0.04091181 0.7601416 0.0979546 0.705 0.705 pairwise_function&lt;-pairwise.adonis(beta_div_func_sentein_a$S, sentein_transect_A$Elevation, perm = 999) pairwise_function%&gt;% tt() .table td.tinytable_css_m12tut3fea7sailwf4lk, .table th.tinytable_css_m12tut3fea7sailwf4lk { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_8qmqk39p2o8ai8qj86kb, .table th.tinytable_css_8qmqk39p2o8ai8qj86kb { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1260 vs 941 1 0.01125329 0.67593 0.08805838 0.472 0.472 sentein_transect_B&lt;-sentein_transect %&gt;% filter(Elevation==&quot;1260&quot; | Elevation==&quot;1628&quot;) sentein_counts_B &lt;- temp_genome_counts[, which(colnames(temp_genome_counts) %in% rownames(sentein_transect_B))] identical(sort(colnames(sentein_counts_B)), sort(as.character(rownames(sentein_transect_B)))) sentein_counts_func_B &lt;- temp_genome_counts_func[, which(colnames(temp_genome_counts_func) %in% rownames(sentein_transect_B))] beta_div_richness_sentein_b&lt;-hillpair(data=sentein_counts_B, q=0) beta_div_neutral_sentein_b&lt;-hillpair(data=sentein_counts_B, q=1) beta_div_phylo_sentein_b&lt;-hillpair(data=sentein_counts_B, q=1, tree=genome_tree) beta_div_func_sentein_b&lt;-hillpair(data=sentein_counts_func_B, q=1, dist=dist) pairwise_richness&lt;-pairwise.adonis(beta_div_richness_sentein_b$S, sentein_transect_B$Elevation, perm = 999) pairwise_richness%&gt;% tt() .table td.tinytable_css_wcuhnervsuty7hxgq5hd, .table th.tinytable_css_wcuhnervsuty7hxgq5hd { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_4xi2v3q121g3710tsn0e, .table th.tinytable_css_4xi2v3q121g3710tsn0e { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1628 vs 1260 1 0.169041 0.7428071 0.09593512 0.943 0.943 pairwise_neutral&lt;-pairwise.adonis(beta_div_neutral_sentein_b$S, sentein_transect_B$Elevation, perm = 999) pairwise_neutral%&gt;% tt() .table td.tinytable_css_yc1vm1thjacpl72qn0qd, .table th.tinytable_css_yc1vm1thjacpl72qn0qd { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_dqfk0kcaldwl9gkv34r5, .table th.tinytable_css_dqfk0kcaldwl9gkv34r5 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1628 vs 1260 1 0.1651737 0.865036 0.109985 0.69 0.69 pairwise_phylo&lt;-pairwise.adonis(beta_div_phylo_sentein_b$S, sentein_transect_B$Elevation, perm = 999) pairwise_phylo%&gt;% tt() .table td.tinytable_css_gb4cb0r6ad58p6k86fg7, .table th.tinytable_css_gb4cb0r6ad58p6k86fg7 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_6msrtf55crp5u86pnyd7, .table th.tinytable_css_6msrtf55crp5u86pnyd7 { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1628 vs 1260 1 0.04655198 1.618378 0.1877822 0.199 0.199 pairwise_function&lt;-pairwise.adonis(beta_div_func_sentein_b$S, sentein_transect_B$Elevation, perm = 999) pairwise_function%&gt;% tt() .table td.tinytable_css_ujte9iw4bcjo9mo9lkqo, .table th.tinytable_css_ujte9iw4bcjo9mo9lkqo { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_72qr3bji1y2vlbkg4nuq, .table th.tinytable_css_72qr3bji1y2vlbkg4nuq { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1628 vs 1260 1 -0.0009540533 -0.03901141 -0.005604292 0.726 0.726 sentein_transect_C&lt;-sentein_transect %&gt;% filter(Elevation==&quot;1628&quot; | Elevation==&quot;1873&quot;) sentein_counts_C &lt;- temp_genome_counts[, which(colnames(temp_genome_counts) %in% rownames(sentein_transect_C))] identical(sort(colnames(sentein_counts_C)), sort(as.character(rownames(sentein_transect_C)))) sentein_counts_func_C &lt;- temp_genome_counts_func[, which(colnames(temp_genome_counts_func) %in% rownames(sentein_transect_C))] beta_div_richness_sentein_c&lt;-hillpair(data=sentein_counts_C, q=0) beta_div_neutral_sentein_c&lt;-hillpair(data=sentein_counts_C, q=1) beta_div_phylo_sentein_c&lt;-hillpair(data=sentein_counts_C, q=1, tree=genome_tree) beta_div_func_sentein_c&lt;-hillpair(data=sentein_counts_func_C, q=1, dist=dist) pairwise_richness&lt;-pairwise.adonis(beta_div_richness_sentein_c$S, sentein_transect_C$Elevation, perm = 999) pairwise_richness%&gt;% tt() .table td.tinytable_css_blgqpv4yah3e8kwcxx93, .table th.tinytable_css_blgqpv4yah3e8kwcxx93 { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_1a0cbn4n0t8cm8qrmo82, .table th.tinytable_css_1a0cbn4n0t8cm8qrmo82 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1873 vs 1628 1 0.2381664 1.140159 0.1247417 0.219 0.219 pairwise_neutral&lt;-pairwise.adonis(beta_div_neutral_sentein_c$S, sentein_transect_C$Elevation, perm = 999) pairwise_neutral%&gt;% tt() .table td.tinytable_css_835rz7mgc0wn0kfpjqg7, .table th.tinytable_css_835rz7mgc0wn0kfpjqg7 { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_1lfkwi0ct2ts71kgaq92, .table th.tinytable_css_1lfkwi0ct2ts71kgaq92 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1873 vs 1628 1 0.2203909 1.138567 0.1245892 0.272 0.272 pairwise_phylo&lt;-pairwise.adonis(beta_div_phylo_sentein_c$S, sentein_transect_C$Elevation, perm = 999) pairwise_phylo%&gt;% tt() .table td.tinytable_css_rraph3k0pvuxxrpn9d0b, .table th.tinytable_css_rraph3k0pvuxxrpn9d0b { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_2gnau0m1w6fo27phjibe, .table th.tinytable_css_2gnau0m1w6fo27phjibe { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1873 vs 1628 1 0.05315167 2.40143 0.230875 0.052 0.052 pairwise_function&lt;-pairwise.adonis(beta_div_func_sentein_c$S, sentein_transect_C$Elevation, perm = 999) pairwise_function%&gt;% tt() .table td.tinytable_css_sira95dorl4ukwro4gfa, .table th.tinytable_css_sira95dorl4ukwro4gfa { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_7j2z3ubupp9wfxrq3ina, .table th.tinytable_css_7j2z3ubupp9wfxrq3ina { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1873 vs 1628 1 0.03251904 2.128368 0.2101393 0.28 0.28 7.2.4.4 Tourmalet tourmalet_transect_A&lt;-tourmalet_transect %&gt;% filter(Elevation==&quot;953&quot; | Elevation==&quot;1255&quot;) tourmalet_counts_A &lt;- temp_genome_counts[, which(colnames(temp_genome_counts) %in% rownames(tourmalet_transect_A))] identical(sort(colnames(tourmalet_counts_A)), sort(as.character(rownames(tourmalet_transect_A)))) tourmalet_counts_func_A &lt;- temp_genome_counts_func[, which(colnames(temp_genome_counts_func) %in% rownames(tourmalet_transect_A))] beta_div_richness_tourmalet_a&lt;-hillpair(data=tourmalet_counts_A, q=0) beta_div_neutral_tourmalet_a&lt;-hillpair(data=tourmalet_counts_A, q=1) beta_div_phylo_tourmalet_a&lt;-hillpair(data=tourmalet_counts_A, q=1, tree=genome_tree) beta_div_func_tourmalet_a&lt;-hillpair(data=tourmalet_counts_func_A, q=1, dist=dist) pairwise_richness&lt;-pairwise.adonis(beta_div_richness_tourmalet_a$S, tourmalet_transect_A$Elevation, perm = 999) pairwise_richness%&gt;% tt() .table td.tinytable_css_f30urci2upny9nyhfr8z, .table th.tinytable_css_f30urci2upny9nyhfr8z { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_92cwax35ems0yluqrush, .table th.tinytable_css_92cwax35ems0yluqrush { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1255 vs 953 1 0.3360333 1.196783 0.1460065 0.231 0.231 pairwise_neutral&lt;-pairwise.adonis(beta_div_neutral_tourmalet_a$S, tourmalet_transect_A$Elevation, perm = 999) pairwise_neutral%&gt;% tt() .table td.tinytable_css_yet3uxzmssq286d75s8c, .table th.tinytable_css_yet3uxzmssq286d75s8c { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_ahii0lm3cva19op62l69, .table th.tinytable_css_ahii0lm3cva19op62l69 { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1255 vs 953 1 0.4120948 1.575267 0.1836989 0.107 0.107 pairwise_phylo&lt;-pairwise.adonis(beta_div_phylo_tourmalet_a$S, tourmalet_transect_A$Elevation, perm = 999) pairwise_phylo%&gt;% tt() .table td.tinytable_css_lqzh7c5uk4x5xhujioum, .table th.tinytable_css_lqzh7c5uk4x5xhujioum { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_jvrnk63vxu2h153e3wjy, .table th.tinytable_css_jvrnk63vxu2h153e3wjy { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1255 vs 953 1 0.04279699 1.593966 0.1854751 0.196 0.196 pairwise_function&lt;-pairwise.adonis(beta_div_func_tourmalet_a$S, tourmalet_transect_A$Elevation, perm = 999) pairwise_function%&gt;% tt() .table td.tinytable_css_8s2slbwarrexwsocwf6o, .table th.tinytable_css_8s2slbwarrexwsocwf6o { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_8q0wogx79qjy8ax5ekow, .table th.tinytable_css_8q0wogx79qjy8ax5ekow { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1255 vs 953 1 0.04080714 4.644583 0.3988621 0.144 0.144 tourmalet_transect_B&lt;-tourmalet_transect %&gt;% filter(Elevation==&quot;1255&quot; | Elevation==&quot;1561&quot;) tourmalet_counts_B &lt;- temp_genome_counts[, which(colnames(temp_genome_counts) %in% rownames(tourmalet_transect_B))] identical(sort(colnames(tourmalet_counts_B)), sort(as.character(rownames(tourmalet_transect_B)))) tourmalet_counts_func_B &lt;- temp_genome_counts_func[, which(colnames(temp_genome_counts_func) %in% rownames(tourmalet_transect_B))] beta_div_richness_tourmalet_b&lt;-hillpair(data=tourmalet_counts_B, q=0) beta_div_neutral_tourmalet_b&lt;-hillpair(data=tourmalet_counts_B, q=1) beta_div_phylo_tourmalet_b&lt;-hillpair(data=tourmalet_counts_B, q=1, tree=genome_tree) beta_div_func_tourmalet_b&lt;-hillpair(data=tourmalet_counts_func_B, q=1, dist=dist) pairwise_richness&lt;-pairwise.adonis(beta_div_richness_tourmalet_b$S, tourmalet_transect_B$Elevation, perm = 999) pairwise_richness%&gt;% tt() .table td.tinytable_css_i1tvpzsp41rk872j7085, .table th.tinytable_css_i1tvpzsp41rk872j7085 { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_7dq3wfhj2oiru32vlhxc, .table th.tinytable_css_7dq3wfhj2oiru32vlhxc { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1561 vs 1255 1 0.2054132 0.9664775 0.1387326 0.562 0.562 pairwise_neutral&lt;-pairwise.adonis(beta_div_neutral_tourmalet_b$S, tourmalet_transect_B$Elevation, perm = 999) pairwise_neutral%&gt;% tt() .table td.tinytable_css_ni3vpk7zqozu9t3xadmv, .table th.tinytable_css_ni3vpk7zqozu9t3xadmv { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_dbugpx085uvkhi3b3suw, .table th.tinytable_css_dbugpx085uvkhi3b3suw { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1561 vs 1255 1 0.1959341 0.954098 0.1371994 0.531 0.531 pairwise_phylo&lt;-pairwise.adonis(beta_div_phylo_tourmalet_b$S, tourmalet_transect_B$Elevation, perm = 999) pairwise_phylo%&gt;% tt() .table td.tinytable_css_n38trnkrhu8xi0wx18qx, .table th.tinytable_css_n38trnkrhu8xi0wx18qx { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_hp4guhktsavcl2a64gec, .table th.tinytable_css_hp4guhktsavcl2a64gec { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1561 vs 1255 1 0.008290319 0.5230836 0.08018962 0.84 0.84 pairwise_function&lt;-pairwise.adonis(beta_div_func_tourmalet_b$S, tourmalet_transect_B$Elevation, perm = 999) pairwise_function%&gt;% tt() .table td.tinytable_css_q5oldis9k2pp2c58r47v, .table th.tinytable_css_q5oldis9k2pp2c58r47v { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_n9ivz798qmyqh5tir9vb, .table th.tinytable_css_n9ivz798qmyqh5tir9vb { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1561 vs 1255 1 0.0233716 37.50819 0.8620949 0.025 0.025 . tourmalet_transect_C&lt;-tourmalet_transect %&gt;% filter(Elevation==&quot;1561&quot; | Elevation==&quot;1797&quot;) tourmalet_counts_C &lt;- temp_genome_counts[, which(colnames(temp_genome_counts) %in% rownames(tourmalet_transect_C))] identical(sort(colnames(tourmalet_counts_C)), sort(as.character(rownames(tourmalet_transect_C)))) tourmalet_counts_func_C &lt;- temp_genome_counts_func[, which(colnames(temp_genome_counts_func) %in% rownames(tourmalet_transect_C))] beta_div_richness_tourmalet_c&lt;-hillpair(data=tourmalet_counts_C, q=0) beta_div_neutral_tourmalet_c&lt;-hillpair(data=tourmalet_counts_C, q=1) beta_div_phylo_tourmalet_c&lt;-hillpair(data=tourmalet_counts_C, q=1, tree=genome_tree) beta_div_func_tourmalet_c&lt;-hillpair(data=tourmalet_counts_func_C, q=1, dist=dist) pairwise_richness&lt;-pairwise.adonis(beta_div_richness_tourmalet_c$S, tourmalet_transect_C$Elevation, perm = 999) pairwise_richness%&gt;% tt() .table td.tinytable_css_z50gu0k0mrjv399rvv0a, .table th.tinytable_css_z50gu0k0mrjv399rvv0a { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_kcgh7oeeedjwbl6x0z9l, .table th.tinytable_css_kcgh7oeeedjwbl6x0z9l { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1797 vs 1561 1 0.2161833 0.6751472 0.1011434 0.938 0.938 pairwise_neutral&lt;-pairwise.adonis(beta_div_neutral_tourmalet_c$S, tourmalet_transect_C$Elevation, perm = 999) pairwise_neutral%&gt;% tt() .table td.tinytable_css_mvke2rr3bsc8dyt2nt8r, .table th.tinytable_css_mvke2rr3bsc8dyt2nt8r { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_hm3x4f0bgempsh5s1k51, .table th.tinytable_css_hm3x4f0bgempsh5s1k51 { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1797 vs 1561 1 0.202558 0.6044924 0.09152746 0.966 0.966 pairwise_phylo&lt;-pairwise.adonis(beta_div_phylo_tourmalet_c$S, tourmalet_transect_C$Elevation, perm = 999) pairwise_phylo%&gt;% tt() .table td.tinytable_css_j4qjr8ysvuyoa3pcr7al, .table th.tinytable_css_j4qjr8ysvuyoa3pcr7al { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_07eaemqfpnlyt0czgv8c, .table th.tinytable_css_07eaemqfpnlyt0czgv8c { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1797 vs 1561 1 0.02728025 0.7123385 0.1061237 0.639 0.639 pairwise_function&lt;-pairwise.adonis(beta_div_func_tourmalet_c$S, tourmalet_transect_C$Elevation, perm = 999) pairwise_function%&gt;% tt() .table td.tinytable_css_xn8alhiukzizmj5gbgx5, .table th.tinytable_css_xn8alhiukzizmj5gbgx5 { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_h471w29mza3n32epiqew, .table th.tinytable_css_h471w29mza3n32epiqew { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 1797 vs 1561 1 0.0423273 3.640061 0.3775973 0.12 0.12 tourmalet_transect_D&lt;-tourmalet_transect %&gt;% filter(Elevation==&quot;1797&quot; | Elevation==&quot;2065&quot;| Elevation==&quot;2134&quot;) tourmalet_counts_D &lt;- temp_genome_counts[, which(colnames(temp_genome_counts) %in% rownames(tourmalet_transect_D))] identical(sort(colnames(tourmalet_counts_D)), sort(as.character(rownames(tourmalet_transect_D)))) tourmalet_counts_func_D &lt;- temp_genome_counts_func[, which(colnames(temp_genome_counts_func) %in% rownames(tourmalet_transect_D))] beta_div_richness_tourmalet_d&lt;-hillpair(data=tourmalet_counts_D, q=0) beta_div_neutral_tourmalet_d&lt;-hillpair(data=tourmalet_counts_D, q=1) beta_div_phylo_tourmalet_d&lt;-hillpair(data=tourmalet_counts_D, q=1, tree=genome_tree) beta_div_func_tourmalet_d&lt;-hillpair(data=tourmalet_counts_func_D, q=1, dist=dist) pairwise_richness&lt;-pairwise.adonis(beta_div_richness_tourmalet_d$S, tourmalet_transect_D$Elevation, perm = 999) FALSE &#39;nperm&#39; &gt;= set of all permutations: complete enumeration. FALSE Set of permutations &lt; &#39;minperm&#39;. Generating entire set. FALSE &#39;nperm&#39; &gt;= set of all permutations: complete enumeration. FALSE Set of permutations &lt; &#39;minperm&#39;. Generating entire set. FALSE Set of permutations &lt; &#39;minperm&#39;. Generating entire set. pairwise_richness%&gt;% tt() .table td.tinytable_css_nch1k9k5ujf9wjc83u6b, .table th.tinytable_css_nch1k9k5ujf9wjc83u6b { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_gjiyuz38ptmcehxp28rc, .table th.tinytable_css_gjiyuz38ptmcehxp28rc { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 2065 vs 2134 1 0.4028057 1.484803 0.3310743 0.200 0.600 2065 vs 1797 1 0.2694327 1.032483 0.2051637 0.400 1.000 2134 vs 1797 1 0.3667150 1.229301 0.1973418 0.166 0.498 pairwise_neutral&lt;-pairwise.adonis(beta_div_neutral_tourmalet_d$S, tourmalet_transect_D$Elevation, perm = 999) FALSE &#39;nperm&#39; &gt;= set of all permutations: complete enumeration. FALSE Set of permutations &lt; &#39;minperm&#39;. Generating entire set. FALSE &#39;nperm&#39; &gt;= set of all permutations: complete enumeration. FALSE Set of permutations &lt; &#39;minperm&#39;. Generating entire set. FALSE Set of permutations &lt; &#39;minperm&#39;. Generating entire set. pairwise_neutral%&gt;% tt() .table td.tinytable_css_zoovp1ntct7jp2acg87t, .table th.tinytable_css_zoovp1ntct7jp2acg87t { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_tbiyytzjv0ry5hx17a71, .table th.tinytable_css_tbiyytzjv0ry5hx17a71 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 2065 vs 2134 1 0.3292590 1.095974 0.2675736 0.3000000 0.90 2065 vs 1797 1 0.2925636 1.244986 0.2373669 0.3333333 1.00 2134 vs 1797 1 0.3411990 1.168639 0.1894485 0.2600000 0.78 pairwise_phylo&lt;-pairwise.adonis(beta_div_phylo_tourmalet_d$S, tourmalet_transect_D$Elevation, perm = 999) FALSE &#39;nperm&#39; &gt;= set of all permutations: complete enumeration. FALSE Set of permutations &lt; &#39;minperm&#39;. Generating entire set. FALSE &#39;nperm&#39; &gt;= set of all permutations: complete enumeration. FALSE Set of permutations &lt; &#39;minperm&#39;. Generating entire set. FALSE Set of permutations &lt; &#39;minperm&#39;. Generating entire set. pairwise_phylo%&gt;% tt() .table td.tinytable_css_u5xtxbint6oudi19aufn, .table th.tinytable_css_u5xtxbint6oudi19aufn { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_gle4tcmncdohhq0o9ral, .table th.tinytable_css_gle4tcmncdohhq0o9ral { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 2065 vs 2134 1 0.01569371 0.3053868 0.09239065 1.000 1.000 2065 vs 1797 1 0.06787740 2.8529448 0.41630932 0.200 0.600 2134 vs 1797 1 0.05593602 1.2651219 0.20193094 0.308 0.924 pairwise_function&lt;-pairwise.adonis(beta_div_func_tourmalet_d$S, tourmalet_transect_D$Elevation, perm = 999) FALSE &#39;nperm&#39; &gt;= set of all permutations: complete enumeration. FALSE Set of permutations &lt; &#39;minperm&#39;. Generating entire set. FALSE &#39;nperm&#39; &gt;= set of all permutations: complete enumeration. FALSE Set of permutations &lt; &#39;minperm&#39;. Generating entire set. FALSE Set of permutations &lt; &#39;minperm&#39;. Generating entire set. pairwise_function%&gt;% tt() .table td.tinytable_css_9cnxae3wiysrgk6ya9ci, .table th.tinytable_css_9cnxae3wiysrgk6ya9ci { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_37bo51uykcpac4vb9bhn, .table th.tinytable_css_37bo51uykcpac4vb9bhn { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 2065 vs 2134 1 0.021405199 0.7976110 0.2100297 0.600 1 2065 vs 1797 1 -0.002829919 -0.7589814 -0.2341799 1.000 1 2134 vs 1797 1 0.014890971 0.7803574 0.1350016 0.548 1 tourmalet_transect_E&lt;-tourmalet_transect %&gt;% filter(Elevation==&quot;2065&quot;| Elevation==&quot;2134&quot;| Elevation==&quot;2306&quot;) tourmalet_counts_E &lt;- temp_genome_counts[, which(colnames(temp_genome_counts) %in% rownames(tourmalet_transect_E))] identical(sort(colnames(tourmalet_counts_E)), sort(as.character(rownames(tourmalet_transect_E)))) tourmalet_counts_func_E &lt;- temp_genome_counts_func[, which(colnames(temp_genome_counts_func) %in% rownames(tourmalet_transect_E))] beta_div_richness_tourmalet_e&lt;-hillpair(data=tourmalet_counts_E, q=0) beta_div_neutral_tourmalet_e&lt;-hillpair(data=tourmalet_counts_E, q=1) beta_div_phylo_tourmalet_e&lt;-hillpair(data=tourmalet_counts_E, q=1, tree=genome_tree) beta_div_func_tourmalet_e&lt;-hillpair(data=tourmalet_counts_func_E, q=1, dist=dist) pairwise_richness&lt;-pairwise.adonis(beta_div_richness_tourmalet_e$S, tourmalet_transect_E$Elevation, perm = 999) Set of permutations &lt; &#39;minperm&#39;. Generating entire set. &#39;nperm&#39; &gt;= set of all permutations: complete enumeration. Set of permutations &lt; &#39;minperm&#39;. Generating entire set. pairwise_richness%&gt;% tt() .table td.tinytable_css_c8ul6d1t561htrn7u1mc, .table th.tinytable_css_c8ul6d1t561htrn7u1mc { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_15qvkaz7t8wumrg9is7o, .table th.tinytable_css_15qvkaz7t8wumrg9is7o { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 2306 vs 2065 1 0.1980965 0.8033905 0.1384347 0.900 1 2306 vs 2134 1 0.1967720 0.7913376 0.1165216 0.895 1 2065 vs 2134 1 0.2007376 0.7455311 0.1990455 0.900 1 pairwise_neutral&lt;-pairwise.adonis(beta_div_neutral_tourmalet_e$S, tourmalet_transect_E$Elevation, perm = 999) Set of permutations &lt; &#39;minperm&#39;. Generating entire set. &#39;nperm&#39; &gt;= set of all permutations: complete enumeration. Set of permutations &lt; &#39;minperm&#39;. Generating entire set. pairwise_neutral%&gt;% tt() .table td.tinytable_css_on085j05oyi9pmtbo1fb, .table th.tinytable_css_on085j05oyi9pmtbo1fb { border-bottom: solid #d3d8dc 0.1em; } .table td.tinytable_css_9ogcagahmyxgrp5m1874, .table th.tinytable_css_9ogcagahmyxgrp5m1874 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 2306 vs 2065 1 0.2271886 1.0444682 0.1727974 0.528 1 2306 vs 2134 1 0.1648267 0.7892842 0.1162544 0.778 1 2065 vs 2134 1 0.1758788 0.7776480 0.2058551 0.800 1 pairwise_phylo&lt;-pairwise.adonis(beta_div_phylo_tourmalet_e$S, tourmalet_transect_E$Elevation, perm = 999) Set of permutations &lt; &#39;minperm&#39;. Generating entire set. &#39;nperm&#39; &gt;= set of all permutations: complete enumeration. Set of permutations &lt; &#39;minperm&#39;. Generating entire set. pairwise_phylo%&gt;% tt() .table td.tinytable_css_xt4y91tlhyuqqm3554mp, .table th.tinytable_css_xt4y91tlhyuqqm3554mp { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_6x9h9ciiy0idoul4xfkf, .table th.tinytable_css_6x9h9ciiy0idoul4xfkf { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 2306 vs 2065 1 0.06348482 3.5566908 0.4156620 0.151 0.453 2306 vs 2134 1 0.03225585 1.9435448 0.2446697 0.210 0.630 2065 vs 2134 1 0.01403233 0.6624989 0.1808871 0.500 1.000 pairwise_function&lt;-pairwise.adonis(beta_div_func_tourmalet_e$S, tourmalet_transect_E$Elevation, perm = 999) Set of permutations &lt; &#39;minperm&#39;. Generating entire set. &#39;nperm&#39; &gt;= set of all permutations: complete enumeration. Set of permutations &lt; &#39;minperm&#39;. Generating entire set. pairwise_function%&gt;% tt() .table td.tinytable_css_ppxup4mprg1a0uebos90, .table th.tinytable_css_ppxup4mprg1a0uebos90 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_k1un6eaxgh819mcdi1bu, .table th.tinytable_css_k1un6eaxgh819mcdi1bu { border-bottom: solid #d3d8dc 0.1em; } pairs Df SumsOfSqs F.Model R2 p.value p.adjusted sig 2306 vs 2065 1 -0.0031909299 -1.5948122 -0.46834782 1.00 1 2306 vs 2134 1 -0.0001873904 -0.6770451 -0.12719348 0.73 1 2065 vs 2134 1 0.0010878936 0.2841359 0.08651771 0.60 1 7.2.5 Beta diversity per transect (calculated from population) 7.2.5.1 Aisa Aisa_transect&lt;-tibble::rownames_to_column(Aisa_transect, var = &quot;sample&quot;) Aisa_counts&lt;-tibble::rownames_to_column(Aisa_counts, var = &quot;genome&quot;) richness_beta_aisa &lt;- Aisa_counts %&gt;% pivot_longer(!genome,names_to=&quot;sample&quot;,values_to = &quot;counts&quot;) %&gt;% left_join(Aisa_transect, by = join_by(sample == sample)) %&gt;% mutate(Elevation=factor(Elevation)) %&gt;% group_by(Elevation) %&gt;% group_split() %&gt;% map_dbl(., ~ .x %&gt;% select(genome, sample, counts) %&gt;% pivot_wider(names_from = sample, values_from = counts) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% tss() %&gt;% as.data.frame() %&gt;% hilldiss(data=., metric=&quot;S&quot;, q = 0) ) richness_beta_aisa &lt;- Aisa_counts %&gt;% pivot_longer(!genome, names_to = &quot;sample&quot;, values_to = &quot;counts&quot;) %&gt;% left_join(Aisa_transect, by = join_by(sample == sample)) %&gt;% mutate(Elevation = factor(Elevation)) %&gt;% group_by(Elevation) %&gt;% group_split() %&gt;% map(., ~ .x %&gt;% select(genome, sample, counts) %&gt;% pivot_wider(names_from = sample, values_from = counts) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% tss() %&gt;% as.data.frame() %&gt;% hilldiss(data = ., metric = &quot;S&quot;, q = 0)) %&gt;% do.call(cbind, .) names(richness_beta_aisa) &lt;- unique(Aisa_transect$Elevation) %&gt;% sort() neutral_beta_aisa &lt;- Aisa_counts %&gt;% pivot_longer(!genome,names_to=&quot;sample&quot;,values_to = &quot;counts&quot;) %&gt;% left_join(Aisa_transect, by = join_by(sample == sample)) %&gt;% mutate(Elevation=factor(Elevation)) %&gt;% group_by(Elevation) %&gt;% group_split() %&gt;% map_dbl(., ~ .x %&gt;% select(genome, sample, counts) %&gt;% pivot_wider(names_from = sample, values_from = counts) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% tss() %&gt;% as.data.frame() %&gt;% hilldiss(data=., metric=&quot;S&quot;, q = 1) ) names(neutral_beta_aisa) &lt;- unique(Aisa_transect$Elevation) %&gt;% sort() phylo_beta_aisa &lt;- Aisa_counts %&gt;% pivot_longer(!genome,names_to=&quot;sample&quot;,values_to = &quot;counts&quot;) %&gt;% left_join(Aisa_transect, by = join_by(sample == sample)) %&gt;% mutate(Elevation=factor(Elevation)) %&gt;% group_by(Elevation) %&gt;% group_split() %&gt;% map_dbl(., ~ .x %&gt;% select(genome, sample, counts) %&gt;% pivot_wider(names_from = sample, values_from = counts) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% tss() %&gt;% as.data.frame() %&gt;% hilldiss(data=., metric=&quot;S&quot;, q = 1, tree=genome_tree) ) names(phylo_beta_aisa) &lt;- unique(Aisa_transect$Elevation) %&gt;% sort() Aisa_counts_func&lt;-tibble::rownames_to_column(Aisa_counts_func, var = &quot;genome&quot;) func_beta_aisa &lt;- Aisa_counts_func %&gt;% pivot_longer(!genome,names_to=&quot;sample&quot;,values_to = &quot;counts&quot;) %&gt;% left_join(Aisa_transect, by = join_by(sample == sample)) %&gt;% mutate(Elevation=factor(Elevation)) %&gt;% group_by(Elevation) %&gt;% group_split() %&gt;% map_dbl(., ~ .x %&gt;% select(genome, sample, counts) %&gt;% pivot_wider(names_from = sample, values_from = counts) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% tss() %&gt;% as.data.frame() %&gt;% hilldiss(data=., metric=&quot;S&quot;, q = 1, dist=dist) ) names(func_beta_aisa) &lt;- unique(Aisa_transect$Elevation) %&gt;% sort() # Merge all metrics beta_div_aisa &lt;- bind_rows(richness_beta_aisa,neutral_beta_aisa,phylo_beta_aisa,func_beta_aisa) %&gt;% t() %&gt;% as.data.frame() %&gt;% rownames_to_column(var=&quot;Elevation&quot;) %&gt;% as_tibble() %&gt;% rename(&quot;richness&quot;=V1,&quot;neutral&quot;=V2,&quot;phylogenetic&quot;=V3,&quot;functional&quot;=V4) New names: • `` -&gt; `...1` • `` -&gt; `...2` • `` -&gt; `...3` • `` -&gt; `...4` 7.2.5.2 Aran aran_transect&lt;-tibble::rownames_to_column(Aran_transect, var = &quot;sample&quot;) aran_counts&lt;-tibble::rownames_to_column(Aran_counts, var = &quot;genome&quot;) richness_beta_aran &lt;- aran_counts %&gt;% pivot_longer(!genome,names_to=&quot;sample&quot;,values_to = &quot;counts&quot;) %&gt;% left_join(aran_transect, by = join_by(sample == sample)) %&gt;% mutate(Elevation=factor(Elevation)) %&gt;% group_by(Elevation) %&gt;% group_split() %&gt;% map_dbl(., ~ .x %&gt;% select(genome, sample, counts) %&gt;% pivot_wider(names_from = sample, values_from = counts) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% tss() %&gt;% as.data.frame() %&gt;% hilldiss(data=., metric=&quot;S&quot;, q = 0) ) names(richness_beta_aran) &lt;- unique(aran_transect$Elevation) %&gt;% sort() neutral_beta_aran &lt;- aran_counts %&gt;% pivot_longer(!genome,names_to=&quot;sample&quot;,values_to = &quot;counts&quot;) %&gt;% left_join(aran_transect, by = join_by(sample == sample)) %&gt;% mutate(Elevation=factor(Elevation)) %&gt;% group_by(Elevation) %&gt;% group_split() %&gt;% map_dbl(., ~ .x %&gt;% select(genome, sample, counts) %&gt;% pivot_wider(names_from = sample, values_from = counts) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% tss() %&gt;% as.data.frame() %&gt;% hilldiss(data=., metric=&quot;S&quot;, q = 1) ) names(neutral_beta_aran) &lt;- unique(aran_transect$Elevation) %&gt;% sort() phylo_beta_aran &lt;- aran_counts %&gt;% pivot_longer(!genome,names_to=&quot;sample&quot;,values_to = &quot;counts&quot;) %&gt;% left_join(aran_transect, by = join_by(sample == sample)) %&gt;% mutate(Elevation=factor(Elevation)) %&gt;% group_by(Elevation) %&gt;% group_split() %&gt;% map_dbl(., ~ .x %&gt;% select(genome, sample, counts) %&gt;% pivot_wider(names_from = sample, values_from = counts) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% tss() %&gt;% as.data.frame() %&gt;% hilldiss(data=., metric=&quot;S&quot;, q = 1, tree=genome_tree) ) names(phylo_beta_aran) &lt;- unique(aran_transect$Elevation) %&gt;% sort() aran_counts_func&lt;-tibble::rownames_to_column(Aran_counts_func, var = &quot;genome&quot;) func_beta_aran &lt;- aran_counts_func %&gt;% pivot_longer(!genome,names_to=&quot;sample&quot;,values_to = &quot;counts&quot;) %&gt;% left_join(aran_transect, by = join_by(sample == sample)) %&gt;% mutate(Elevation=factor(Elevation)) %&gt;% group_by(Elevation) %&gt;% group_split() %&gt;% map_dbl(., ~ .x %&gt;% select(genome, sample, counts) %&gt;% pivot_wider(names_from = sample, values_from = counts) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% tss() %&gt;% as.data.frame() %&gt;% hilldiss(data=., metric=&quot;S&quot;, q = 1, dist=dist) ) names(func_beta_aran) &lt;- unique(aran_transect$Elevation) %&gt;% sort() # Merge all metrics beta_div_aran &lt;- bind_rows(richness_beta_aran,neutral_beta_aran,phylo_beta_aran,func_beta_aran) %&gt;% t() %&gt;% as.data.frame() %&gt;% rownames_to_column(var=&quot;Elevation&quot;) %&gt;% as_tibble() %&gt;% rename(&quot;richness&quot;=V1,&quot;neutral&quot;=V2,&quot;phylogenetic&quot;=V3,&quot;functional&quot;=V4) 7.2.5.3 Sentein sentein_transect&lt;-tibble::rownames_to_column(sentein_transect, var = &quot;sample&quot;) sentein_counts&lt;-tibble::rownames_to_column(sentein_counts, var = &quot;genome&quot;) richness_beta_sentein &lt;- sentein_counts %&gt;% pivot_longer(!genome,names_to=&quot;sample&quot;,values_to = &quot;counts&quot;) %&gt;% left_join(sentein_transect, by = join_by(sample == sample)) %&gt;% mutate(Elevation=factor(Elevation)) %&gt;% group_by(Elevation) %&gt;% group_split() %&gt;% map_dbl(., ~ .x %&gt;% select(genome, sample, counts) %&gt;% pivot_wider(names_from = sample, values_from = counts) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% tss() %&gt;% as.data.frame() %&gt;% hilldiss(data=., metric=&quot;S&quot;, q = 0) ) names(richness_beta_sentein) &lt;- unique(sentein_transect$Elevation) %&gt;% sort() neutral_beta_sentein &lt;- sentein_counts %&gt;% pivot_longer(!genome,names_to=&quot;sample&quot;,values_to = &quot;counts&quot;) %&gt;% left_join(sentein_transect, by = join_by(sample == sample)) %&gt;% mutate(Elevation=factor(Elevation)) %&gt;% group_by(Elevation) %&gt;% group_split() %&gt;% map_dbl(., ~ .x %&gt;% select(genome, sample, counts) %&gt;% pivot_wider(names_from = sample, values_from = counts) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% tss() %&gt;% as.data.frame() %&gt;% hilldiss(data=., metric=&quot;S&quot;, q = 1) ) names(neutral_beta_sentein) &lt;- unique(sentein_transect$Elevation) %&gt;% sort() phylo_beta_sentein &lt;- sentein_counts %&gt;% pivot_longer(!genome,names_to=&quot;sample&quot;,values_to = &quot;counts&quot;) %&gt;% left_join(sentein_transect, by = join_by(sample == sample)) %&gt;% mutate(Elevation=factor(Elevation)) %&gt;% group_by(Elevation) %&gt;% group_split() %&gt;% map_dbl(., ~ .x %&gt;% select(genome, sample, counts) %&gt;% pivot_wider(names_from = sample, values_from = counts) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% tss() %&gt;% as.data.frame() %&gt;% hilldiss(data=., metric=&quot;S&quot;, q = 1, tree=genome_tree) ) names(phylo_beta_sentein) &lt;- unique(sentein_transect$Elevation) %&gt;% sort() sentein_counts_func&lt;-tibble::rownames_to_column(sentein_counts_func, var = &quot;genome&quot;) func_beta_sentein &lt;- sentein_counts_func %&gt;% pivot_longer(!genome,names_to=&quot;sample&quot;,values_to = &quot;counts&quot;) %&gt;% left_join(sentein_transect, by = join_by(sample == sample)) %&gt;% mutate(Elevation=factor(Elevation)) %&gt;% group_by(Elevation) %&gt;% group_split() %&gt;% map_dbl(., ~ .x %&gt;% select(genome, sample, counts) %&gt;% pivot_wider(names_from = sample, values_from = counts) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% tss() %&gt;% as.data.frame() %&gt;% hilldiss(data=., metric=&quot;S&quot;, q = 1, dist=dist) ) names(func_beta_sentein) &lt;- unique(sentein_transect$Elevation) %&gt;% sort() # Merge all metrics beta_div_sentein &lt;- bind_rows(richness_beta_sentein,neutral_beta_sentein,phylo_beta_sentein,func_beta_sentein) %&gt;% t() %&gt;% as.data.frame() %&gt;% rownames_to_column(var=&quot;Elevation&quot;) %&gt;% as_tibble() %&gt;% rename(&quot;richness&quot;=V1,&quot;neutral&quot;=V2,&quot;phylogenetic&quot;=V3,&quot;functional&quot;=V4) 7.2.5.4 Tourmalet tourmalet_transect&lt;-tibble::rownames_to_column(tourmalet_transect, var = &quot;sample&quot;) tourmalet_counts&lt;-tibble::rownames_to_column(tourmalet_counts, var = &quot;genome&quot;) richness_beta_tourmalet &lt;- tourmalet_counts %&gt;% pivot_longer(!genome,names_to=&quot;sample&quot;,values_to = &quot;counts&quot;) %&gt;% left_join(tourmalet_transect, by = join_by(sample == sample)) %&gt;% mutate(Elevation=factor(Elevation)) %&gt;% group_by(Elevation) %&gt;% group_split() %&gt;% map_dbl(., ~ .x %&gt;% select(genome, sample, counts) %&gt;% pivot_wider(names_from = sample, values_from = counts) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% tss() %&gt;% as.data.frame() %&gt;% hilldiss(data=., metric=&quot;S&quot;, q = 0) ) names(richness_beta_tourmalet) &lt;- unique(tourmalet_transect$Elevation) %&gt;% sort() neutral_beta_tourmalet &lt;- tourmalet_counts %&gt;% pivot_longer(!genome,names_to=&quot;sample&quot;,values_to = &quot;counts&quot;) %&gt;% left_join(tourmalet_transect, by = join_by(sample == sample)) %&gt;% mutate(Elevation=factor(Elevation)) %&gt;% group_by(Elevation) %&gt;% group_split() %&gt;% map_dbl(., ~ .x %&gt;% select(genome, sample, counts) %&gt;% pivot_wider(names_from = sample, values_from = counts) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% tss() %&gt;% as.data.frame() %&gt;% hilldiss(data=., metric=&quot;S&quot;, q = 1) ) names(neutral_beta_tourmalet) &lt;- unique(tourmalet_transect$Elevation) %&gt;% sort() phylo_beta_tourmalet &lt;- tourmalet_counts %&gt;% pivot_longer(!genome,names_to=&quot;sample&quot;,values_to = &quot;counts&quot;) %&gt;% left_join(tourmalet_transect, by = join_by(sample == sample)) %&gt;% mutate(Elevation=factor(Elevation)) %&gt;% group_by(Elevation) %&gt;% group_split() %&gt;% map_dbl(., ~ .x %&gt;% select(genome, sample, counts) %&gt;% pivot_wider(names_from = sample, values_from = counts) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% tss() %&gt;% as.data.frame() %&gt;% hilldiss(data=., metric=&quot;S&quot;, q = 1, tree=genome_tree) ) names(phylo_beta_tourmalet) &lt;- unique(tourmalet_transect$Elevation) %&gt;% sort() tourmalet_counts_func&lt;-tibble::rownames_to_column(tourmalet_counts_func, var = &quot;genome&quot;) func_beta_tourmalet &lt;- tourmalet_counts_func %&gt;% pivot_longer(!genome,names_to=&quot;sample&quot;,values_to = &quot;counts&quot;) %&gt;% left_join(tourmalet_transect, by = join_by(sample == sample)) %&gt;% mutate(Elevation=factor(Elevation)) %&gt;% group_by(Elevation) %&gt;% group_split() %&gt;% map_dbl(., ~ .x %&gt;% select(genome, sample, counts) %&gt;% pivot_wider(names_from = sample, values_from = counts) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% tss() %&gt;% as.data.frame() %&gt;% hilldiss(data=., metric=&quot;S&quot;, q = 1, dist=dist) ) names(func_beta_tourmalet) &lt;- unique(tourmalet_transect$Elevation) %&gt;% sort() # Merge all metrics beta_div_tourmalet &lt;- bind_rows(richness_beta_tourmalet,neutral_beta_tourmalet,phylo_beta_tourmalet,func_beta_tourmalet) %&gt;% t() %&gt;% as.data.frame() %&gt;% rownames_to_column(var=&quot;Elevation&quot;) %&gt;% as_tibble() %&gt;% rename(&quot;richness&quot;=V1,&quot;neutral&quot;=V2,&quot;phylogenetic&quot;=V3,&quot;functional&quot;=V4) "],["hmsc-set-up.html", "Chapter 8 HMSC set-up 8.1 Load data 8.2 Subsetting 8.3 Define formulas of the Hmsc model 8.4 Define and Hmsc models 8.5 Define MCMC 8.6 Generate Hmsc executables 8.7 Fit Hmsc models (in Mjolnir HPC) 8.8 Assess chain convergence", " Chapter 8 HMSC set-up 8.1 Load data load(&quot;data/data.Rdata&quot;) 8.2 Subsetting # Subset by prevalence (present in more than 5 samples) selected_genomes1 &lt;- genome_counts %&gt;% filter(rowSums(across(starts_with(&quot;EHI&quot;)) != 0) &gt;= 5) %&gt;% select(genome) %&gt;% pull() # Subset by minimum representation of 1% relative abundance in 5 samples selected_genomes2 &lt;- genome_counts %&gt;% filter(genome %in% selected_genomes1) %&gt;% column_to_rownames(var=&quot;genome&quot;) %&gt;% tss() %&gt;% as.data.frame() %&gt;% filter(rowSums(across(starts_with(&quot;EHI&quot;)) &gt;= 0.01) &gt;= 5) %&gt;% rownames() # Subset genome metadata genome_metadata_subset &lt;- genome_metadata %&gt;% filter(genome %in% selected_genomes2) # Random effects data (study design) StudyDesign &lt;- sample_metadata %&gt;% select(EHI_number,Sampling_point) %&gt;% mutate(Sampling_point = factor(Sampling_point)) %&gt;% #mutate(Transect = factor(Transect)) %&gt;% #mutate(Elevation = factor(Elevation)) %&gt;% column_to_rownames(&quot;EHI_number&quot;) # Genome count table (quantitative community data) YData &lt;- read_counts %&gt;% filter(genome %in% selected_genomes2) %&gt;% #subset genomes mutate(across(where(is.numeric), ~ . +1 )) %&gt;% #add +1 pseudocount to remove zeros mutate(across(where(is.numeric), ~ . / (genome_metadata_subset$length / 150) )) %&gt;% #transform to genome counts mutate(across(where(is.numeric), ~ log(.) )) %&gt;% #log-transform column_to_rownames(&quot;genome&quot;) %&gt;% select(all_of(row.names(StudyDesign))) %&gt;% as.data.frame() %&gt;% t() # transpose # Fixed effects data (explanatory variables) XData &lt;- sample_metadata %&gt;% select(EHI_number,Elevation,Transect) %&gt;% mutate(Transect = factor(Transect)) %&gt;% mutate(logseqdepth=read_counts %&gt;% #total log-sequencing depth select(all_of(row.names(StudyDesign))) %&gt;% colSums() %&gt;% log(), Elevation2 = Elevation^2 # Adding the quadratic effect of Elevation ) %&gt;% column_to_rownames(&quot;EHI_number&quot;) # Genome trait data elements_table_hmsc &lt;- genome_gifts_filt %&gt;% to.elements(., GIFT_db) %&gt;% as.data.frame() elements_table_hmsc&lt;-rownames_to_column(elements_table_hmsc,var = &quot;genome&quot;) TrData &lt;- elements_table_hmsc %&gt;% filter(genome %in% selected_genomes2) %&gt;% #subset genomes arrange(match(genome, colnames(YData))) %&gt;% column_to_rownames(var=&quot;genome&quot;) %&gt;% to.functions(.,GIFT_db) %&gt;% as.data.frame() TrFormula=~B01+B02+B03+B04+B06+B07+B08+B09+B10+D01+D02+D03+D05+D06+D07+D08+D09+S01+S02+S03 # Genome phylogeny PData &lt;- genome_tree 8.3 Define formulas of the Hmsc model # Fixed effects formula XFormula1 = ~Elevation + I(Elevation^2) + Transect + logseqdepth # Study design rL.sampling_point = HmscRandomLevel(units = levels(StudyDesign$Sampling_point)) #rL.transect = HmscRandomLevel(units = levels(StudyDesign$Transect)) 8.4 Define and Hmsc models #Define models model1 = Hmsc(Y=YData, XData = XData, XFormula = XFormula1, studyDesign = StudyDesign, TrData = TrData, TrFormula=TrFormula, phyloTree = PData, ranLevels = list(&quot;Sampling_point&quot;=rL.sampling_point), distr = &quot;normal&quot;, YScale = TRUE) #model2 = Hmsc(Y=YData, #XData = XData, #XFormula = XFormula2, #studyDesign = StudyDesign, #TrData = TrData, #TrFormula=TrFormula, #phyloTree = PData, #ranLevels = list(&quot;Sampling_point&quot;=rL.sampling_point), #distr = &quot;normal&quot;, #YScale = TRUE) #Save list of models as an R object. model_list = list(model1=model1) if (!dir.exists(&quot;hmsc&quot;)){dir.create(&quot;hmsc&quot;)} save(model_list, file = &quot;hmsc/hmsc.Rdata&quot;) Upload hmsc/hmsc.Rdata to the HPC respecting the directory structure. 8.5 Define MCMC # How often to sample the MCMC MCMC_samples_list = 250 # The number of MCMC steps between each recording sample MCMC_thin_list = c(1, 10) # The number of MCMC chains to use nChains = 4 8.6 Generate Hmsc executables The next chunk generates shell files for every combination of model, MCMC samples and MCMM thinning, ready to be launched as SLURM jobs. modelchains &lt;- expand.grid(model = names(model_list), sample = MCMC_samples_list, thin = MCMC_thin_list) if (!dir.exists(&quot;hmsc&quot;)){dir.create(&quot;hmsc&quot;)} for(i in c(1:nrow(modelchains))){ modelname=as.character(modelchains[i,1]) sample=modelchains[i,2] thin=modelchains[i,3] executablename &lt;- paste0(&quot;hmsc/exe_&quot;,modelname,&quot;_&quot;,sample,&quot;_&quot;,thin,&quot;.sh&quot;) fitname &lt;- paste0(&quot;hmsc/fit_&quot;,modelname,&quot;_&quot;,sample,&quot;_&quot;,thin,&quot;.Rdata&quot;) convname &lt;- paste0(&quot;hmsc/conv_&quot;,modelname,&quot;_&quot;,sample,&quot;_&quot;,thin,&quot;.Rdata&quot;) model &lt;- paste0(&#39;model_list$&#39;,modelname) psrf.beta.name &lt;- paste0(&quot;psrf.beta.&quot;,modelname,&quot;_&quot;,sample,&quot;_&quot;,thin) psrf.gamma.name &lt;- paste0(&quot;psrf.gamma.&quot;,modelname,&quot;_&quot;,sample,&quot;_&quot;,thin) psrf.rho.name &lt;- paste0(&quot;psrf.rho.&quot;,modelname,&quot;_&quot;,sample,&quot;_&quot;,thin) jobname &lt;- paste0(&quot;hmsc_&quot;,modelname,&quot;_&quot;,sample,&quot;_&quot;,thin) minutes &lt;- round(sample * thin * (ncol(YData)/500), 0) code &lt;- sprintf(&quot;#!/bin/bash #SBATCH --job-name=%s # Job name #SBATCH --nodes=1 #SBATCH --ntasks=4 # Run on 4 CPUs #SBATCH --mail-user=garazi.bideguren@sund.ku.dk #SBATCH --mem=800gb # Job memory request #SBATCH --time=%d # In minutes # Activate conda environment module load mamba/1.3.1 source activate /maps/projects/mjolnir1/people/dlz554/hmsc_env # Run R script Rscript -e &#39; library(tidyverse) library(Hmsc) # Load formulas and data load(\\&quot;hmsc/hmsc.Rdata\\&quot;) # Declare placeholders modelname = \\&quot;%s\\&quot; model = %s fitname = \\&quot;%s\\&quot; convname = \\&quot;%s\\&quot; sample = %d thin = %d nchains = %d # Run model fitting m = sampleMcmc(hM = model, samples = sample, thin = thin, adaptNf=rep(ceiling(0.4*sample*thin),model$nr), transient = ceiling(0.5*sample*thin), nChains = nchains, nParallel = nchains) # Run model cross-validation, each fold will include the samples from the whole elevation gradient of each transect, randomly selected #partition &lt;- createPartition(m, nfolds = 4) StudyDesign&lt;-m$studyDesign partition&lt;-numeric(length = nrow(StudyDesign)) folds&lt;-1:4 n_sampling_points&lt;-length(unique(StudyDesign$Sampling_point)) set.seed(1) for(i in 1:n_sampling_points){ location_tmp&lt;-which(StudyDesign$Sampling_point==unique(StudyDesign$Sampling_point)[i]) if(length(location_tmp)&gt;4){ random_points&lt;-sample(location_tmp,4) partition[random_points]&lt;-sample(folds,4) remaining_points&lt;-location_tmp[is.na(match(location_tmp, random_points))] partition[remaining_points]&lt;-sample(folds,length(remaining_points)) }else{ partition[location_tmp]&lt;-sample(folds,length(location_tmp)) } } cv &lt;- computePredictedValues(m, partition=partition, nChains = 4) # Assess chain convergence mpost = convertToCodaObject(m, spNamesNumbers = c(T,F), covNamesNumbers = c(T,F), Beta = TRUE, Gamma = TRUE, V = FALSE, Sigma = FALSE, Rho = TRUE, Eta = FALSE, Lambda = FALSE, Alpha = FALSE, Omega = FALSE, Psi = FALSE, Delta = FALSE) # Convert to CODA object # Fixed effects assign(paste0(\\&quot;psrf.beta.\\&quot;, modelname,\\&quot;_\\&quot;,sample,\\&quot;_\\&quot;,thin), gelman.diag(mpost$Beta,multivariate=FALSE)$psrf) # Traits assign(paste0(\\&quot;psrf.gamma.\\&quot;, modelname,\\&quot;_\\&quot;,sample,\\&quot;_\\&quot;,thin), gelman.diag(mpost$Gamma,multivariate=FALSE)$psrf) # Phylogeny assign(paste0(\\&quot;psrf.rho.\\&quot;, modelname,\\&quot;_\\&quot;,sample,\\&quot;_\\&quot;,thin), gelman.diag(mpost$Rho,multivariate=FALSE)$psrf) # Write convergence data save(%s, %s, %s, file=convname) # Save model fit object save(m,cv, file=fitname) &#39; &quot;, jobname, minutes, modelname, model, fitname, convname, sample, thin, nChains, psrf.beta.name, psrf.gamma.name, psrf.rho.name) writeLines(code, executablename) } Upload the produced hmsc/exe_XXXXX.sh files to the HPC respecting the directory structure. 8.7 Fit Hmsc models (in Mjolnir HPC) Launch the SLURM jobs by using: # Submit all .sh files in the hmsc folder for jobfile in hmsc/exe_*.sh; do sbatch &quot;$jobfile&quot; done #Or launch them one by one only the ones you want to launch sbatch hmsc/exe_model1_250_1.sh sbatch hmsc/exe_model2_250_10.sh 8.8 Assess chain convergence Convergence diagnostic values substantially above 1 indicate lack of convergence. Values below 1.1 are considered good enough # Load all conv file available in the hmsc folder file_paths &lt;-list.files(path = &quot;hmsc_bookdown&quot;, pattern = &quot;^conv_&quot;, full.names = TRUE, include.dirs = TRUE) for (file_path in file_paths) { load(file_path, verbose = TRUE) # Remove .GlobalEnv argument and specify verbose for each load operation } Loading objects: psrf.beta.model2_250_1 psrf.gamma.model2_250_1 psrf.rho.model2_250_1 Loading objects: psrf.beta.model2_250_10 psrf.gamma.model2_250_10 psrf.rho.model2_250_10 # Create a merged psrf.beta (genome) plot ls() %&gt;% grep(&quot;^psrf\\\\.beta&quot;, ., value = TRUE) %&gt;% map_dfr(~ { mat &lt;- get(.x) data.frame(modelchain = .x, as.data.frame(mat, , stringsAsFactors = FALSE)) %&gt;% rownames_to_column(var=&quot;parameter&quot;) %&gt;% mutate(model = str_split(modelchain, &quot;_&quot;) %&gt;% map_chr(1) %&gt;% gsub(&quot;psrf.beta.&quot;,&quot;&quot;,.)) %&gt;% mutate(sample = str_split(modelchain, &quot;_&quot;)[[1]][2]) %&gt;% #extract sample info from model name mutate(thin = str_split(modelchain, &quot;_&quot;)[[1]][3]) #extract thin info from model name }) %&gt;% ggplot(.,aes(x=reorder(modelchain,-Point.est.,fun=function(x) {quantile(x, probs = 0.9)}),y=Point.est.)) + geom_violin(fill=&quot;#b8d9e3&quot;, color=&quot;#328da8&quot;) + geom_jitter(alpha=0.3,size=0.2, color=&quot;#a8babf&quot;) + stat_summary(fun=function(x) {quantile(x, probs = 0.9)}, geom=&quot;crossbar&quot;, width=0.2, color=&quot;orange&quot;) + geom_hline(yintercept=1.1, linetype=&quot;dashed&quot;, color = &quot;red&quot;) + ylim(0.9,2)+ labs(x=&quot;Model chains&quot;,y=&quot;Parameter estimates&quot;)+ theme_classic()+ theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) "],["hmsc-analysis.html", "Chapter 9 HMSC analysis 9.1 Load data 9.2 Compute variance partitioning 9.3 Model fit 9.4 Phylogenetic signal 9.5 Elevation predictions 9.6 Functional predictions", " Chapter 9 HMSC analysis 9.1 Load data load(&quot;data/data.Rdata&quot;) 9.2 Compute variance partitioning # Select modelchain of interest load(&quot;hmsc_bookdown/fit_model1_250_10.Rdata&quot;) # Compute variance partitioning varpart=computeVariancePartitioning(m) varpart$vals %&gt;% as.data.frame() %&gt;% rownames_to_column(var=&quot;variable&quot;) %&gt;% pivot_longer(!variable, names_to = &quot;genome&quot;, values_to = &quot;value&quot;) %&gt;% mutate(variable=factor(variable, levels=c(&quot;Elevation&quot;,&quot;I(Elevation^2)&quot;,&quot;logseqdepth&quot;,&quot;Transect&quot;,&quot;Random: Sampling_point&quot;))) %&gt;% group_by(variable) %&gt;% summarise(mean=mean(value)*100,sd=sd(value)*100) %&gt;% tt() .table td.tinytable_css_6thm4n9u25mfewsrimi6, .table th.tinytable_css_6thm4n9u25mfewsrimi6 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; } .table td.tinytable_css_4bru73ixnlyrmxkgzfkp, .table th.tinytable_css_4bru73ixnlyrmxkgzfkp { border-bottom: solid #d3d8dc 0.1em; } variable mean sd Elevation 28.076486 8.187856 I(Elevation^2) 29.446551 11.053653 logseqdepth 6.895399 6.309619 Transect 8.957783 8.650044 Random: Sampling_point 26.623781 19.542004 # Basal tree varpart_tree &lt;- genome_tree %&gt;% keep.tip(., tip=m$spNames) #Varpart table varpart_table &lt;- varpart$vals %&gt;% as.data.frame() %&gt;% rownames_to_column(var=&quot;variable&quot;) %&gt;% pivot_longer(!variable, names_to = &quot;genome&quot;, values_to = &quot;value&quot;) %&gt;% mutate(variable=factor(variable, levels=rev(c(&quot;Elevation&quot;,&quot;I(Elevation^2)&quot;,&quot;logseqdepth&quot;,&quot;Transect&quot;,&quot;Random: Sampling_point&quot;)))) %&gt;% mutate(genome=factor(genome, levels=rev(varpart_tree$tip.label))) #Phylums phylum_colors &lt;- read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;) %&gt;% right_join(genome_metadata, by=join_by(phylum == phylum)) %&gt;% filter(genome %in% varpart_tree$tip.label) %&gt;% arrange(match(genome, varpart_tree$tip.label)) %&gt;% mutate(phylum = factor(phylum, levels = unique(phylum))) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% select(phylum) colors_alphabetic &lt;- read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;) %&gt;% right_join(genome_metadata, by=join_by(phylum == phylum)) %&gt;% filter(genome %in% varpart_tree$tip.label) %&gt;% arrange(match(genome, varpart_tree$tip.label)) %&gt;% select(phylum, colors) %&gt;% unique() %&gt;% arrange(phylum) %&gt;% select(colors) %&gt;% pull() # Basal ggtree varpart_tree &lt;- varpart_tree %&gt;% force.ultrametric(.,method=&quot;extend&quot;) %&gt;% ggtree(., size = 0.3) *************************************************************** * Note: * * force.ultrametric does not include a formal method to * * ultrametricize a tree &amp; should only be used to coerce * * a phylogeny that fails is.ultrametric due to rounding -- * * not as a substitute for formal rate-smoothing methods. * *************************************************************** # Add phylum colors next to the tree tips varpart_tree &lt;- gheatmap(varpart_tree, phylum_colors, offset=-0.2, width=0.1, colnames=FALSE) + scale_fill_manual(values=colors_alphabetic)+ labs(fill=&quot;Phylum&quot;) #Reset fill scale to use a different colour profile in the heatmap varpart_tree &lt;- varpart_tree + new_scale_fill() # Add variance stacked barplot vertical_tree &lt;- varpart_tree + scale_fill_manual(values=c(&quot;#34738f&quot;,&quot;#cccccc&quot;,&quot;#ed8a45&quot;,&quot;#b2b530&quot;,&quot;#be3e2b&quot;,&quot;#83bb90&quot;,&quot;#f6de6c&quot;, &quot;#122f3d&quot;))+ geom_fruit( data=varpart_table, geom=geom_bar, mapping = aes(x=value, y=genome, fill=variable, group=variable), pwidth = 2, offset = 0.05, width= 1, orientation=&quot;y&quot;, stat=&quot;identity&quot;, color = &quot;white&quot;, size=0.1)+ labs(fill=&quot;Variable&quot;) vertical_tree 9.3 Model fit MFCV &lt;- evaluateModelFit(hM=m, predY=cv) mean(MFCV$R2, na.rm = TRUE) [1] 0.1166458 genome_fit &lt;- tibble(genome=m$spNames, r2 = MFCV[[2]]) genome_counts_filt %&gt;% mutate_if(is.numeric, ~ . / sum(.)) %&gt;% left_join(genome_fit, by=&quot;genome&quot;) %&gt;% filter(r2&gt;0.5) %&gt;% select(-c(genome,r2)) %&gt;% colSums() %&gt;% hist() # Select desired support threshold support=0.9 negsupport=1-support # Basal tree postestimates_tree &lt;- genome_tree %&gt;% keep.tip(., tip=m$spNames) #plotBeta(hM=m, post=getPostEstimate(hM=m, parName=&quot;Beta&quot;), param = &quot;Support&quot;, plotTree = TRUE, covNamesNumbers=c(1,0)) # Posterior estimate table post_beta &lt;- getPostEstimate(hM=m, parName=&quot;Beta&quot;)$support %&gt;% as.data.frame() %&gt;% mutate(variable=m$covNames) %&gt;% pivot_longer(!variable, names_to = &quot;genome&quot;, values_to = &quot;value&quot;) %&gt;% mutate(genome=factor(genome, levels=rev(postestimates_tree$tip.label))) %&gt;% mutate(value = case_when( value &gt;= support ~ &quot;Positive&quot;, value &lt;= negsupport ~ &quot;Negative&quot;, TRUE ~ &quot;Neutral&quot;)) %&gt;% mutate(value=factor(value, levels=c(&quot;Positive&quot;,&quot;Neutral&quot;,&quot;Negative&quot;))) %&gt;% pivot_wider(names_from = variable, values_from = value) %&gt;% rename(intercept=2, Elevation=3, Elevation_2=4, TransectAran=5, TransectSentein=6, TransectTourmalet=7, logseqdepth=8 ) %&gt;% select(genome,intercept,Elevation,Elevation_2,TransectAran,TransectSentein,TransectTourmalet,logseqdepth) %&gt;% column_to_rownames(var=&quot;genome&quot;) #Phylums phylum_colors &lt;- read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;) %&gt;% right_join(genome_metadata, by=join_by(phylum == phylum)) %&gt;% filter(genome %in% postestimates_tree$tip.label) %&gt;% arrange(match(genome, postestimates_tree$tip.label)) %&gt;% mutate(phylum = factor(phylum, levels = unique(phylum))) %&gt;% column_to_rownames(var = &quot;genome&quot;) %&gt;% select(phylum) colors_alphabetic &lt;- read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;) %&gt;% right_join(genome_metadata, by=join_by(phylum == phylum)) %&gt;% filter(genome %in% postestimates_tree$tip.label) %&gt;% arrange(match(genome, postestimates_tree$tip.label)) %&gt;% select(phylum, colors) %&gt;% unique() %&gt;% arrange(phylum) %&gt;% select(colors) %&gt;% pull() # Basal ggtree postestimates_tree &lt;- postestimates_tree %&gt;% force.ultrametric(.,method=&quot;extend&quot;) %&gt;% ggtree(., size = 0.3) *************************************************************** * Note: * * force.ultrametric does not include a formal method to * * ultrametricize a tree &amp; should only be used to coerce * * a phylogeny that fails is.ultrametric due to rounding -- * * not as a substitute for formal rate-smoothing methods. * *************************************************************** #Add phylum colors next to the tree tips postestimates_tree &lt;- gheatmap(postestimates_tree, phylum_colors, offset=-0.2, width=0.1, colnames=FALSE) + scale_fill_manual(values=colors_alphabetic)+ labs(fill=&quot;Phylum&quot;) #Reset fill scale to use a different colour profile in the heatmap postestimates_tree &lt;- postestimates_tree + new_scale_fill() # Add posterior significant heatmap postestimates_tree &lt;- gheatmap(postestimates_tree, post_beta, offset=0, width=0.5, colnames=TRUE, colnames_position=&quot;top&quot;,colnames_angle=90, colnames_offset_y=1, hjust=0) + scale_fill_manual(values=c(&quot;#be3e2b&quot;,&quot;#f4f4f4&quot;,&quot;#b2b530&quot;))+ labs(fill=&quot;Trend&quot;) postestimates_tree + vexpand(.25, 1) # expand top #Compute the residual correlation matrix OmegaCor = computeAssociations(m) # Reference tree (for sorting genomes) genome_tree_subset &lt;- genome_tree %&gt;% keep.tip(., tip=m$spNames) #Co-occurrence matrix at the animal level supportLevel = 0.95 toPlot = ((OmegaCor[[1]]$support&gt;supportLevel) + (OmegaCor[[1]]$support&lt;(1-supportLevel))&gt;0)*OmegaCor[[1]]$mean matrix &lt;- toPlot %&gt;% as.data.frame() %&gt;% rownames_to_column(var=&quot;genome1&quot;) %&gt;% pivot_longer(!genome1, names_to = &quot;genome2&quot;, values_to = &quot;cor&quot;) %&gt;% mutate(genome1= factor(genome1, levels=genome_tree_subset$tip.label)) %&gt;% mutate(genome2= factor(genome2, levels=genome_tree_subset$tip.label)) %&gt;% ggplot(aes(x = genome1, y = genome2, fill = cor)) + geom_tile() + scale_fill_gradient2(low = &quot;#be3e2b&quot;, mid = &quot;#f4f4f4&quot;, high = &quot;#b2b530&quot;)+ theme_void() vtree_top &lt;- genome_tree_subset %&gt;% force.ultrametric(.,method=&quot;extend&quot;) %&gt;% ggtree(layout = &quot;rectangular&quot;) + layout_dendrogram() + # Ensure correct layout coord_flip() *************************************************************** * Note: * * force.ultrametric does not include a formal method to * * ultrametricize a tree &amp; should only be used to coerce * * a phylogeny that fails is.ultrametric due to rounding -- * * not as a substitute for formal rate-smoothing methods. * *************************************************************** vtree_left &lt;- genome_tree_subset %&gt;% force.ultrametric(.,method=&quot;extend&quot;) %&gt;% ggtree(.) *************************************************************** * Note: * * force.ultrametric does not include a formal method to * * ultrametricize a tree &amp; should only be used to coerce * * a phylogeny that fails is.ultrametric due to rounding -- * * not as a substitute for formal rate-smoothing methods. * *************************************************************** #create composite figure grid.arrange(grobs = list(vtree_top,matrix,vtree_left), layout_matrix = rbind(c(4,1,1,1,1,1,1,1,1,1,1,1), c(3,2,2,2,2,2,2,2,2,2,2,2), c(3,2,2,2,2,2,2,2,2,2,2,2), c(3,2,2,2,2,2,2,2,2,2,2,2), c(3,2,2,2,2,2,2,2,2,2,2,2), c(3,2,2,2,2,2,2,2,2,2,2,2), c(3,2,2,2,2,2,2,2,2,2,2,2), c(3,2,2,2,2,2,2,2,2,2,2,2), c(3,2,2,2,2,2,2,2,2,2,2,2), c(3,2,2,2,2,2,2,2,2,2,2,2), c(3,2,2,2,2,2,2,2,2,2,2,2), c(3,2,2,2,2,2,2,2,2,2,2,2))) 9.4 Phylogenetic signal mpost &lt;- convertToCodaObject(m) quantile(unlist(mpost$Rho), probs = c(.05,.5,.95)) 5% 50% 95% 0.99 1.00 1.00 9.5 Elevation predictions gradient = seq(940, 2350, by = 100) gradientlength = length(gradient) #Treatment-specific gradient predictions pred_elevation &lt;- constructGradient(m, focalVariable = &quot;Elevation&quot;, non.focalVariables = list(logseqdepth=list(1)), ngrid=gradientlength) %&gt;% predict(m, Gradient = ., expected = TRUE) %&gt;% do.call(rbind,.) %&gt;% as.data.frame() %&gt;% mutate(elevation=rep(gradient,1000)) %&gt;% pivot_longer(-c(elevation), names_to = &quot;genome&quot;, values_to = &quot;value&quot;) # weights: 12 (6 variable) initial value 145.560908 iter 10 value 137.337331 final value 137.337291 converged 9.5.1 Responses to elevation # Select desired support threshold support=0.9 negsupport=1-support #Get phylum colors from the EHI standard phylum_colors &lt;- genome_metadata %&gt;% left_join(read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;), by=join_by(phylum == phylum)) %&gt;% arrange(match(genome, genome_tree$tip.label)) %&gt;% select(phylum, colors) %&gt;% unique() %&gt;% arrange(phylum) %&gt;% #slice(2:5) %&gt;% select(colors) %&gt;% pull() getPostEstimate(hM=m, parName=&quot;Beta&quot;)$support %&gt;% as.data.frame() %&gt;% mutate(variable=m$covNames) %&gt;% pivot_longer(!variable, names_to = &quot;genome&quot;, values_to = &quot;value&quot;) %&gt;% mutate(trend = case_when( value &gt;= support ~ &quot;Positive&quot;, value &lt;= negsupport ~ &quot;Negative&quot;, TRUE ~ &quot;Neutral&quot;)) %&gt;% filter(variable==&quot;Elevation&quot;) %&gt;% select(genome,trend) %&gt;% left_join(pred_elevation, by=join_by(genome==genome)) %&gt;% group_by(genome, trend, elevation) %&gt;% summarize(value = mean(value, na.rm = TRUE)) %&gt;% left_join(genome_metadata, by=join_by(genome == genome)) %&gt;% ggplot(aes(x=elevation, y=value, group=genome, color=phylum, linetype=trend)) + geom_line() + scale_linetype_manual(values=c(&quot;solid&quot;,&quot;dashed&quot;,&quot;solid&quot;)) + scale_color_manual(values=phylum_colors) + facet_grid(fct_rev(trend) ~ phylum) + labs(y=&quot;Genome abundance (log)&quot;,x=&quot;Elevation&quot;) + theme(legend.position = &quot;none&quot;) + theme_minimal() + theme(legend.position = &quot;none&quot;, axis.text.x = element_text(angle = 45, hjust = 0.8,), axis.line.x = element_line(size = 0.5, linetype = &quot;solid&quot;, colour = &quot;black&quot;), ) 9.6 Functional predictions 9.6.1 Element level elements_table &lt;- genome_gifts_filt %&gt;% to.elements(., GIFT_db) %&gt;% as.data.frame() community_elements &lt;- pred_elevation %&gt;% group_by(elevation, genome) %&gt;% mutate(row_id = row_number()) %&gt;% pivot_wider(names_from = genome, values_from = value) %&gt;% ungroup() %&gt;% group_split(row_id) %&gt;% as.list() %&gt;% lapply(., FUN = function(x){x %&gt;% select(-row_id) %&gt;% column_to_rownames(var = &quot;elevation&quot;) %&gt;% as.data.frame() %&gt;% exp() %&gt;% t() %&gt;% tss() %&gt;% to.community(elements_table,.,GIFT_db) %&gt;% as.data.frame() %&gt;% rownames_to_column(var=&quot;elevation&quot;) }) calculate_slope &lt;- function(x) { lm_fit &lt;- lm(unlist(x) ~ seq_along(unlist(x))) coef(lm_fit)[2] } element_predictions &lt;- map_dfc(community_elements, function(mat) { mat %&gt;% column_to_rownames(var = &quot;elevation&quot;) %&gt;% t() %&gt;% as.data.frame() %&gt;% rowwise() %&gt;% mutate(slope = calculate_slope(c_across(everything()))) %&gt;% select(slope) }) %&gt;% t() %&gt;% as.data.frame() %&gt;% set_names(colnames(community_elements[[1]])[-1]) %&gt;% rownames_to_column(var=&quot;iteration&quot;) %&gt;% pivot_longer(!iteration, names_to=&quot;trait&quot;,values_to=&quot;value&quot;) %&gt;% group_by(trait) %&gt;% summarise(mean=mean(value), p1 = quantile(value, probs = 0.1), p9 = quantile(value, probs = 0.9), positive_support = sum(value &gt; 0)/1000, negative_support = sum(value &lt; 0)/1000) %&gt;% arrange(-positive_support) 9.6.1.1 Positive associated functions at element level unique_funct_db&lt;- GIFT_db[c(2,4,5,6)] %&gt;% distinct(Code_element, .keep_all = TRUE) element_predictions %&gt;% filter(mean &gt;0) %&gt;% arrange(-positive_support) %&gt;% filter(positive_support&gt;=0.9) %&gt;% left_join(unique_funct_db, by = join_by(trait == Code_element))%&gt;% arrange(Domain,Function)%&gt;% paged_table() 9.6.1.2 Negative associated functions at element level element_predictions %&gt;% filter(mean &lt;0) %&gt;% arrange(-negative_support) %&gt;% filter(negative_support&gt;=0.9) %&gt;% left_join(unique_funct_db, by = join_by(trait == Code_element))%&gt;% arrange(Domain,Function)%&gt;% paged_table() #Positively associated positive &lt;- element_predictions %&gt;% filter(mean &gt;0) %&gt;% arrange(mean) %&gt;% filter(positive_support&gt;=0.9) %&gt;% select(-negative_support) %&gt;% rename(support=positive_support) #Negatively associated negative &lt;- element_predictions %&gt;% filter(mean &lt;0) %&gt;% arrange(mean) %&gt;% filter(negative_support&gt;=0.9) %&gt;% select(-positive_support) %&gt;% rename(support=negative_support) all_elements &lt;- bind_rows(positive,negative) %&gt;% left_join(GIFT_db,by=join_by(trait==Code_element)) %&gt;% mutate(trait=factor(trait,levels=c(rev(positive$trait),rev(negative$trait)))) %&gt;% mutate(Code_function=factor(Code_function)) %&gt;% mutate(element_legend=str_c(trait,&quot; - &quot;,Element)) %&gt;% mutate(function_legend=str_c(Code_function,&quot; - &quot;,Function)) %&gt;% select(trait,mean,p1,p9,element_legend,function_legend) %&gt;% unique() gift_colors &lt;- read_tsv(&quot;data/gift_colors.tsv&quot;) %&gt;% mutate(legend=str_c(Code_function,&quot; - &quot;,Function)) %&gt;% filter(legend %in% all_elements$function_legend) all_elements %&gt;% ggplot(aes(x=mean, y=fct_reorder(element_legend, mean), xmin=p1, xmax=p9, color=function_legend)) + geom_point() + geom_errorbar() + xlim(c(-0.15,0.15)) + geom_vline(xintercept=0) + scale_color_manual(values = gift_colors$Color) + theme_minimal() + labs(x=&quot;Regression coefficient&quot;,y=&quot;Functional trait&quot;) community_elements %&gt;% bind_rows() %&gt;% pivot_longer(-elevation, names_to = &quot;trait&quot;, values_to = &quot;value&quot;) %&gt;% filter(trait %in% positive$trait) %&gt;% mutate(trait=factor(trait, levels=positive$trait)) %&gt;% mutate(elevation=as.numeric(elevation)) %&gt;% ggplot(aes(x=elevation, y=value)) + geom_smooth(method = lm, formula = y ~ x, se = TRUE) + #geom_smooth(method = lm, formula = y ~ splines::bs(x, 3), se = TRUE) + facet_wrap(~trait, ncol=5, scales=&quot;free&quot;) + theme_minimal() + labs(x=&quot;Elevation&quot;,y=&quot;Metabolic Capacity Index&quot;) 9.6.1.3 GIFT test visualization # Aggregate bundle-level GIFTs into the compound level genome_counts_filt_filt &lt;- tibble::rownames_to_column(genome_counts_filt_filt, var = &quot;genome&quot;) GIFTs_elements_filtered &lt;- elements_table[rownames(elements_table) %in% genome_counts_filt_filt$genome, ] GIFTs_elements_filtered &lt;- as.data.frame(GIFTs_elements_filtered) %&gt;% select_if(~ !is.numeric(.) || sum(.) != 0) # Get community-weighed average GIFTs per sample GIFTs_elements_community &lt;- to.community(GIFTs_elements_filtered, genome_counts_filt_filt %&gt;% column_to_rownames(., &quot;genome&quot;) %&gt;% tss(), GIFT_db) GIFTs_elements_community %&gt;% as.data.frame() %&gt;% rownames_to_column(var=&quot;sample&quot;) %&gt;% pivot_longer(!sample,names_to=&quot;trait&quot;,values_to=&quot;gift&quot;) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% mutate(functionid = substr(trait, 1, 3)) %&gt;% mutate(trait = case_when( trait %in% GIFT_db$Code_element ~ GIFT_db$Element[match(trait, GIFT_db$Code_element)], TRUE ~ trait )) %&gt;% mutate(functionid = case_when( functionid %in% GIFT_db$Code_function ~ GIFT_db$Function[match(functionid, GIFT_db$Code_function)], TRUE ~ functionid )) %&gt;% mutate(trait=factor(trait,levels=unique(GIFT_db$Element))) %&gt;% mutate(functionid=factor(functionid,levels=unique(GIFT_db$Function))) %&gt;% ggplot(aes(x=sample,y=trait,fill=gift)) + geom_tile(colour=&quot;white&quot;, linewidth=0.2)+ scale_fill_gradientn(colours=rev(c(&quot;#d53e4f&quot;, &quot;#f46d43&quot;, &quot;#fdae61&quot;, &quot;#fee08b&quot;, &quot;#e6f598&quot;, &quot;#abdda4&quot;, &quot;#ddf1da&quot;)))+ facet_grid(functionid ~ Elevation, scales=&quot;free&quot;,space=&quot;free&quot;) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), strip.text.y = element_text(angle = 0)) + labs(y=&quot;Traits&quot;,x=&quot;Samples&quot;,fill=&quot;GIFT&quot;) 9.6.2 Functional level functions_table &lt;- elements_table %&gt;% to.functions(., GIFT_db) %&gt;% as.data.frame() community_functions &lt;- pred_elevation %&gt;% group_by(elevation, genome) %&gt;% mutate(row_id = row_number()) %&gt;% pivot_wider(names_from = genome, values_from = value) %&gt;% ungroup() %&gt;% group_split(row_id) %&gt;% as.list() %&gt;% lapply(., FUN = function(x){x %&gt;% select(-row_id) %&gt;% column_to_rownames(var = &quot;elevation&quot;) %&gt;% as.data.frame() %&gt;% exp() %&gt;% t() %&gt;% tss() %&gt;% to.community(functions_table,.,GIFT_db) %&gt;% as.data.frame() %&gt;% rownames_to_column(var=&quot;elevation&quot;) }) #max-min option calculate_slope &lt;- function(x) { lm_fit &lt;- lm(unlist(x) ~ seq_along(unlist(x))) coef(lm_fit)[2] } function_predictions &lt;- map_dfc(community_functions, function(mat) { mat %&gt;% column_to_rownames(var = &quot;elevation&quot;) %&gt;% t() %&gt;% as.data.frame() %&gt;% rowwise() %&gt;% mutate(slope = calculate_slope(c_across(everything()))) %&gt;% select(slope) }) %&gt;% t() %&gt;% as.data.frame() %&gt;% set_names(colnames(community_functions[[1]])[-1]) %&gt;% rownames_to_column(var=&quot;iteration&quot;) %&gt;% pivot_longer(!iteration, names_to=&quot;trait&quot;,values_to=&quot;value&quot;) %&gt;% group_by(trait) %&gt;% summarise(mean=mean(value), p1 = quantile(value, probs = 0.1), p9 = quantile(value, probs = 0.9), positive_support = sum(value &gt; 0)/1000, negative_support = sum(value &lt; 0)/1000) %&gt;% arrange(-positive_support) 9.6.2.1 Positive associated functions at element level function_predictions %&gt;% filter(mean &gt;0) %&gt;% arrange(-positive_support) %&gt;% filter(positive_support&gt;=0.9) %&gt;% paged_table() 9.6.2.2 Negative associated functions at element level function_predictions %&gt;% filter(mean &lt;0) %&gt;% arrange(-negative_support) %&gt;% filter(negative_support&gt;=0.9) %&gt;% paged_table() positive_func &lt;- function_predictions %&gt;% filter(mean &gt;0) %&gt;% arrange(mean) %&gt;% filter(positive_support&gt;=0.9) %&gt;% dplyr::select(-negative_support) %&gt;% rename(support=positive_support) negative_func &lt;- function_predictions %&gt;% filter(mean &lt;0) %&gt;% arrange(mean) %&gt;% filter(negative_support&gt;=0.9) %&gt;% dplyr::select(-positive_support) %&gt;% rename(support=negative_support) all_functions &lt;- bind_rows(positive_func,negative_func) %&gt;% left_join(GIFT_db,by=join_by(trait==Code_function)) %&gt;% mutate(trait=factor(trait)) %&gt;% mutate(function_legend=str_c(trait,&quot; - &quot;,Function)) %&gt;% select(trait,mean,p1,p9,function_legend) %&gt;% unique() gift_colors &lt;- read_tsv(&quot;data/gift_colors.tsv&quot;) %&gt;% mutate(legend=str_c(Code_function,&quot; - &quot;,Function)) %&gt;% filter(legend %in% all_functions$function_legend) all_functions %&gt;% ggplot(aes(x=mean, y=fct_reorder(function_legend, mean), xmin=p1, xmax=p9, color=function_legend)) + geom_point() + geom_errorbar() + xlim(c(-0.05,0.06)) + geom_vline(xintercept=0) + scale_color_manual(values = gift_colors$Color) + theme_minimal() + labs(x=&quot;Regression coefficient&quot;,y=&quot;Functional trait&quot;) + guides(col = guide_legend(ncol = 1)) community_functions %&gt;% bind_rows() %&gt;% pivot_longer(-elevation, names_to = &quot;trait&quot;, values_to = &quot;value&quot;) %&gt;% filter(trait %in% function_predictions$trait) %&gt;% mutate(trait=factor(trait, levels=function_predictions$trait)) %&gt;% mutate(elevation=as.numeric(elevation)) %&gt;% ggplot(aes(x=elevation, y=value)) + geom_smooth(method = lm, formula = y ~ x, se = TRUE) + #geom_smooth(method = lm, formula = y ~ splines::bs(x, 3), se = TRUE) + facet_wrap(~trait, ncol=5, scales=&quot;free&quot;) + theme_minimal() + labs(x=&quot;Elevation&quot;,y=&quot;Metabolic Capacity Index&quot;) 9.6.2.3 GIFT test visualization # Aggregate element-level GIFTs into the function level GIFTs_functions &lt;- to.functions(GIFTs_elements_filtered, GIFT_db) functions &lt;- GIFTs_functions %&gt;% as.data.frame() # Get community-weighed average GIFTs per sample GIFTs_functions_community &lt;- to.community(GIFTs_functions, genome_counts_filt_filt %&gt;% column_to_rownames(., &quot;genome&quot;) %&gt;% tss(), GIFT_db) GIFTs_functions_community %&gt;% as.data.frame() %&gt;% rownames_to_column(var=&quot;sample&quot;) %&gt;% pivot_longer(!sample,names_to=&quot;trait&quot;,values_to=&quot;gift&quot;) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% ggplot(aes(x=trait,y=sample,fill=gift)) + geom_tile(colour=&quot;white&quot;, size=0.2)+ scale_fill_gradientn(colours=rev(c(&quot;#d53e4f&quot;, &quot;#f46d43&quot;, &quot;#fdae61&quot;, &quot;#fee08b&quot;, &quot;#e6f598&quot;, &quot;#abdda4&quot;, &quot;#ddf1da&quot;)))+ facet_grid(Elevation ~ ., scales=&quot;free&quot;,space=&quot;free&quot;) 9.6.3 Domain level domains_table &lt;- functions_table %&gt;% to.domains(., GIFT_db) %&gt;% as.data.frame() community_domains &lt;- pred_elevation %&gt;% group_by(elevation, genome) %&gt;% mutate(row_id = row_number()) %&gt;% pivot_wider(names_from = genome, values_from = value) %&gt;% ungroup() %&gt;% group_split(row_id) %&gt;% as.list() %&gt;% lapply(., FUN = function(x){x %&gt;% select(-row_id) %&gt;% column_to_rownames(var = &quot;elevation&quot;) %&gt;% as.data.frame() %&gt;% exp() %&gt;% t() %&gt;% tss() %&gt;% to.community(domains_table,.,GIFT_db) %&gt;% as.data.frame() %&gt;% rownames_to_column(var=&quot;elevation&quot;) }) #max-min option calculate_slope &lt;- function(x) { lm_fit &lt;- lm(unlist(x) ~ seq_along(unlist(x))) coef(lm_fit)[2] } domain_predictions &lt;- map_dfc(community_domains, function(mat) { mat %&gt;% column_to_rownames(var = &quot;elevation&quot;) %&gt;% t() %&gt;% as.data.frame() %&gt;% rowwise() %&gt;% mutate(slope = calculate_slope(c_across(everything()))) %&gt;% select(slope) }) %&gt;% t() %&gt;% as.data.frame() %&gt;% set_names(colnames(community_domains[[1]])[-1]) %&gt;% rownames_to_column(var=&quot;iteration&quot;) %&gt;% pivot_longer(!iteration, names_to=&quot;trait&quot;,values_to=&quot;value&quot;) %&gt;% group_by(trait) %&gt;% summarise(mean=mean(value), p1 = quantile(value, probs = 0.1), p9 = quantile(value, probs = 0.9), positive_support = sum(value &gt; 0)/1000, negative_support = sum(value &lt; 0)/1000) %&gt;% arrange(-positive_support) 9.6.3.1 Positive associated functions at element level (there isn’t) #domain_predictions %&gt;% #filter(mean &gt;0) %&gt;% #arrange(-positive_support) %&gt;% #filter(positive_support&gt;=0.9) %&gt;% #paged_table() 9.6.3.2 Negative associated functions at element level (there isn’t) #domain_predictions %&gt;% #filter(mean &lt;0) %&gt;% #arrange(-negative_support) %&gt;% #filter(negative_support&gt;=0.9) %&gt;% #paged_table() all_domains &lt;- domain_predictions %&gt;% left_join(GIFT_db,by=join_by(trait==Code_function)) %&gt;% mutate(trait=factor(trait)) %&gt;% mutate(function_legend=str_c(trait,&quot; - &quot;,Function)) %&gt;% select(trait,mean,p1,p9) %&gt;% unique() all_domains %&gt;% ggplot(aes(x=mean, y=fct_reorder(trait, mean), xmin=p1, xmax=p9, color=trait)) + geom_point() + geom_errorbar() + xlim(c(-0.02,0.03)) + geom_vline(xintercept=0) + theme_minimal() + labs(x=&quot;Regression coefficient&quot;,y=&quot;Domain level&quot;) + guides(col = guide_legend(ncol = 1)) community_domains %&gt;% bind_rows() %&gt;% pivot_longer(-elevation, names_to = &quot;trait&quot;, values_to = &quot;value&quot;) %&gt;% filter(trait %in% domain_predictions$trait) %&gt;% mutate(trait=factor(trait, levels=domain_predictions$trait)) %&gt;% mutate(elevation=as.numeric(elevation)) %&gt;% ggplot(aes(x=elevation, y=value)) + geom_smooth(method = lm, formula = y ~ x, se = TRUE) + #geom_smooth(method = lm, formula = y ~ splines::bs(x, 3), se = TRUE) + facet_wrap(~trait, ncol=5, scales=&quot;free&quot;) + theme_minimal() + labs(x=&quot;Elevation&quot;,y=&quot;Metabolic Capacity Index&quot;) 9.6.3.3 GIFT test visualization # Aggregate function-level GIFTs into overall Biosynthesis, Degradation and Structural GIFTs GIFTs_domains &lt;- to.domains(GIFTs_functions, GIFT_db) domains &lt;- GIFTs_domains %&gt;% as.data.frame() # Get community-weighed average GIFTs per sample GIFTs_domains_community &lt;- to.community(GIFTs_domains, genome_counts_filt_filt %&gt;% column_to_rownames(., &quot;genome&quot;) %&gt;% tss(), GIFT_db) GIFTs_domains_community %&gt;% as.data.frame() %&gt;% rownames_to_column(var=&quot;sample&quot;) %&gt;% pivot_longer(!sample,names_to=&quot;trait&quot;,values_to=&quot;gift&quot;) %&gt;% left_join(sample_metadata, by = join_by(sample == EHI_number)) %&gt;% ggplot(aes(x=trait,y=sample,fill=gift)) + geom_tile(colour=&quot;white&quot;, size=0.2)+ scale_fill_gradientn(colours=rev(c(&quot;#d53e4f&quot;, &quot;#f46d43&quot;, &quot;#fdae61&quot;, &quot;#fee08b&quot;, &quot;#e6f598&quot;, &quot;#abdda4&quot;, &quot;#ddf1da&quot;)))+ facet_grid(Elevation ~ ., scales=&quot;free&quot;,space=&quot;free&quot;) "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
